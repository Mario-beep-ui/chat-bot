<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUPER MAR-IA | Asistente Avanzado</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            font-size: 62.5%;
            --color-fondo: #120A1F;
            --color-contenedor: #1A1128;
            --color-texto: #E8E6F0;
            --fondo-burbuja-usuario: linear-gradient(135deg, #9D4EDD, #7B2CBF);
            --texto-burbuja-usuario: #ffffff;
            --fondo-burbuja-bot: #2D233E;
            --texto-burbuja-bot: #E8E6F0;
            --borde-burbuja-bot: #4A3B69;
            --fondo-entrada: #1A1128;
            --borde-superior-entrada: #4A3B69;
            --fondo-campo-entrada: #241A35;
            --texto-entrada: #ffffff;
            --texto-placeholder: #9CA3AF;
            --fondo-boton-enviar: #9D4EDD;
            --texto-boton-enviar: white;
            --fondo-boton-accion: #2D233E;
            --texto-boton-accion: #E8E6F0;
            --fondo-boton-grabando: #EF4444;
            --color-timestamp: #B8B0D0;
            --fondo-boton-control: #2D233E;
            --fondo-adjunto: #2D233E;
            --borde-adjunto: #4A3B69;
            --fondo-codigo: #160B2E;
            --borde-codigo: #4A3B69;
            --fondo-boton-buscar-activo: #10B981;
            --fondo-pensamiento: #251838;
            --borde-pensamiento: #4A3B69;
            --fondo-pensamiento-hover: #2E1F45;
            --color-destacado: #C77DFF;
            --resaltado-pensamiento: rgba(157, 78, 221, 0.1);
            --fondo-modal-imagen: rgba(18, 10, 31, 0.95);
            --color-mini: #ff9800;
            --fondo-generando-imagen: #9D4EDD;
            --sombra: 0 10px 20px rgba(0,0,0,0.4), 0 6px 6px rgba(0,0,0,0.3);
        }
        body.tema-claro {
            --color-fondo: #f4f7f9;
            --color-contenedor: #ffffff;
            --color-texto: #333333;
            --fondo-burbuja-usuario: #7f5af0;
            --fondo-burbuja-bot: #eef2f7;
            --texto-burbuja-bot: #333333;
            --borde-burbuja-bot: #d1d9e6;
            --fondo-entrada: #ffffff;
            --borde-superior-entrada: #e0e0e0;
            --fondo-campo-entrada: #f0f4f8;
            --texto-entrada: #333333;
            --texto-placeholder: #666666;
            --fondo-boton-accion: #eef2f7;
            --texto-boton-accion: #333333;
            --fondo-boton-grabando: #D32F2F;
            --color-timestamp: #666666;
            --fondo-boton-control: #f0f4f8;
            --fondo-adjunto: #f0f4f8;
            --borde-adjunto: #d1d9e6;
            --fondo-codigo: rgba(0,0,0,0.05);
            --borde-codigo: rgba(0,0,0,0.1);
            --fondo-pensamiento: #e8eaf6;
            --borde-pensamiento: #c5cae9;
            --fondo-pensamiento-hover: #e0e2f1;
            --color-destacado: #5e17eb;
            --resaltado-pensamiento: rgba(94, 23, 235, 0.08);
            --fondo-modal-imagen: rgba(255,255,255,0.98);
            --color-mini: #ff6f00;
            --fondo-generando-imagen: #5e17eb;
            --sombra: 0 10px 20px rgba(0,0,0,0.1), 0 6px 6px rgba(0,0,0,0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        html { height: 100%; }
        body { height: 100dvh; background: var(--color-fondo); color: var(--color-texto); font-size: 1.6rem; display: flex; flex-direction: column; overflow: hidden; }
        .contenedor { display: flex; flex-direction: column; width: 100%; background: var(--color-contenedor); flex: 1; min-height: 0; overflow: hidden; position: relative; }
        .cabecera { flex-shrink: 0; padding: 1.5rem 2rem; display: flex; align-items: center; justify-content: space-between; z-index: 10; background: var(--color-contenedor); border-bottom: 1px solid var(--borde-superior-entrada); box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .cabecera .titulo { display: flex; align-items: center; gap: 1.2rem; }
        .cabecera .titulo .fa-robot { font-size: 3rem; color: var(--color-destacado); animation: float 3s ease-in-out infinite; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-4px); } 100% { transform: translateY(0px); } }
        .cabecera .titulo h1 { font-size: 2.2rem; font-weight: 700; margin: 0; cursor: pointer; transition: all 0.3s; position: relative; color: var(--color-destacado); }
        .contenedor-chat { flex-grow: 1; overflow-y: auto; padding: 2rem; display: flex; flex-direction: column; gap: 2.5rem; scroll-behavior: smooth; transition: transform 0.3s ease-in-out; }
        .contenedor-chat.desplazado { transform: translateX(320px); }
        .contenedor-entrada-wrapper { flex-shrink: 0; padding: 1.5rem 2rem; background: transparent; z-index: 10; }
        .super-ia-gradient { background: linear-gradient(90deg, #9D4EDD, #ff8c42, #87CEEB); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; -webkit-text-fill-color: transparent; animation: gradient-animation 5s ease-infinite; background-size: 200% 200%; }
        .mini-ia-gradient { background: linear-gradient(90deg, #ff9800, #ffeb3b, #ff9800); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; -webkit-text-fill-color: transparent; animation: gradient-animation 3s ease-infinite; background-size: 200% 200%; }
        @keyframes gradient-animation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .cabecera .subtitle { font-size: 1.3rem; opacity: 0.8; color: #aaa; margin-top: 0.2rem; }
        .controles-cabecera { display: flex; align-items: center; gap: 1rem; }
        .boton-control { background: var(--fondo-boton-control); border: 1px solid var(--borde-superior-entrada); font-size: 1.8rem; cursor: pointer; color: var(--color-texto); width: 4.2rem; height: 4.2rem; border-radius: 50%; display: flex; justify-content: center; align-items: center; transition: all 0.2s; }
        .boton-control:hover { background: var(--color-destacado); color: white; border-color: var(--color-destacado); transform: translateY(-2px); }
        .mensaje { display: flex; flex-direction: column; max-width: 85%; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(1.5rem); } to { opacity: 1; transform: translateY(0); } }
        .mensaje-usuario { align-self: flex-end; align-items: flex-end; }
        .mensaje-bot { align-self: flex-start; align-items: flex-start; }
        .burbuja-mensaje { padding: 1.5rem 2rem; border-radius: 2.2rem; line-height: 1.7; word-wrap: break-word; max-width: 100%; height: auto; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .burbuja-usuario { background: var(--fondo-burbuja-usuario); color: var(--texto-burbuja-usuario); border-bottom-right-radius: 0.6rem; }
        .burbuja-bot { background: var(--fondo-burbuja-bot); color: var(--texto-burbuja-bot); border: 1px solid var(--borde-burbuja-bot); border-bottom-left-radius: 0.6rem; }
        .mensaje-fuente { align-self: flex-start; margin-bottom: -1.5rem; margin-left: 1rem; font-size: 1.3rem; color: var(--color-timestamp); display: flex; align-items: center; gap: 0.8rem; animation: fadeIn 0.4s ease-out; }
        .mensaje-busqueda { align-self: flex-start; animation: fadeIn 0.4s ease-out; }
        .burbuja-busqueda { display: flex; align-items: center; gap: 1.2rem; padding: 1.5rem 2rem; background: var(--fondo-burbuja-bot); color: var(--texto-burbuja-bot); border: 1px solid var(--borde-burbuja-bot); border-radius: 2.2rem; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .burbuja-busqueda .fa-search { animation: pulse-search 1.5s infinite; }
        @keyframes pulse-search { 0% { transform: scale(1); color: var(--color-destacado); } 50% { transform: scale(1.2); color: white; } 100% { transform: scale(1); color: var(--color-destacado); } }
        .pensamiento-container { background: var(--fondo-pensamiento); border: 1px solid var(--borde-pensamiento); border-radius: 1.6rem; animation: slideIn 0.4s ease-out; overflow: hidden; width: 100%; box-shadow: var(--sombra); border-bottom-left-radius: 0.6rem; border-bottom-right-radius: 0.6rem; }
        .burbuja-bot.respuesta-adjunta { margin-top: -1px; border-top-left-radius: 0; border-top-right-radius: 0; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .pensamiento-cabecera-clickable { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 2rem; cursor: pointer; transition: background-color 0.2s; }
        .pensamiento-cabecera-clickable:hover { background-color: var(--fondo-pensamiento-hover); }
        .pensamiento-titulo { font-weight: 600; color: var(--color-texto); display: flex; align-items: center; gap: 1rem; font-size: 1.6rem; }
        .pensamiento-titulo i { color: #C77DFF; } 
        .pensamiento-controles-cabecera { display: flex; align-items: center; gap: 1.5rem; }
        .tiempo-pensamiento { font-size: 1.2rem; color: var(--color-timestamp); }
        .toggle-icon { font-size: 2rem; color: var(--color-timestamp); transition: transform 0.3s ease; }
        .toggle-icon.collapsed { transform: rotate(-180deg); }
        .pensamiento-contenido-wrapper { overflow: hidden; transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out; max-height: 2000px; }
        .pensamiento-contenido-wrapper.collapsed { max-height: 0; padding-top: 0; padding-bottom: 0; border-top: none; }
        .contenido-pensamiento { font-size: 1.4rem; line-height: 1.7; padding: 2rem; border-top: 1px solid var(--borde-pensamiento); background: var(--resaltado-pensamiento); overflow-y: auto; }
        .pensamiento-acciones { display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: flex-end; padding: 0 2rem 2rem; }
        .boton-pensamiento { background: rgba(255,255,255,0.08); border: 1px solid var(--borde-pensamiento); border-radius: 1rem; padding: 0.8rem 1.2rem; color: var(--color-texto); cursor: pointer; display: flex; align-items: center; gap: 0.8rem; transition: all 0.2s; font-size: 1.3rem; }
        .boton-pensamiento:hover { background: rgba(255,255,255,0.15); border-color: var(--color-destacado); }
        .bloque-codigo { position: relative; background: var(--fondo-codigo); border: 1px solid var(--borde-codigo); border-radius: 1.2rem; overflow: hidden; margin: 1.5rem 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .cabecera-codigo { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; background: rgba(0,0,0,0.3); border-bottom: 1px solid var(--borde-codigo); }
        .lenguaje-codigo { font-size: 1.4rem; font-weight: 500; color: #ccc; }
        .boton-copiar-codigo { background: transparent; border: none; color: var(--color-texto); cursor: pointer; display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem 1rem; border-radius: 0.6rem; font-size: 1.3rem; transition: all 0.2s; }
        .boton-copiar-codigo:hover { background: rgba(255,255,255,0.1); }
        .boton-copiar-codigo.copiado { color: #4CAF50; }
        .contenedor-codigo { overflow-x: auto; max-width: 100%; }
        .contenedor-codigo pre { margin: 0; padding: 1.8rem; font-family: 'Fira Code', 'Courier New', monospace; font-size: 1.4rem; }
        .timestamp-container { display: flex; align-items: center; gap: 1rem; margin-top: 1rem; }
        .timestamp { font-size: 1.2rem; color: var(--color-timestamp); }
        .boton-accion-mensaje { background: none; border: none; width: 3.2rem; height: 3.2rem; border-radius: 50%; cursor: pointer; font-size: 1.5rem; display: flex; justify-content: center; align-items: center; color: var(--color-timestamp); transition: all 0.2s; }
        .boton-accion-mensaje:hover { background: rgba(255,255,255,0.1); color: var(--color-destacado); }
        .contenedor-entrada { display: flex; flex-direction: column; gap: 1.5rem; width: 100%; background-color: var(--fondo-campo-entrada); border: 2px solid transparent; border-radius: 2.8rem; padding: 1.5rem 2rem; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .contenedor-entrada:focus-within { border-color: var(--color-destacado); box-shadow: 0 0 0 3px rgba(157, 78, 221, 0.3); }
        .contenedor-adjuntos { display: none; overflow-x: auto; overflow-y: hidden; white-space: nowrap; padding-bottom: 1rem; scrollbar-width: thin; border-bottom: 1px solid var(--borde-adjunto); margin-bottom: 0.5rem;}
        .adjunto-item { display: inline-flex; align-items: center; gap: 1rem; background: var(--fondo-adjunto); border: 1px solid var(--borde-adjunto); border-radius: 1.5rem; padding: 1rem 1.5rem; max-width: 25rem; margin-right: 1.2rem; }
        .icono-adjunto { font-size: 2.2rem; color: var(--color-destacado); }
        .detalles-adjunto { display: flex; flex-direction: column; min-width: 0; }
        .nombre-adjunto { font-size: 1.4rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tamano-adjunto { font-size: 1.2rem; color: var(--color-timestamp); }
        .boton-eliminar { background: transparent; border: none; border-radius: 50%; width: 2.8rem; height: 2.8rem; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #aaa; transition: all 0.2s; }
        .boton-eliminar:hover { color: #E53935; background: rgba(255, 0, 0, 0.1); }
        #entrada-usuario { width: 100%; border: none; background: transparent; color: var(--texto-entrada); font-size: 1.7rem; outline: none; resize: none; max-height: 20rem; overflow-y: auto; padding: 0.5rem 0; scrollbar-width: thin; scrollbar-color: var(--color-destacado) transparent; }
        #entrada-usuario::-webkit-scrollbar { width: 6px; }
        #entrada-usuario::-webkit-scrollbar-thumb { background-color: var(--color-destacado); border-radius: 3px; }
        #entrada-usuario::-webkit-scrollbar-track { background: transparent; }
        .input-area-botones { display: flex; align-items: center; justify-content: space-around; width: 100%; }
        .boton-input { background: var(--fondo-boton-accion); color: var(--texto-boton-accion); border: none; width: 4.8rem; height: 4.8rem; border-radius: 50%; cursor: pointer; font-size: 2rem; display: flex; justify-content: center; align-items: center; transition: all 0.2s ease-out; flex-shrink: 0; }
        .boton-input:hover { transform: scale(1.1) rotate(10deg); background-color: var(--color-destacado); color: white; }
        #boton-enviar { background: var(--fondo-boton-enviar); color: var(--texto-boton-enviar); }
        #boton-enviar.pausa { background: #ff9800; animation: pulsate 1.5s infinite; }
        #boton-grabar.grabando { background: var(--fondo-boton-grabando); animation: pulsate 1.5s infinite; box-shadow: 0 0 0 4px rgba(229, 57, 53, 0.4); }
        .boton-input.modo-activo { background: var(--fondo-boton-buscar-activo) !important; color: white !important; animation: none !important; }
        @keyframes pulsate { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(157, 78, 221, 0.5); } 70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(157, 78, 221, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(157, 78, 221, 0); } }
        .indicador-escribiendo { display: flex; align-items: center; gap: 1rem; padding: 1.5rem 2rem; background: var(--fondo-burbuja-bot); border-radius: 2.2rem; width: fit-content; align-self: flex-start; animation: fadeIn 0.3s ease; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .indicador-escribiendo .puntos span { height: 0.8rem; width: 0.8rem; background: var(--color-timestamp); border-radius: 50%; display: inline-block; margin: 0 0.2rem; animation: bounce 1.3s infinite; }
        .indicador-escribiendo .puntos span:nth-child(2) { animation-delay: 0.2s; }
        .indicador-escribiendo .puntos span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-0.6rem); } }
        .fa-beat { animation: fa-beat 1.5s ease-in-out infinite; }
        @keyframes fa-beat { 0%, 100% { transform: scale(1); opacity: 0.7; } 50% { transform: scale(1.15); opacity: 1; } }
        .modal-ocr, .modal-modo, .modal-menu-principal { position: fixed; bottom: 12rem; right: 2rem; background: var(--fondo-entrada); border-radius: 1.8rem; box-shadow: var(--sombra); padding: 1.5rem; display: none; flex-direction: column; gap: 1rem; z-index: 2000; border: 1px solid var(--borde-superior-entrada); width: 30rem; animation: fadeIn-up 0.3s ease-out; }
        .modal-modo { top: 7.5rem; left: 50%; transform: translateX(-50%); bottom: auto; right: auto; }
        .modal-menu-principal { top: 7.5rem; right: 2rem; bottom: auto; }
        @keyframes fadeIn-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .opcion-ocr, .opcion-menu { background: var(--fondo-campo-entrada); color: var(--texto-entrada); border: none; border-radius: 1.2rem; padding: 1.5rem; display: flex; align-items: center; gap: 1.5rem; cursor: pointer; transition: all 0.2s; font-weight: 500; }
        .opcion-ocr:hover, .opcion-menu:hover { background: var(--color-destacado); color: white; transform: translateX(5px); }
        .opcion-ocr i, .opcion-menu i { font-size: 2rem; }
        #selector-voz { background: transparent; border: none; color: var(--texto-entrada); font-size: 1.5rem; flex-grow: 1; cursor: pointer; }
        #selector-voz:focus { outline: none; }
        body.tema-claro #selector-voz { color: var(--texto-entrada); }
        .opcion-modo { flex-direction: column; align-items: flex-start; }
        .opcion-modo-titulo { font-weight: 600; font-size: 1.6rem; display: flex; align-items: center; gap: 1rem; }
        .opcion-modo-desc { font-size: 1.3rem; opacity: 0.9; line-height: 1.5; }
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 1500; display: none; animation: fade-in-overlay 0.3s; }
        @keyframes fade-in-overlay { from { opacity: 0; } to { opacity: 1; } }
        .copy-confirmation { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%); background-color: #2dce89; color: white; padding: 1.2rem 2.5rem; border-radius: 2rem; font-size: 1.5rem; font-weight: 500; opacity: 0; transition: opacity 0.3s, transform 0.3s; z-index: 1000; pointer-events: none; box-shadow: var(--sombra); }
        .copy-confirmation.show { opacity: 1; transform: translate(-50%, -10px); }
        input[type="file"] { display: none; }
        .modal-super-ia, .modal-ayuda { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--color-contenedor); color: var(--color-texto); border-radius: 2rem; padding: 3rem; display: none; flex-direction: column; z-index: 2000; width: 90%; max-width: 600px; box-shadow: var(--sombra); border: 1px solid var(--borde-superior-entrada); animation: fadeInDown 0.5s ease-out; }
        @keyframes fadeInDown { from { opacity: 0; transform: translate(-50%, -55%); } to { opacity: 1; transform: translate(-50%, -50%); } }
        .modal-super-ia-contenido, .modal-ayuda-contenido { position: relative; }
        .cerrar-modal-super-ia, .cerrar-modal-ayuda { position: absolute; top: -1.5rem; right: -1.5rem; background: var(--fondo-boton-control); border: none; width: 3.5rem; height: 3.5rem; border-radius: 50%; font-size: 2rem; color: var(--color-texto); cursor: pointer; display: flex; justify-content: center; align-items: center; transition: all 0.3s; }
        .cerrar-modal-super-ia:hover, .cerrar-modal-ayuda:hover { background: var(--color-destacado); color: white; transform: scale(1.1) rotate(90deg); }
        .modal-super-ia h3, .modal-ayuda h3 { margin-top: 0; font-size: 2.4rem; margin-bottom: 2rem; text-align: center; color: var(--color-destacado); font-weight: 700; }
        .modal-super-ia p { font-size: 1.6rem; line-height: 1.6; margin: 0 0 2rem 0; text-align: center; }
        .comparacion-modos { display: flex; gap: 2rem; margin-top: 2rem; }
        .modo-card { flex: 1; background: var(--fondo-pensamiento); border-radius: 1.5rem; padding: 2rem; text-align: center; border: 1px solid var(--borde-pensamiento); }
        .modo-card h4 { margin-top: 0; font-size: 1.8rem; margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: center; gap: 1rem; color: var(--color-destacado); }
        .modo-card ul { text-align: left; padding-left: 1.8rem; margin-bottom: 0; }
        .modo-card li { margin-bottom: 1rem; font-size: 1.4rem; }
        .modo-card.super { border-color: #FFD700; position: relative; overflow: hidden; }
        .modo-card.super::after { content: 'RECOMENDADO'; position: absolute; top: 1rem; right: -3rem; background: #FFD700; color: #000; font-weight: bold; font-size: 1.1rem; padding: 0.5rem 3rem; transform: rotate(45deg); }
        .boton-entendido, .boton-ayuda { background: var(--fondo-boton-enviar); border: none; color: white; border-radius: 3rem; padding: 1.2rem 2.5rem; font-size: 1.6rem; font-weight: bold; cursor: pointer; transition: all 0.3s; margin-top: 2rem; width: 100%; }
        .boton-entendido:hover, .boton-ayuda:hover { filter: brightness(1.1); transform: translateY(-3px); box-shadow: 0 6px 12px rgba(127, 90, 240, 0.3); }
        .modal-ayuda { max-height: 80vh; overflow-y: auto; }
        .seccion-ayuda { margin-bottom: 2.5rem; }
        .seccion-ayuda h4 { font-size: 2rem; margin-bottom: 1.5rem; color: var(--color-destacado); display: flex; align-items: center; gap: 1rem; border-bottom: 2px solid var(--color-destacado); padding-bottom: 0.5rem; }
        .item-ayuda { display: flex; align-items: flex-start; gap: 1.5rem; margin-bottom: 2rem; }
        .item-ayuda .icono-ayuda { flex-shrink: 0; background: var(--fondo-boton-enviar); width: 4rem; height: 4rem; border-radius: 1.2rem; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: white; }
        .item-ayuda .contenido-ayuda { flex: 1; }
        .item-ayuda .titulo-item { font-weight: bold; margin-bottom: 0.5rem; font-size: 1.7rem; }
        .item-ayuda .descripcion-item { font-size: 1.5rem; line-height: 1.6; }
        .modal-imagen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--fondo-modal-imagen); display: flex; justify-content: center; align-items: center; z-index: 3000; display: none; backdrop-filter: blur(10px); }
        .contenido-modal-imagen { position: relative; max-width: 90%; max-height: 90%; display: flex; justify-content: center; align-items: center; }
        .modal-imagen img { max-width: 100%; max-height: 90vh; object-fit: contain; border-radius: 1.5rem; box-shadow: 0 20px 40px rgba(0,0,0,0.5); }
        .botones-modal-imagen { position: absolute; top: 2rem; right: 2rem; display: flex; gap: 1.5rem; }
        .boton-modal-imagen { background: rgba(255,255,255,0.15); border: none; width: 5rem; height: 5rem; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: all 0.3s; color: white; font-size: 2.4rem; backdrop-filter: blur(5px); }
        .boton-modal-imagen:hover { background: var(--color-destacado); transform: scale(1.1); }
        .boton-generar-imagen { background: var(--fondo-boton-accion) ; color: white; border: none; border-radius: 50%; width: 4.8rem; height: 4.8rem; cursor: pointer; font-size: 2rem; display: flex; justify-content: center; align-items: center; transition: all 0.2s; flex-shrink: 0; }
        .boton-generar-imagen:hover { transform: scale(1.1) rotate(10deg); background: #6d1dc4; }
        .boton-generar-imagen.modo-activo { background: var(--fondo-boton-enviar); animation: none !important; }
        .indicador-generando-imagen { display: flex; align-items: center; gap: 1rem; padding: 1rem 1.5rem; background: var(--fondo-generando-imagen); color: white; border-radius: 1.8rem; width: fit-content; align-self: flex-start; animation: fadeIn 0.3s ease; }
        .loader { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .modal-mini-aviso { position: fixed; top: 1.5rem; left: 50%; transform: translateX(-50%); background-color: #FFC107; color: #000; padding: 1.2rem 2rem; border-radius: 1.2rem; z-index: 5000; display: none; align-items: center; gap: 1rem; font-size: 1.5rem; font-weight: 500; box-shadow: var(--sombra); animation: slideDownFadeIn 0.5s ease-out forwards; }
        @keyframes slideDownFadeIn { from { opacity: 0; transform: translate(-50%, -100%); } to { opacity: 1; transform: translate(-50%, 0); } }
        @keyframes slideUpFadeOut { from { opacity: 1; transform: translate(-50%, 0); } to { opacity: 0; transform: translate(-50%, -100%); } }
        #boton-enviar.cargando .fa-paper-plane { display: none; }
        #boton-enviar.cargando { background: var(--fondo-boton-enviar); }
        .loader-dots { width: 2.4rem; height: 2.4rem; position: relative; }
        .loader-dots span { position: absolute; width: 0.7rem; height: 0.7rem; background-color: white; border-radius: 50%; animation: loader-anim 1.2s infinite; }
        .loader-dots span:nth-child(1) { top: 0; left: 50%; transform: translateX(-50%); animation-delay: -1.05s; }
        .loader-dots span:nth-child(2) { top: 15%; right: 15%; animation-delay: -0.9s; }
        .loader-dots span:nth-child(3) { top: 50%; right: 0; transform: translateY(-50%); animation-delay: -0.75s; }
        .loader-dots span:nth-child(4) { bottom: 15%; right: 15%; animation-delay: -0.6s; }
        .loader-dots span:nth-child(5) { bottom: 0; left: 50%; transform: translateX(-50%); animation-delay: -0.45s; }
        .loader-dots span:nth-child(6) { bottom: 15%; left: 15%; animation-delay: -0.3s; }
        .loader-dots span:nth-child(7) { top: 50%; left: 0; transform: translateY(-50%); animation-delay: -0.15s; }
        .loader-dots span:nth-child(8) { top: 15%; left: 15%; animation-delay: 0s; }
        @keyframes loader-anim { 0%, 100% { transform: scale(0.2); opacity: 0.5; } 40% { transform: scale(1); opacity: 1; } }
        .panel-historial { position: fixed; top: 0; left: 0; width: 320px; height: 100vh; background: var(--color-contenedor); z-index: 2000; overflow-y: auto; transform: translateX(-100%); transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); box-shadow: 5px 0 25px rgba(0,0,0,0.3); border-right: 1px solid var(--borde-superior-entrada); }
        .panel-historial.abierto { transform: translateX(0); }
        .cabecera-panel-historial { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 2rem; border-bottom: 1px solid var(--borde-superior-entrada); position: sticky; top: 0; background: var(--color-contenedor); z-index: 10; }
        .cabecera-panel-historial h2 { margin: 0; font-size: 2rem; color: var(--color-destacado); }
        .boton-cerrar-historial { background: transparent; border: none; color: var(--color-texto); font-size: 2.2rem; cursor: pointer; transition: all 0.2s; border-radius: 50%; width: 4rem; height: 4rem; display: flex; align-items: center; justify-content: center; }
        .boton-cerrar-historial:hover { background: var(--fondo-pensamiento); color: var(--color-destacado); transform: rotate(90deg); }
        .buscar-historial { padding: 1.5rem 2rem; border-bottom: 1px solid var(--borde-superior-entrada); }
        .input-buscar-historial { width: 100%; padding: 1.2rem 1.8rem; background: var(--fondo-campo-entrada); border: 1px solid var(--borde-adjunto); border-radius: 2.4rem; color: var(--texto-entrada); font-size: 1.5rem; }
        .input-buscar-historial::placeholder { color: var(--texto-placeholder); }
        .lista-historial { padding: 1rem 0; }
        .item-historial { padding: 1.5rem 2rem; border-bottom: 1px solid var(--borde-superior-entrada); cursor: pointer; transition: background 0.2s; display: flex; flex-direction: column; }
        .item-historial:hover { background: var(--fondo-pensamiento); }
        .item-historial.seleccionado { background: var(--resaltado-pensamiento); border-left: 4px solid var(--color-destacado); }
        .titulo-conversacion { font-weight: 600; margin-bottom: 0.5rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 1.6rem; }
        .fecha-conversacion { font-size: 1.2rem; color: var(--color-timestamp); }
        .preview-conversacion { font-size: 1.4rem; margin-top: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--color-timestamp); }
        .acciones-item-historial { display: flex; justify-content: flex-end; margin-top: 1rem; gap: 1rem; }
        .boton-accion-item { background: transparent; border: none; color: var(--color-timestamp); font-size: 1.6rem; cursor: pointer; transition: all 0.2s; padding: 0.8rem; border-radius: 50%; width: 3.6rem; height: 3.6rem; }
        .boton-accion-item:hover { color: var(--color-destacado); background: rgba(127, 90, 240, 0.1); }
        .boton-nueva-conversacion { display: block; width: calc(100% - 40px); margin: 1.5rem 2rem; padding: 1.5rem; background: var(--fondo-boton-enviar); color: white; border: none; border-radius: 3rem; font-weight: 600; font-size: 1.6rem; cursor: pointer; text-align: center; transition: all 0.3s; }
        .boton-nueva-conversacion:hover { filter: brightness(1.1); transform: translateY(-3px); box-shadow: 0 6px 12px rgba(127, 90, 240, 0.3); }
        .sin-conversaciones { text-align: center; padding: 3rem 2rem; color: var(--color-timestamp); font-style: italic; }
        .boton-menu-historial { position: relative; }
        .contador-historial { position: absolute; top: -5px; right: -5px; background: var(--fondo-boton-grabando); color: white; font-size: 1.1rem; font-weight: 600; width: 2rem; height: 2rem; border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 2px solid var(--color-contenedor); }
        .overlay-historial { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 1500; display: none; animation: fade-in-overlay 0.3s; }
        #boton-scroll-final { position: absolute; bottom: 12rem; right: 2rem; width: 4.5rem; height: 4.5rem; background: var(--fondo-boton-accion); color: var(--texto-boton-accion); border: 1px solid var(--borde-adjunto); border-radius: 50%; display: none; align-items: center; justify-content: center; cursor: pointer; z-index: 100; box-shadow: var(--sombra); transition: opacity 0.3s, transform 0.3s; }
        #boton-scroll-final:hover { background: var(--color-destacado); color: white; transform: scale(1.1); }
        #boton-scroll-final.visible { display: flex; }
        #live-conversation-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100dvh; background: radial-gradient(circle, #2D233E 0%, #120A1F 100%); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.5s ease; color: white; }
        #live-conversation-screen.visible { display: flex; opacity: 1; }
        .robot-container { position: relative; width: 300px; height: 300px; }
        #robot-svg { width: 100%; height: 100%; }
        .robot-eye { animation: blink 4s infinite ease-in-out; transform-origin: center; }
        @keyframes blink { 0%, 95%, 100% { transform: scaleY(1); } 97.5% { transform: scaleY(0.05); } }
        .robot-mouth { transition: d 0.2s ease-in-out; }
        #robot-svg.talking .robot-mouth { animation: talk 0.4s infinite ease-in-out; }
        @keyframes talk { 0%, 100% { d: path('M 120 200 Q 150 210 180 200'); } 50% { d: path('M 125 205 Q 150 230 175 205'); } }
        .listening-indicator { position: absolute; top: 50%; left: 50%; width: 100%; height: 100%; transform: translate(-50%, -50%); border: 3px solid rgba(127, 90, 240, 0); border-radius: 50%; animation: listen-pulse 2s infinite; display: none; }
        #robot-svg.listening .listening-indicator { display: block; }
        @keyframes listen-pulse { 0% { transform: translate(-50%, -50%) scale(0.8); border-color: rgba(127, 90, 240, 0.7); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1.5); border-color: rgba(127, 90, 240, 0); opacity: 0; } }
        .live-status { margin-top: 2rem; font-size: 2rem; font-weight: 500; min-height: 3rem; text-align: center; padding: 0 2rem; color: #ccc; }
        .live-controls { position: absolute; bottom: 5%; display: flex; gap: 2rem; }
        .live-control-btn { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; width: 7rem; height: 7rem; border-radius: 50%; font-size: 3rem; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: all 0.3s; backdrop-filter: blur(5px); }
        .live-control-btn:hover { background: var(--color-destacado); transform: scale(1.1); }
        #close-live-btn { background: #e53935; }
        #close-live-btn:hover { background: #c62828; }
        @media (max-width: 768px) { .panel-historial { width: 90%; } .contenedor-chat.desplazado { transform: translateX(90%); } .modal-menu-principal { width: calc(100% - 4rem); left: 2rem; right: 2rem; } }
        .live-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 3000; }
        .live-modal.oculto { display: none; }
        .live-modal-contenido { background: #fff; color: #333; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
        .cerrar-modal { position: absolute; top: 15px; right: 20px; font-size: 2rem; cursor: pointer; color: #fff; }

        /* ESTILOS NUEVOS PARA RESPUESTA IA (MODO TEXTO PLANO) */
        .respuesta-ia {
            padding: 0.5rem 1rem;
            width: 100%;
            color: var(--color-texto);
            background: transparent;
            border: none;
            box-shadow: none;
            line-height: 1.7;
            font-size: 1.6rem;
            border-radius: 0;
        }
        
        /* ---------------------------------------------------- */
        /* ESTILOS TABLAS TIPO GEMINI (MODERNAS & CLEAN)      */
        /* ---------------------------------------------------- */
        .chat-table-wrapper {
            width: 100%;
            overflow-x: auto;
            margin: 1.5rem 0;
            border: 1px solid var(--borde-codigo);
            border-radius: 1.2rem;
            background: transparent; /* Fondo transparente como código */
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .chat-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 1.4rem;
            color: var(--color-texto);
            min-width: 400px; /* Forzar scroll en pantallas pequeñas */
        }

        .chat-table th {
            background-color: var(--fondo-boton-accion); /* Header ligeramente más claro/distinto */
            color: var(--color-destacado); /* Acento de color en encabezados */
            font-weight: 600;
            text-align: left;
            padding: 1.2rem 1.5rem;
            border-bottom: 2px solid var(--borde-codigo);
            white-space: nowrap; /* Evitar saltos de línea feos en cabecera */
        }

        .chat-table td {
            padding: 1.2rem 1.5rem;
            border-bottom: 1px solid var(--borde-codigo);
            vertical-align: top;
            line-height: 1.6;
        }

        .chat-table tr:last-child td {
            border-bottom: none; /* Eliminar borde final */
        }

        .chat-table tr:hover td {
            background-color: rgba(157, 78, 221, 0.05); /* Hover sutil morado */
        }

        /* Estilo sutil de scrollbar para las tablas */
        .chat-table-wrapper::-webkit-scrollbar {
            height: 8px;
        }
        .chat-table-wrapper::-webkit-scrollbar-thumb {
            background-color: var(--borde-codigo);
            border-radius: 4px;
        }
        .chat-table-wrapper::-webkit-scrollbar-track {
            background: transparent;
        }

        .respuesta-ia pre {
            background: var(--fondo-codigo);
            padding: 1rem;
            border-radius: 0.6rem;
            overflow-x: auto;
            border: 1px solid var(--borde-codigo);
        }
        
        .mensaje-bot,
.mensaje.mensaje-bot {
  align-self: stretch;
  width: 100%;
  max-width: 100%;
}

.mensaje-bot .respuesta-ia,
.mensaje-bot .contenido,
.mensaje-bot .mensaje-contenido {
  display: block;
  width: 100%;
  max-width: 100%;
  margin-left: 0;
  margin-right: 0;
}

.mensaje-bot .burbuja-mensaje,
.mensaje-bot .burbuja-bot {
  background: transparent;
  box-shadow: none;
  border: none;
  max-width: 100%;
  width: 100%;
  padding-left: 0.5rem;
  padding-right: 0.5rem;
}

.mensaje-usuario .burbuja-mensaje,
.mensaje-usuario .burbuja-usuario {
  max-width: 78%;
}

.mensaje-bot pre,
.mensaje-bot table,
.mensaje-bot .bloque-codigo,
.mensaje-bot .table-wrapper {
  width: 100%;
  max-width: 100%;
  box-sizing: border-box;
}

@media (max-width: 768px) {
  .mensaje-bot .respuesta-ia,
  .mensaje-bot .burbuja-mensaje {
    padding-left: 0.4rem;
    padding-right: 0.4rem;
  }
}
    </style>
</head>
<body>
    <div class="modal-mini-aviso" id="modal-mini-aviso">
        <i class="fas fa-exclamation-triangle"></i>
        <span>Este modo (Mar-IA mini) está en desarrollo y puede presentar errores.</span>
    </div>
    
    <div class="panel-historial" id="panel-historial">
        <div class="cabecera-panel-historial">
            <h2><i class="fas fa-history"></i> Historial</h2>
            <button class="boton-cerrar-historial" id="boton-cerrar-historial">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="buscar-historial">
            <input type="text" class="input-buscar-historial" id="input-buscar-historial" placeholder="Buscar conversación...">
        </div>
        <button class="boton-nueva-conversacion" id="boton-nueva-conversacion">
            <i class="fas fa-plus"></i> Nueva conversación
        </button>
        <div class="lista-historial" id="lista-historial"></div>
    </div>
    
    <div class="overlay-historial" id="overlay-historial"></div>
    
    <div class="contenedor">
        <header class="cabecera">
            <div class="titulo">
                <i class="fas fa-robot"></i>
                <div>
                    <h1 id="titulo-modo">Mar-IA</h1>
                    <div class="subtitle">by Mario Vazquez</div>
                </div>
            </div>
            <div class="controles-cabecera">
                <button id="start-live-btn" class="boton-control" aria-label="Iniciar conversación por voz" title="Conversación Live">
                    <i class="fas fa-headset"></i>
                </button>
                <button id="boton-menu-principal" class="boton-control" aria-label="Abrir menú de configuración" title="Configuración">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </header>

        <main class="contenedor-chat" id="contenedor-chat"></main>
        
        <button id="boton-scroll-final" title="Ir al final">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg>
        </button>

        <div class="contenedor-entrada-wrapper" id="contenedor-entrada-wrapper">
            <div class="contenedor-entrada">
                <div class="contenedor-adjuntos" id="contenedor-adjuntos"></div>
                <textarea id="entrada-usuario" placeholder="Pregúntale a Mar-IA..." rows="1"></textarea>
                <div class="input-area-botones">
                    <button id="boton-mas" class="boton-input" title="Adjuntar archivo"><i class="fas fa-paperclip"></i></button>
                    <button id="boton-buscar" class="boton-input" title="Buscar en internet"><i class="fas fa-search"></i></button>
                    <button id="boton-grabar" class="boton-input" title="Grabar voz"><i class="fas fa-microphone"></i></button>
                    <button id="boton-generar-imagen" class="boton-generar-imagen" title="Modo Picasso (generar imagen)"><i class="fas fa-paint-brush"></i></button>
                    <button id="boton-enviar" class="boton-input" title="Enviar mensaje"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div id="live-conversation-screen">
        <div class="robot-container">
            <div class="listening-indicator"></div>
            <svg id="robot-svg" viewBox="0 0 300 300">
                <path d="M 50 100 A 100 100 0 0 1 250 100 L 250 200 A 100 100 0 0 1 50 200 Z" fill="#3a3a3a" stroke="#7f5af0" stroke-width="4"/>
                <circle class="robot-eye" cx="110" cy="140" r="15" fill="#87CEEB"/>
                <circle class="robot-eye" cx="190" cy="140" r="15" fill="#87CEEB"/>
                <path class="robot-mouth" d="M 120 200 Q 150 210 180 200" stroke="#87CEEB" stroke-width="5" fill="none" stroke-linecap="round"/>
            </svg>
        </div>
        <div class="live-status" id="live-status">Toca el micrófono para empezar</div>
        <div class="live-controls">
            <button id="pause-live-btn" class="live-control-btn" title="Pausar/Reanudar escucha">
                <i class="fas fa-microphone"></i>
            </button>
            <button id="close-live-btn" class="live-control-btn" title="Cerrar conversación">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <input type="file" id="input-imagen" accept="image/*" multiple>
    <input type="file" id="input-camara" accept="image/*" capture="camera">
    <input type="file" id="input-archivo" multiple>

    <div class="modal-imagen" id="modal-imagen">
        <div class="contenido-modal-imagen">
            <div class="botones-modal-imagen">
                <button class="boton-modal-imagen" id="descargar-imagen" title="Descargar imagen"><i class="fas fa-download"></i></button>
                <button class="boton-modal-imagen" id="cerrar-modal-imagen" title="Cerrar"><i class="fas fa-times"></i></button>
            </div>
            <img id="imagen-ampliada" src="" alt="Imagen generada por Mar-IA">
        </div>
    </div>
    
    <div class="modal-ocr" id="modal-ocr">
        <button class="opcion-ocr" id="tomar-foto"><i class="fas fa-camera"></i> Tomar foto</button>
        <button class="opcion-ocr" id="elegir-galeria"><i class="fas fa-images"></i> Elegir de galería</button>
        <button class="opcion-ocr" id="elegir-archivo"><i class="fas fa-file-alt"></i> Subir archivo</button>
        <button class="opcion-ocr" id="activar-busqueda-modal"><i class="fas fa-search"></i> Buscar en internet</button>
    </div>
    
    <div class="modal-modo" id="modal-modo">
        <div class="opcion-modo" data-modo="normal">
            <div class="opcion-modo-titulo"><i class="fas fa-comment-alt"></i><span>Mar-IA</span></div>
            <div class="opcion-modo-desc">Respuesta directa y rápida.</div>
        </div>
        <div class="opcion-modo" data-modo="super">
            <div class="opcion-modo-titulo"><i class="fas fa-brain"></i><span>SUPER MAR-IA</span></div>
            <div class="opcion-modo-desc">Usa el modelo de razonamiento avanzado para respuestas profundas.</div>
        </div>
        <div class="opcion-modo" data-modo="mini">
            <div class="opcion-modo-titulo"><i class="fas fa-bolt"></i><span>Mar-IA mini</span></div>
            <div class="opcion-modo-desc">Respuestas ultra rápidas y breves, ideal para consultas simples.</div>
        </div>
    </div>

    <div class="modal-menu-principal" id="modal-menu-principal">
        <button class="opcion-menu" id="menu-historial">
            <i class="fas fa-history"></i><span>Historial</span>
            <span class="contador-historial" id="contador-historial-menu">0</span>
        </button>
        <button class="opcion-menu" id="menu-ayuda"><i class="fas fa-question-circle"></i><span>Ayuda</span></button>
        <button class="opcion-menu" id="menu-tema"><i class="fas fa-sun"></i><span>Alternar Tema</span></button>
        <div class="opcion-menu">
            <i class="fas fa-language"></i>
            <select id="selector-voz" aria-label="Seleccionar voz de la IA"></select>
        </div>
    </div>
    
    <div class="modal-super-ia" id="modal-super-ia">
        <div class="modal-super-ia-contenido">
            <button class="cerrar-modal-super-ia" id="cerrar-modal-super-ia">&times;</button>
            <h3><i class="fas fa-crown"></i> Modo SUPER MAR-IA Activado</h3>
            <p>Este modo es más avanzado y utiliza un modelo de razonamiento profundo para analizar tus preguntas y generar respuestas de mayor calidad.</p>
            <div class="comparacion-modos">
                <div class="modo-card">
                    <h4><i class="fas fa-comment-alt"></i> Mar-IA</h4>
                    <ul><li>Respuestas rápidas</li><li>Ideal para consultas simples</li><li>Menor consumo de recursos</li><li>Respuestas directas</li></ul>
                </div>
                <div class="modo-card super">
                    <h4><i class="fas fa-brain"></i> SUPER MAR-IA</h4>
                    <ul><li>Respuestas más inteligentes</li><li>Análisis profundo de problemas</li><li>Mayor precisión en respuestas</li><li>Capacidad de razonamiento</li><li>Procesamiento más lento</li></ul>
                </div>
            </div>
            <button class="boton-entendido" id="boton-entendido">¡Entendido! Empezar a usar</button>
        </div>
    </div>
    
    <div class="modal-ayuda" id="modal-ayuda">
        <div class="modal-ayuda-contenido">
            <button class="cerrar-modal-ayuda" id="cerrar-modal-ayuda">&times;</button>
            <h3><i class="fas fa-question-circle"></i> Guía de Ayuda</h3>
            <div class="seccion-ayuda">
                <h4><i class="fas fa-exchange-alt"></i> Cambiar entre modos</h4>
                <ul><li>Para cambiar entre los modos Mar-IA, SUPER MAR-IA y Mar-IA mini, haz clic en el título principal en la parte superior.</li><li>Se abrirá un menú donde podrás seleccionar el modo deseado.</li><li>El modo SUPER MAR-IA es más lento pero ofrece respuestas más inteligentes mediante un análisis profundo.</li><li>El modo Mar-IA mini ofrece respuestas ultra rápidas y breves.</li></ul>
            </div>
            <div class="seccion-ayuda">
                <h4><i class="fas fa-sliders-h"></i> Funciones de los controles</h4>
                <div class="item-ayuda"><div class="icono-ayuda"><i class="fas fa-paperclip"></i></div><div class="contenido-ayuda"><div class="titulo-item">Adjuntar y exportar</div><div class="descripcion-item">Permite adjuntar archivos para OCR.</div></div></div>
                <div class="item-ayuda"><div class="icono-ayuda"><i class="fas fa-search"></i></div><div class="contenido-ayuda"><div class="titulo-item">Buscar en internet</div><div class="descripcion-item">Activa el modo de búsqueda para que Mar-IA busque información en internet antes de responder.</div></div></div>
                <div class="item-ayuda"><div class="icono-ayuda"><i class="fas fa-microphone"></i></div><div class="contenido-ayuda"><div class="titulo-item">Grabar voz</div><div class="descripcion-item">Permite dictar tu mensaje mediante reconocimiento de voz.</div></div></div>
                <div class="item-ayuda"><div class="icono-ayuda"><i class="fas fa-language"></i></div><div class="contenido-ayuda"><div class="titulo-item">Seleccionar voz</div><div class="descripcion-item">Cambia la voz que utiliza Mar-IA para leer las respuestas en voz alta.</div></div></div>
                <div class="item-ayuda"><div class="icono-ayuda"><i class="fas fa-sun"></i></div><div class="contenido-ayuda"><div class="titulo-item">Alternar tema</div><div class="descripcion-item">Cambia entre modo claro y modo oscuro.</div></div></div>
                <div class="item-ayuda"><div class="icono-ayuda"><i class="fas fa-paint-brush"></i></div><div class="contenido-ayuda"><div class="titulo-item">Modo Picasso</div><div class="descripcion-item">Activa la generación de imágenes. Las solicitudes se convertirán en imágenes visuales.</div></div></div>
                <div class="item-ayuda"><div class="icono-ayuda"><i class="fas fa-history"></i></div><div class="contenido-ayuda"><div class>Historial de conversaciones</div><div class="descripcion-item">Accede a todas tus conversaciones anteriores, crea nuevas o elimina las existentes.</div></div></div>
            </div>
            <button class="boton-ayuda" id="cerrar-modal-ayuda-btn"><i class="fas fa-check"></i> Entendido</button>
        </div>
    </div>
    
    <div class="overlay" id="overlay"></div>
    <div id="confirmacionCopia" class="copy-confirmation">¡Copiado!</div>
    
     <div id="liveModal" class="live-modal oculto">
        <div class="live-modal-contenido">
        <span id="cerrarLiveModal" class="cerrar-modal">&times;</span>
        <h2>Modo Live</h2>
        <p>El Modo Live sigue en desarrollo e investigación, puede presentar detalles.</p>
       </div>
     </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_KEYS = {
                GEMINI: 'AIzaSyCJ_JioAHSxLvyZG7XcGeWYyUJWR5_wj60',
                DEEPSEEK: 'sk-646a5b86d1de4ee186dfac833541452b',
                META: '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', 
                NEWS: '4e3d9a0bd89e4253a16fd90f8a196089',
                OCR: 'K82439722788957'
            };
            const SYSTEM_PROMPT = `Eres un asistente virtual en español. Tu estilo debe ser:
- Claro, legible y organizado.
- Responde en español usando Markdown: encabezados (##), listas y bloques de código cuando corresponda.
- Frases cortas (máx. 2–3 frases por párrafo).
- Divide el texto en párrafos pequeños y bien espaciados.
- Comienza con un breve resumen de 1–2 líneas cuando la respuesta sea larga.
- Usa listas y pasos numerados para explicar procesos.
- Incluye ejemplos prácticos cuando sea útil.
- Evita relleno, prosa innecesaria o respuestas vagas.
- Si el usuario solicita código (HTML, CSS, JS, etc.), devuelve únicamente el bloque de código dentro de triple backticks.
- Mantén siempre un tono claro, amistoso y profesional.`;

            const ensureSystem = (messages) => {
                if (!Array.isArray(messages)) return [{ role: 'system', content: SYSTEM_PROMPT }];
                const copy = messages.slice();
                if (copy.length === 0 || copy[0].role !== 'system') copy.unshift({ role: 'system', content: SYSTEM_PROMPT });
                else copy[0] = { role: 'system', content: SYSTEM_PROMPT };
                return copy;
            };

            (function(){
                const _fetch = window.fetch.bind(window);
                window.fetch = async function(input, init){
                    try {
                        if (init && typeof init.body === 'string' && init.body.includes('"messages"')) {
                            const obj = JSON.parse(init.body);
                            if (Array.isArray(obj.messages)) {
                                obj.messages = ensureSystem(obj.messages);
                                init = Object.assign({}, init, { body: JSON.stringify(obj) });
                            }
                        }
                    } catch(e){}
                    return _fetch(input, init);
                };
            })();

            const CLAVE_API_NEWS = API_KEYS.NEWS; 
            const CLAVE_API_DEEPSEEK = API_KEYS.DEEPSEEK; 
            const CLAVE_API_OCR = API_KEYS.OCR;
            const ESTILOS_DOCUMENTO = {
                'moderno': { titulo: 'Moderno', fuente: 'Helvetica', tamanoTitulo: 20, tamanoSubtitulo: 16, tamanoCuerpo: 11, interlineado: 1.5, colorTitulo: '#2C2C2C', colorTexto: '#333333', alineacion: 'left' },
                'clasico': { titulo: 'Clásico', fuente: 'Times New Roman', tamanoTitulo: 18, tamanoSubtitulo: 14, tamanoCuerpo: 12, interlineado: 1.15, colorTitulo: '#000000', colorTexto: '#000000', alineacion: 'center' },
                'tecnico': { titulo: 'Técnico', fuente: 'Arial', tamanoTitulo: 16, tamanoSubtitulo: 14, tamanoCuerpo: 11, interlineado: 1.2, colorTitulo: '#1E1E1E', colorTexto: '#1E1E1E', alineacion: 'left' },
                'creativo': { titulo: 'Creativo', fuente: 'Montserrat', tamanoTitulo: 22, tamanoSubtitulo: 16, tamanoCuerpo: 12, interlineado: 1.6, colorTitulo: '#8A2BE2', colorTexto: '#333333', alineacion: 'left' },
                'apa': { titulo: 'APA', fuente: 'Times New Roman', tamanoTitulo: 12, tamanoSubtitulo: 12, tamanoCuerpo: 12, interlineado: 2, colorTitulo: '#000000', colorTexto: '#000000', alineacion: 'left' }
            };
            const elementos = {
                body: document.body, contenedor: document.querySelector('.contenedor'), contenedorChat: document.getElementById('contenedor-chat'), entradaUsuario: document.getElementById('entrada-usuario'), botonEnviar: document.getElementById('boton-enviar'), botonGrabar: document.getElementById('boton-grabar'), botonMas: document.getElementById('boton-mas'), botonBuscar: document.getElementById('boton-buscar'), botonGenerarImagen: document.getElementById('boton-generar-imagen'), inputImagen: document.getElementById('input-imagen'), inputCamara: document.getElementById('input-camara'), inputArchivo: document.getElementById('input-archivo'), modalOcr: document.getElementById('modal-ocr'), modalModo: document.getElementById('modal-modo'), overlay: document.getElementById('overlay'), btnTomarFoto: document.getElementById('tomar-foto'), btnGaleria: document.getElementById('elegir-galeria'), btnArchivo: document.getElementById('elegir-archivo'), alternadorTema: document.getElementById('menu-tema'), confirmacionCopia: document.getElementById('confirmacionCopia'), selectorVoz: document.getElementById('selector-voz'), contenedorAdjuntos: document.getElementById('contenedor-adjuntos'), btnActivarBusquedaModal: document.getElementById('activar-busqueda-modal'), tituloModo: document.getElementById('titulo-modo'), modalSuperIA: document.getElementById('modal-super-ia'), cerrarModalSuperIA: document.getElementById('cerrar-modal-super-ia'), botonEntendido: document.getElementById('boton-entendido'), botonAyuda: document.getElementById('menu-ayuda'), modalAyuda: document.getElementById('modal-ayuda'), cerrarModalAyuda: document.getElementById('cerrar-modal-ayuda'), cerrarModalAyudaBtn: document.getElementById('cerrar-modal-ayuda-btn'), entradaWrapper: document.getElementById('contenedor-entrada-wrapper'), modalImagen: document.getElementById('modal-imagen'), imagenAmpliada: document.getElementById('imagen-ampliada'), cerrarModalImagen: document.getElementById('cerrar-modal-imagen'), descargarImagenBtn: document.getElementById('descargar-imagen'), modalMiniAviso: document.getElementById('modal-mini-aviso'), botonScrollFinal: document.getElementById('boton-scroll-final'), botonMenuPrincipal: document.getElementById('boton-menu-principal'), modalMenuPrincipal: document.getElementById('modal-menu-principal'), startLiveBtn: document.getElementById('start-live-btn'), liveScreen: document.getElementById('live-conversation-screen'), robotSvg: document.getElementById('robot-svg'), liveStatus: document.getElementById('live-status'), pauseLiveBtn: document.getElementById('pause-live-btn'), closeLiveBtn: document.getElementById('close-live-btn')
            };
            const elementosHistorial = {
                panelHistorial: document.getElementById('panel-historial'), botonHistorial: document.getElementById('menu-historial'), botonCerrarHistorial: document.getElementById('boton-cerrar-historial'), listaHistorial: document.getElementById('lista-historial'), inputBuscarHistorial: document.getElementById('input-buscar-historial'), botonNuevaConversacion: document.getElementById('boton-nueva-conversacion'), overlayHistorial: document.getElementById('overlay-historial'), contadorHistorial: document.getElementById('contador-historial-menu'), contenedorChat: document.getElementById('contenedor-chat')
            };

            let historialChat = [], archivosAdjuntos = [], reconocimientoVoz = null, estaGrabando = false, ultimoMensajeFuePorVoz = false, sintesisVozActual = null, modoBusqueda = false, modoSuperIA = false, modoMiniIA = false, modoPicasso = false, estaGenerandoRespuesta = false, cancelarStreaming = null, cancelarProcesoCompleto = false, imagenGeneradaActual = null, ultimaDescripcionImagen = "", scrollAutomatico = true, conversaciones = [], conversacionActualId = null, panelHistorialAbierto = false, contadorHistorial = 0;
            let estadoConversacion = { esperandoFormato: false, comandoPendiente: null };
            let liveRecognition = null, isLiveModeActive = false, isLiveListeningPaused = true, liveChatHistory = [], isProcessingLiveQuery = false;

            const iniciar = () => {
                cargarEstado(); configurarEventListeners(); iniciarReconocimientoVoz(); iniciarSintesisVoz(); cargarConversaciones();
                conversaciones.length === 0 ? crearNuevaConversacion() : cargarConversacion(conversaciones[0].id);
                autoAjustarTextarea();
            };

            const configurarEventListeners = () => {
                elementos.contenedorChat.addEventListener('scroll', gestionarScrollUsuario);
                elementos.botonScrollFinal.addEventListener('click', () => { elementos.contenedorChat.scrollTop = elementos.contenedorChat.scrollHeight; scrollAutomatico = true; elementos.botonScrollFinal.classList.remove('visible'); });
                elementos.botonEnviar.addEventListener('click', gestionarEnvioMensaje);
                elementos.botonGenerarImagen.addEventListener('click', () => { modoPicasso = !modoPicasso; elementos.botonGenerarImagen.classList.toggle('modo-activo', modoPicasso); elementos.entradaUsuario.placeholder = modoPicasso ? "Describe la imagen que deseas generar..." : "Pregúntale a Mar-IA..."; });
                elementos.entradaUsuario.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); gestionarEnvioMensaje(); } });
                elementos.entradaUsuario.addEventListener('input', autoAjustarTextarea);
                elementos.entradaUsuario.addEventListener('focus', gestionarFocoInput);
                elementos.botonGrabar.addEventListener('click', alternarGrabacion);
                elementos.botonMas.addEventListener('click', () => alternarModal(elementos.modalOcr.style.display !== 'flex', elementos.modalOcr));
                elementos.botonBuscar.addEventListener('click', () => alternarModoBusqueda());
                elementos.botonMenuPrincipal.addEventListener('click', () => alternarModal(elementos.modalMenuPrincipal.style.display !== 'flex', elementos.modalMenuPrincipal));
                elementos.overlay.addEventListener('click', () => { alternarModal(false, elementos.modalOcr); alternarModal(false, elementos.modalModo); alternarModal(false, elementos.modalSuperIA); alternarModal(false, elementos.modalAyuda); alternarModal(false, elementos.modalImagen); alternarModal(false, elementos.modalMenuPrincipal); });
                elementos.btnTomarFoto.addEventListener('click', () => { alternarModal(false, elementos.modalOcr); elementos.inputCamara.click(); });
                elementos.btnGaleria.addEventListener('click', () => { alternarModal(false, elementos.modalOcr); elementos.inputImagen.click(); });
                elementos.btnArchivo.addEventListener('click', () => { alternarModal(false, elementos.modalOcr); elementos.inputArchivo.click(); });
                elementos.inputImagen.addEventListener('change', (e) => gestionarSeleccionArchivo(e.target.files));
                elementos.inputCamara.addEventListener('change', (e) => gestionarSeleccionArchivo(e.target.files));
                elementos.inputArchivo.addEventListener('change', (e) => gestionarSeleccionArchivo(e.target.files));
                elementos.alternadorTema.addEventListener('click', () => { alternarTema(); alternarModal(false, elementos.modalMenuPrincipal); });
                elementos.selectorVoz.addEventListener('change', detenerVoz);
                elementos.btnActivarBusquedaModal.addEventListener('click', () => { alternarModoBusqueda(true); alternarModal(false, elementos.modalOcr); });
                elementos.tituloModo.addEventListener('click', () => alternarModal(true, elementos.modalModo));
                document.querySelectorAll('.opcion-modo').forEach(opcion => opcion.addEventListener('click', (e) => establecerModoIA(e.currentTarget.dataset.modo)));
                elementos.contenedorChat.addEventListener('click', gestionarClickContenedorChat);
                elementos.cerrarModalSuperIA.addEventListener('click', () => alternarModal(false, elementos.modalSuperIA));
                elementos.botonEntendido.addEventListener('click', () => alternarModal(false, elementos.modalSuperIA));
                elementos.botonAyuda.addEventListener('click', () => { alternarModal(true, elementos.modalAyuda); alternarModal(false, elementos.modalMenuPrincipal); });
                elementos.cerrarModalAyuda.addEventListener('click', () => alternarModal(false, elementos.modalAyuda));
                elementos.cerrarModalAyudaBtn.addEventListener('click', () => alternarModal(false, elementos.modalAyuda));
                elementos.cerrarModalImagen.addEventListener('click', () => alternarModal(false, elementos.modalImagen));
                elementos.descargarImagenBtn.addEventListener('click', descargarImagen);
                elementosHistorial.botonHistorial.addEventListener('click', () => { alternarPanelHistorial(); alternarModal(false, elementos.modalMenuPrincipal); });
                elementosHistorial.botonCerrarHistorial.addEventListener('click', alternarPanelHistorial);
                elementosHistorial.overlayHistorial.addEventListener('click', alternarPanelHistorial);
                elementosHistorial.botonNuevaConversacion.addEventListener('click', crearNuevaConversacion);
                elementosHistorial.inputBuscarHistorial.addEventListener('input', filtrarConversaciones);
                elementos.startLiveBtn.addEventListener('click', iniciarLiveConversation);
                elementos.closeLiveBtn.addEventListener('click', cerrarLiveConversation);
                elementos.pauseLiveBtn.addEventListener('click', toggleLiveListening);
            };

            const setRobotState = (state) => {
                elementos.robotSvg.classList.remove('listening', 'talking');
                if (state === 'listening' || state === 'talking') elementos.robotSvg.classList.add(state);
            };

            const iniciarLiveConversation = () => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) return alert("Tu navegador no soporta Web Speech API.");
                isLiveModeActive = true; isLiveListeningPaused = false;
                elementos.liveScreen.classList.add('visible'); liveChatHistory = [...historialChat]; elementos.pauseLiveBtn.innerHTML = '<i class="fas fa-pause"></i>';
                liveRecognition = new SpeechRecognition(); liveRecognition.lang = 'es-ES'; liveRecognition.continuous = true; liveRecognition.interimResults = true;
                liveRecognition.onstart = () => { if (!isProcessingLiveQuery && !sintesisVozActual) { setRobotState('listening'); elementos.liveStatus.textContent = 'Escuchando...'; } };
                liveRecognition.onresult = async (event) => {
                    if (isProcessingLiveQuery || (sintesisVozActual && speechSynthesis.speaking)) return;
                    let finalTranscript = '', interimTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) event.results[i].isFinal ? finalTranscript += event.results[i][0].transcript : interimTranscript += event.results[i][0].transcript;
                    if (interimTranscript) { elementos.liveStatus.textContent = interimTranscript; setRobotState('listening'); }
                    if (finalTranscript) { elementos.liveStatus.textContent = finalTranscript; isProcessingLiveQuery = true; setRobotState('thinking'); try { liveRecognition.stop(); } catch(e) {} await procesarVozLive(finalTranscript); }
                };
                liveRecognition.onerror = (event) => console.log('Error Speech:', event.error);
                liveRecognition.onend = () => { if (isLiveModeActive && !isLiveListeningPaused && !isProcessingLiveQuery) try { liveRecognition.start(); } catch(e) {} };
                try { liveRecognition.start(); } catch(e) { console.error("Error al iniciar reconocimiento:", e); }
            };

            const cerrarLiveConversation = () => { isLiveModeActive = false; isLiveListeningPaused = true; detenerVoz(); if (liveRecognition) { try { liveRecognition.stop(); } catch(e) {} liveRecognition = null; } elementos.liveScreen.classList.remove('visible'); setRobotState('idle'); };
            const toggleLiveListening = () => { isLiveListeningPaused = !isLiveListeningPaused; if (isLiveListeningPaused) { if (liveRecognition) try { liveRecognition.stop(); } catch(e) {} elementos.pauseLiveBtn.innerHTML = '<i class="fas fa-microphone"></i>'; elementos.liveStatus.textContent = 'En pausa'; setRobotState('idle'); } else { elementos.pauseLiveBtn.innerHTML = '<i class="fas fa-pause"></i>'; elementos.liveStatus.textContent = 'Escuchando...'; try { liveRecognition.start(); } catch(e) {} } };

            const procesarVozLive = async (textoUsuario) => {
                if (!textoUsuario) return;
                liveChatHistory.push({ role: "user", content: textoUsuario });
                try {
                    const respuesta = await fetch('https://api.deepseek.com/v1/chat/completions', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEYS.DEEPSEEK}` }, body: JSON.stringify({ model: "deepseek-chat", messages: liveChatHistory, stream: false, temperature: 0.6, max_tokens: 300 }) });
                    if (!respuesta.ok) throw new Error(`Error de API DeepSeek`);
                    const datos = await respuesta.json(); const textoRespuesta = datos.choices[0]?.message?.content;
                    textoRespuesta ? (liveChatHistory.push({ role: "assistant", content: textoRespuesta }), hablarRespuestaLive(textoRespuesta)) : hablarRespuestaLive("No he podido generar una respuesta.");
                } catch (error) { hablarRespuestaLive("Lo siento, tuve un problema de conexión."); }
            };
            
            const hablarRespuestaLive = (texto) => {
                detenerVoz(); sintesisVozActual = new SpeechSynthesisUtterance(texto);
                const voz = speechSynthesis.getVoices().find(v => v.name === elementos.selectorVoz.value);
                if (voz) sintesisVozActual.voice = voz;
                sintesisVozActual.onstart = () => { setRobotState('talking'); elementos.liveStatus.textContent = '...'; };
                sintesisVozActual.onend = () => { sintesisVozActual = null; isProcessingLiveQuery = false; if (isLiveModeActive && !isLiveListeningPaused) { setRobotState('idle'); elementos.liveStatus.textContent = 'Escuchando...'; try { liveRecognition.start(); } catch(e) {} } else { setRobotState('idle'); elementos.liveStatus.textContent = 'En pausa'; } };
                speechSynthesis.speak(sintesisVozActual);
            };

            const alternarPanelHistorial = () => { panelHistorialAbierto = !panelHistorialAbierto; elementosHistorial.panelHistorial.classList.toggle('abierto', panelHistorialAbierto); elementosHistorial.overlayHistorial.style.display = panelHistorialAbierto ? 'block' : 'none'; elementosHistorial.contenedorChat.classList.toggle('desplazado', panelHistorialAbierto); };
            const cargarConversaciones = () => { const guardadas = localStorage.getItem('conversaciones'); if (guardadas) { conversaciones = JSON.parse(guardadas); actualizarContador(); renderizarListaHistorial(); } };
            const guardarConversaciones = () => { localStorage.setItem('conversaciones', JSON.stringify(conversaciones)); actualizarContador(); };
            const actualizarContador = () => { contadorHistorial = conversaciones.length; elementosHistorial.contadorHistorial.textContent = contadorHistorial > 0 ? contadorHistorial : ''; elementosHistorial.contadorHistorial.style.display = contadorHistorial > 0 ? 'flex' : 'none'; };

            const crearNuevaConversacion = () => {
                if (panelHistorialAbierto) alternarPanelHistorial();
                const nueva = { id: Date.now().toString(), titulo: 'Nueva conversación', fecha: new Date().toISOString(), historial: [{ role: "system", content: `Eres un asistente virtual en español. Tu estilo debe ser:
- Claro, legible y organizado.
- Responde en español usando Markdown: encabezados (##), listas y bloques de código cuando corresponda.
- Frases cortas (máx. 2–3 frases por párrafo).
- Divide el texto en párrafos pequeños y bien espaciados.
- Comienza con un breve resumen de 1–2 líneas cuando la respuesta sea larga.
- Usa listas y pasos numerados para explicar procesos.
- Incluye ejemplos prácticos cuando sea útil.
- Evita relleno, prosa innecesaria o respuestas vagas.
- Si el usuario solicita código (HTML, CSS, JS, etc.), devuelve únicamente el bloque de código dentro de triple backticks.
- Mantén siempre un tono claro, amistoso y profesional.` }], modoSuperIA: false, modoMiniIA: false, modoPicasso: false, modoBusqueda: false, ultimaDescripcionImagen: "" };
                conversaciones.unshift(nueva); conversacionActualId = nueva.id; cargarConversacion(conversacionActualId); guardarConversaciones(); renderizarListaHistorial();
            };

            const cargarConversacion = (id) => {
                const conv = conversaciones.find(c => c.id === id); if (!conv) return;
                conversacionActualId = id; modoSuperIA = conv.modoSuperIA || false; modoMiniIA = conv.modoMiniIA || false; modoPicasso = conv.modoPicasso || false; modoBusqueda = conv.modoBusqueda || false; ultimaDescripcionImagen = conv.ultimaDescripcionImagen || "";
                elementos.tituloModo.textContent = modoSuperIA ? 'SUPER MAR-IA' : (modoMiniIA ? 'Mar-IA mini' : 'Mar-IA');
                elementos.tituloModo.classList.toggle('super-ia-gradient', modoSuperIA); elementos.tituloModo.classList.toggle('mini-ia-gradient', modoMiniIA);
                elementos.botonBuscar.classList.toggle('modo-activo', modoBusqueda); elementos.botonGenerarImagen.classList.toggle('modo-activo', modoPicasso);
                elementos.entradaUsuario.placeholder = modoPicasso ? "Describe la imagen que deseas generar..." : "Pregúntale a Mar-IA...";
                elementos.contenedorChat.innerHTML = ''; historialChat = [...conv.historial];
                for (const m of historialChat) { if (m.role === 'user') agregarMensaje('usuario', m.content); else if (m.role === 'assistant' && !m.content.startsWith("Información obtenida de")) agregarMensaje('bot', m.content); }
                irAlFinal(true); renderizarListaHistorial();
            };

            const guardarMensajeEnHistorial = (rol, contenido) => {
                const actual = conversaciones.find(c => c.id === conversacionActualId); if (!actual) return;
                actual.historial.push({ role: rol, content: contenido });
                if (rol === 'user' && actual.titulo === 'Nueva conversación') actual.titulo = contenido.substring(0, 50) + (contenido.length > 50 ? '...' : '');
                actual.fecha = new Date().toISOString(); actual.modoSuperIA = modoSuperIA; actual.modoMiniIA = modoMiniIA; actual.modoPicasso = modoPicasso; actual.modoBusqueda = modoBusqueda; actual.ultimaDescripcionImagen = ultimaDescripcionImagen;
                guardarConversaciones(); renderizarListaHistorial();
            };

            const renderizarListaHistorial = () => {
                elementosHistorial.listaHistorial.innerHTML = '';
                if (conversaciones.length === 0) return elementosHistorial.listaHistorial.innerHTML = '<div class="sin-conversaciones">No hay conversaciones guardadas</div>';
                conversaciones.forEach(conv => {
                    const item = document.createElement('div'); item.className = `item-historial ${conv.id === conversacionActualId ? 'seleccionado' : ''}`; item.dataset.id = conv.id;
                    const preview = (conv.historial.find(m => m.role === 'user')?.content || 'Conversación vacía').replace(/\[Imagen generada\].*/, '[Imagen]').trim();
                    item.innerHTML = `<div class="titulo-conversacion">${conv.titulo}</div><div class="fecha-conversacion">${formatearFecha(conv.fecha)}</div><div class="preview-conversacion">${preview.substring(0, 70)}${preview.length > 70 ? '...' : ''}</div><div class="acciones-item-historial"><button class="boton-accion-item boton-eliminar-conversacion" title="Eliminar conversación"><i class="fas fa-trash"></i></button></div>`;
                    item.addEventListener('click', () => { if (conv.id !== conversacionActualId) cargarConversacion(conv.id); if (panelHistorialAbierto) alternarPanelHistorial(); });
                    item.querySelector('.boton-eliminar-conversacion').addEventListener('click', (e) => { e.stopPropagation(); eliminarConversacion(conv.id); });
                    elementosHistorial.listaHistorial.appendChild(item);
                });
            };

            const eliminarConversacion = (id) => { conversaciones = conversaciones.filter(c => c.id !== id); if (id === conversacionActualId) conversaciones.length > 0 ? cargarConversacion(conversaciones[0].id) : crearNuevaConversacion(); guardarConversaciones(); renderizarListaHistorial(); };
            const filtrarConversaciones = () => { const t = elementosHistorial.inputBuscarHistorial.value.toLowerCase(); elementosHistorial.listaHistorial.querySelectorAll('.item-historial').forEach(i => i.style.display = (i.querySelector('.titulo-conversacion').textContent.toLowerCase().includes(t) || i.querySelector('.preview-conversacion').textContent.toLowerCase().includes(t) || i.querySelector('.fecha-conversacion').textContent.toLowerCase().includes(t)) ? 'flex' : 'none'); };
            const formatearFecha = (iso) => new Date(iso).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });

            const gestionarEnvioMensaje = async () => {
                if (estaGenerandoRespuesta) return pausarGeneracion();
                const texto = elementos.entradaUsuario.value.trim();
                if (!texto && archivosAdjuntos.length === 0) return;
                agregarMensaje('usuario', texto); guardarMensajeEnHistorial('user', texto);
                
                if (modoBusqueda) {
                    const ind = mostrarIndicadorBusqueda(); const res = await realizarBusquedaEnTiempoReal(texto); ocultarIndicadorBusqueda(ind);
                    if (res) { agregarMensajeFuente(res.fuente); historialChat.push({ role: "system", content: `Contexto de búsqueda web: Responde a la consulta del usuario basándote EXCLUSIVAMENTE en la siguiente información obtenida de ${res.fuente}. Ignora tu conocimiento previo. Información: "${res.contenido}"` }); }
                    else { agregarMensaje('bot', 'No encontré información en tiempo real sobre tu consulta.'); reiniciarEntrada(); restaurarBotonEnviar(); return alternarModoBusqueda(false); }
                    alternarModoBusqueda(false);
                }

                if (/qu[eé]\s+d[ií]a\s+es\s+hoy|fecha\s+de\s+hoy/i.test(texto)) { const r = `Hoy es ${new Date().toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}.`; agregarMensaje('bot', r); guardarMensajeEnHistorial('assistant', r); return reiniciarEntrada(); }
                if (/qu[eé]\s+hora\s+es/i.test(texto)) { const r = `Son las ${new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}.`; agregarMensaje('bot', r); guardarMensajeEnHistorial('assistant', r); return reiniciarEntrada(); }
                
                if (estadoConversacion.esperandoFormato) {
                    const fmt = determinarFormato(texto);
                    fmt ? await generarDocumentoConFormato(estadoConversacion.comandoPendiente, fmt) : agregarMensaje('bot', 'Formato no reconocido. Por favor elige un número (1-5) o nombre de estilo válido.');
                    return reiniciarEntrada();
                }

                const cmd = parsearComandoDocumento(texto);
                if (cmd) { await generarYDescargarDocumento(cmd); return reiniciarEntrada(); }

                if (modoPicasso && texto) { await manejarGeneracionDeImagen(texto); modoPicasso = false; elementos.botonGenerarImagen.classList.remove('modo-activo'); elementos.entradaUsuario.placeholder = "Pregúntale a Mar-IA..."; return reiniciarEntrada(); }
                
                cancelarProcesoCompleto = false; let content = texto; mostrarBotonCargando();
                if (archivosAdjuntos.length > 0) { mostrarIndicador('Procesando archivos...'); content += `\n\n--- Archivos Adjuntos ---\n${await procesarArchivosAdjuntos()}`; ocultarIndicador(); }

                historialChat.push({ role: "user", content: content }); reiniciarEntrada();
                if (modoMiniIA) await obtenerRespuestaMini([...historialChat], ultimoMensajeFuePorVoz);
                else if (modoSuperIA) await ejecutarFlujoSuperIA([...historialChat], ultimoMensajeFuePorVoz);
                else await obtenerRespuestaBot([...historialChat], ultimoMensajeFuePorVoz);
                ultimoMensajeFuePorVoz = false;
            };

            const parsearComandoDocumento = (t) => {
                let m = t.match(/(?:crea|genera|hazme|escribe|dame)\s*(?:un|el|un)?\s*(?:documento|archivo|informe)?\s*(?:de\s)?(pdf|word|docx|excel|xlsx)\s*(?:sobre|acerca de|de|del)\s+(.+)/i);
                if (m) return { tipo: m[1].replace('word', 'docx').replace('excel', 'xlsx'), tema: m[2].trim() };
                m = t.match(/(?:crea|genera|exporta|convierte|pasa|dame)\s*(?:eso|esa informaci[oó]n|lo anterior|la respuesta anterior)\s*(?:a|en|como)\s*(?:un|el|un)?\s*(pdf|word|docx|excel|xlsx)/i);
                return m ? { tipo: m[2].replace('word', 'docx').replace('excel', 'xlsx'), tema: 'contextual' } : null;
            };

            const generarYDescargarDocumento = async (cmd) => {
                if (cmd.tipo === 'xlsx') await generarExcel(cmd.tema);
                else { estadoConversacion.esperandoFormato = true; estadoConversacion.comandoPendiente = cmd; agregarMensaje('bot', 'Claro, estoy listo para crear tu documento. ¿En qué formato lo prefieres?\n\n1. Moderno\n2. Clásico\n3. Técnico\n4. Creativo\n5. APA\n\nPor favor, responde con el nombre o el número.'); }
            };
            
            const determinarFormato = (r) => ({ '1': 'moderno', '2': 'clasico', '3': 'tecnico', '4': 'creativo', '5': 'apa', 'moderno': 'moderno', 'clásico': 'clasico', 'clasico': 'clasico', 'técnico': 'tecnico', 'tecnico': 'tecnico', 'creativo': 'creativo', 'apa': 'apa' }[r.toLowerCase()] || null);
            
            const generarDocumentoConFormato = async (cmd, fmt) => {
                estadoConversacion.esperandoFormato = false; estadoConversacion.comandoPendiente = null;
                agregarMensaje('bot', `Preparando tu documento ${cmd.tipo.toUpperCase()} en formato ${ESTILOS_DOCUMENTO[fmt].titulo}...`); irAlFinal(); mostrarBotonCargando();
                try {
                    let contenido;
                    if (cmd.tema === 'contextual') {
                        const last = [...historialChat].reverse().find(m => m.role === 'assistant');
                        if (!last) throw new Error("No hay información anterior para exportar.");
                        contenido = last.content;
                    } else {
                        const prompt = `Genera un texto detallado, informativo y bien estructurado sobre el siguiente tema, para ser usado en un documento formal: ${cmd.tema}`;
                        const res = await fetch('https://api.deepseek.com/v1/chat/completions', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEYS.DEEPSEEK}` }, body: JSON.stringify({ model: "deepseek-chat", messages: [{ role: "user", content: prompt }], max_tokens: 3000, temperature: 0.5 }) });
                        if (!res.ok) throw new Error(`Error API`); const d = await res.json(); contenido = d.choices[0]?.message?.content.trim(); if (!contenido) throw new Error("IA no generó contenido.");
                    }
                    if (cmd.tipo === 'pdf') crearPDF(contenido, fmt); else if (cmd.tipo === 'docx') crearDOCX(contenido, fmt);
                } catch (e) { agregarMensaje('bot', `Error al generar documento: ${e.message}`); } finally { restaurarBotonEnviar(); }
            };
            
            const generarExcel = async (tema) => {
                agregarMensaje('bot', `Preparando tu documento Excel...`); irAlFinal(); mostrarBotonCargando();
                try {
                    let prompt;
                    if (tema === 'contextual') {
                        const last = [...historialChat].reverse().find(m => m.role === 'assistant');
                        if (!last) throw new Error("No hay información anterior.");
                        prompt = `Convierte el siguiente texto en un array de objetos JSON para Excel: ${last.content}`;
                    } else prompt = `Analiza el tema y genera los datos más relevantes en un array de objetos JSON (filas). Tema: ${tema}. Responde SOLO con el JSON.`;
                    const res = await fetch('https://api.deepseek.com/v1/chat/completions', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEYS.DEEPSEEK}` }, body: JSON.stringify({ model: "deepseek-chat", messages: [{ role: "user", content: prompt }], max_tokens: 3000, temperature: 0.5 }) });
                    if (!res.ok) throw new Error(`Error API`); const d = await res.json(); const json = d.choices[0]?.message?.content.trim(); if (!json) throw new Error("IA no generó contenido.");
                    crearXLSX(json); agregarMensaje('bot', '¡Documento listo! ¿Algo más?');
                } catch (e) { agregarMensaje('bot', `Error Excel: ${e.message}`); } finally { restaurarBotonEnviar(); }
            };

            const crearPDF = (c, f) => {
                const { jsPDF } = window.jspdf; const s = ESTILOS_DOCUMENTO[f]; const doc = new jsPDF();
                doc.setFont(s.fuente); doc.setFontSize(s.tamanoTitulo); doc.setTextColor(s.colorTitulo); doc.text('Documento Generado', 105, 15, null, null, 'center');
                doc.setFontSize(s.tamanoSubtitulo); doc.text(`Formato: ${s.titulo}`, 105, 25, null, null, 'center');
                doc.setFontSize(s.tamanoCuerpo); doc.setTextColor(s.colorTexto);
                const lines = doc.splitTextToSize(c.replace(/<[^>]*>/g, ''), 180); let y = 40;
                lines.forEach(l => { if (y > doc.internal.pageSize.height - 10) { doc.addPage(); y = 10; } doc.text(l, 15, y, { align: s.alineacion }); y += s.interlineado * 5; });
                doc.save(`mar-ia-documento-${Date.now()}.pdf`); agregarMensaje('bot', '¡Documento listo! ¿Algo más?');
            };

            const crearDOCX = (c, f) => {
                const s = ESTILOS_DOCUMENTO[f]; const paras = [];
                c.replace(/<[^>]*>/g, '').split('\n').forEach((l, i) => { if (!l.trim()) return; const esT = i === 0 || (l.length < 80 && !l.endsWith('.')); paras.push(new docx.Paragraph({ children: [new docx.TextRun({ text: l, size: (esT ? s.tamanoTitulo : s.tamanoCuerpo) * 2, color: esT ? s.colorTitulo : s.colorTexto })], alignment: s.alineacion === 'center' ? docx.AlignmentType.CENTER : docx.AlignmentType.LEFT, spacing: { after: s.interlineado * 100 } })); });
                docx.Packer.toBlob(new docx.Document({ sections: [{ children: paras }] })).then(b => { const a = document.createElement("a"); a.href = URL.createObjectURL(b); a.download = `mar-ia-documento-${Date.now()}.docx`; document.body.appendChild(a); a.click(); document.body.removeChild(a); agregarMensaje('bot', '¡Documento listo! ¿Algo más?'); });
            };

            const crearXLSX = (json) => {
                try {
                    const data = JSON.parse(json); if (!Array.isArray(data)) throw new Error("JSON inválido");
                    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), "Datos");
                    XLSX.writeFile(wb, `mar-ia-datos-${Date.now()}.xlsx`);
                } catch (e) { agregarMensaje('bot', `Error al procesar Excel: ${e.message}`); }
            };

            const mejorarPromptImagen = async (p, ctx) => {
                try {
                    const res = await fetch('https://api.deepseek.com/v1/chat/completions', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEYS.DEEPSEEK}` }, body: JSON.stringify({ model: "deepseek-chat", messages: [{ role: "user", content: `Mejora este prompt para imagen basándote en el contexto: "${p}". Contexto: ${ctx.slice(-6).map(m => m.content).join('\n')}` }], max_tokens: 150 }) });
                    if (!res.ok) return p; const d = await res.json(); return d.choices[0]?.message?.content.trim() || p;
                } catch { return p; }
            };

            async function manejarGeneracionDeImagen(desc) {
                const id = `picasso-${Date.now()}`; const el = agregarMensaje('bot', 'Refinando idea... 🧠'); el.id = id; irAlFinal();
                const descFinal = (/\b(agrega|modifica|cambia|añade)\b/i.test(desc) && ultimaDescripcionImagen) ? `${ultimaDescripcionImagen}, ${desc}` : desc;
                const prompt = await mejorarPromptImagen(descFinal, historialChat); ultimaDescripcionImagen = prompt;
                if(document.getElementById(id)) document.getElementById(id).innerHTML = marked.parse("Modo Picasso activado... 🎨");
                try {
                    const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt + " --seed " + Math.floor(Math.random() * 100000))}`;
                    const img = new Image(); img.src = url; await new Promise((res, rej) => { img.onload = res; img.onerror = rej; });
                    document.getElementById(id)?.remove(); const msg = `[Imagen generada] ${prompt}`; agregarMensaje('bot', msg); guardarMensajeEnHistorial('assistant', msg);
                    setTimeout(() => { const m = '¡Listo! ¿Te gusta? 😊'; agregarMensaje('bot', m); guardarMensajeEnHistorial('assistant', m); }, 500); imagenGeneradaActual = url;
                } catch { document.getElementById(id)?.remove(); const e = "No pude generar la imagen."; agregarMensaje('bot', e); guardarMensajeEnHistorial('assistant', e); }
            }

            function mostrarModalImagen(url) { elementos.imagenAmpliada.src = url; alternarModal(true, elementos.modalImagen); }
            function descargarImagen() { if (imagenGeneradaActual) { const a = document.createElement('a'); a.href = imagenGeneradaActual; a.download = 'imagen-generada.jpg'; document.body.appendChild(a); a.click(); document.body.removeChild(a); } }

            const agregarMensaje = (rol, cont, stream = false) => {
                const div = document.createElement('div'); div.className = `mensaje mensaje-${rol}`;
                
                let contenedorContenido;
                if (rol === 'bot') {
                    contenedorContenido = document.createElement('div');
                    contenedorContenido.className = 'respuesta-ia';
                } else {
                    contenedorContenido = document.createElement('div');
                    contenedorContenido.className = `burbuja-mensaje burbuja-${rol}`;
                }
                
                if (cont.startsWith('[Imagen generada]')) contenedorContenido.innerHTML = `<div class="contenedor-imagen-generada"><img src="${imagenGeneradaActual}" alt="${cont.replace('[Imagen generada]', '')}" style="max-width: 100%; border-radius: 1.5rem; cursor: zoom-in;"></div>`;
                else if (cont || stream) contenedorContenido.innerHTML = cont ? marked.parse(cont) : '';
                
                const ts = document.createElement('div'); ts.className = 'timestamp-container';
                ts.innerHTML = `<div class="timestamp">${new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</div>${rol === 'bot' ? '<button class="boton-accion-mensaje boton-voz" title="Leer"><i class="fas fa-volume-up"></i></button>' : ''}<button class="boton-accion-mensaje boton-copiar" title="Copiar"><i class="fas fa-copy"></i></button>`;
                
                div.append(contenedorContenido, ts); 
                elementos.contenedorChat.appendChild(div); if (!stream) { formatearBloquesCodigo(div); formatearTablas(div); } irAlFinal(); return div;
            };

            const agregarMensajeFuente = (f) => {
                const d = document.createElement('div'); d.className = 'mensaje-fuente'; d.innerHTML = `<i class="fas ${f.toLowerCase() === 'wikipedia' ? 'fa-book' : f.toLowerCase() === 'newsapi' ? 'fa-newspaper' : 'fa-globe'}"></i> <span>Consultando en ${f}...</span>`;
                elementos.contenedorChat.appendChild(d); irAlFinal(); return d;
            };

            const crearContenedorPensamiento = () => {
                const div = document.createElement('div'); div.className = 'mensaje mensaje-bot';
                div.innerHTML = `<div class="pensamiento-container"><div class="pensamiento-cabecera-clickable"><div class="pensamiento-titulo"><i class="fas fa-brain fa-beat"></i><span>Pensamiento</span></div><div class="pensamiento-controles-cabecera"><div class="tiempo-pensamiento">${new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</div><i class="fas fa-chevron-up toggle-icon"></i></div></div><div class="pensamiento-contenido-wrapper"><div class="contenido-pensamiento"></div><div class="pensamiento-acciones"><button class="boton-pensamiento boton-copiar-pensamiento"><i class="fas fa-copy"></i> Copiar Razonamiento</button></div></div></div>`;
                elementos.contenedorChat.appendChild(div);
                const wrap = div.querySelector('.pensamiento-contenido-wrapper'); wrap.style.maxHeight = wrap.scrollHeight + 'px'; irAlFinal();
                return { contenedorPensamiento: div.querySelector('.pensamiento-container'), contenidoPensamiento: div.querySelector('.contenido-pensamiento'), wrapper: wrap };
            };
            
            const gestionarClickContenedorChat = (e) => {
                const head = e.target.closest('.pensamiento-cabecera-clickable');
                if (head) {
                    const wrap = head.nextElementSibling; const icon = head.querySelector('.toggle-icon');
                    const colapsado = wrap.classList.toggle('collapsed');
                    icon.className = `fas fa-chevron-${colapsado ? 'down' : 'up'} toggle-icon ${colapsado ? 'collapsed' : ''}`;
                    wrap.style.maxHeight = colapsado ? '0px' : wrap.scrollHeight + 'px'; return;
                }
                if (e.target.closest('.boton-copiar')) copiarAlPortapapeles(e.target.closest('.mensaje').querySelector('.burbuja-mensaje, .respuesta-ia').innerText);
                else if (e.target.closest('.boton-copiar-pensamiento')) copiarAlPortapapeles(e.target.closest('.pensamiento-container').querySelector('.contenido-pensamiento').innerText);
                else if (e.target.closest('.boton-voz')) leerTexto(e.target.closest('.mensaje').querySelector('.burbuja-mensaje, .respuesta-ia').innerText, e.target.closest('.boton-voz'));
                else if (e.target.closest('.contenedor-imagen-generada img')) mostrarModalImagen(e.target.closest('img').src);
            };

            const formatearBloquesCodigo = (el) => {
                el.querySelectorAll('pre').forEach(pre => {
                    if (pre.parentElement.classList.contains('bloque-codigo')) return;
                    const div = document.createElement('div'); div.className = 'bloque-codigo';
                    const lang = (pre.querySelector('code')?.className || '').match(/language-(\w+)/)?.[1] || 'Código';
                    div.innerHTML = `<div class="cabecera-codigo"><span class="lenguaje-codigo">${lang}</span><button class="boton-copiar-codigo"><i class="fas fa-copy"></i> Copiar</button></div><div class="contenedor-codigo"></div>`;
                    div.querySelector('.contenedor-codigo').appendChild(pre.cloneNode(true));
                    div.querySelector('.boton-copiar-codigo').onclick = function() { copiarAlPortapapeles(pre.innerText); this.innerHTML = '<i class="fas fa-check"></i> Copiado'; setTimeout(() => this.innerHTML = '<i class="fas fa-copy"></i> Copiar', 2000); };
                    pre.replaceWith(div);
                });
            };
            
            // Función nueva para formatear tablas estilo Gemini
            const formatearTablas = (contenedor) => {
                const tablas = contenedor.querySelectorAll('table');
                tablas.forEach(tabla => {
                    if (tabla.parentElement.classList.contains('chat-table-wrapper')) return;
                    
                    // Crear wrapper
                    const wrapper = document.createElement('div');
                    wrapper.className = 'chat-table-wrapper';
                    
                    // Clases a la tabla
                    tabla.classList.add('chat-table');
                    
                    // Insertar wrapper antes de la tabla y mover tabla dentro
                    tabla.parentNode.insertBefore(wrapper, tabla);
                    wrapper.appendChild(tabla);
                });
            };

            const reiniciarEntrada = () => { elementos.entradaUsuario.value = ''; archivosAdjuntos = []; elementos.contenedorAdjuntos.innerHTML = ''; elementos.contenedorAdjuntos.style.display = 'none'; autoAjustarTextarea(); };
            const gestionarSeleccionArchivo = (files) => { for (const f of files) { archivosAdjuntos.push({ file: f }); renderizarArchivoAdjunto(f); } elementos.inputImagen.value = ''; elementos.inputCamara.value = ''; elementos.inputArchivo.value = ''; };
            const renderizarArchivoAdjunto = (f) => {
                elementos.contenedorAdjuntos.style.display = 'flex'; const d = document.createElement('div'); d.className = 'adjunto-item';
                d.innerHTML = `<i class="fas ${f.type.startsWith('image') ? 'fa-image' : 'fa-file-alt'} icono-adjunto"></i><div class="detalles-adjunto"><div class="nombre-adjunto">${f.name}</div><div class="tamano-adjunto">${(f.size / 1024).toFixed(1)} KB</div></div><button class="boton-eliminar"><i class="fas fa-times"></i></button>`;
                d.querySelector('.boton-eliminar').onclick = () => { archivosAdjuntos = archivosAdjuntos.filter(a => a.file !== f); d.remove(); if (!archivosAdjuntos.length) elementos.contenedorAdjuntos.style.display = 'none'; };
                elementos.contenedorAdjuntos.appendChild(d);
            };
            
            const procesarArchivosAdjuntos = async () => {
                const res = []; for (const a of archivosAdjuntos) {
                    try { if (a.file.type.startsWith('image/')) res.push(`--- OCR: ${a.file.name} ---\n${await peticionOcrSpace(a.file)}`); else if (a.file.type.startsWith('text/')) res.push(`--- Archivo: ${a.file.name} ---\n${await a.file.text()}`); } catch { res.push(`[Error: ${a.file.name}]`); }
                } return res.join('\n\n');
            };
            
            const peticionOcrSpace = async (f) => { const fd = new FormData(); fd.append('file', f); fd.append('language', 'spa'); fd.append('apikey', CLAVE_API_OCR); fd.append('OCREngine', '2'); const r = await fetch('https://api.ocr.space/parse/image', { method: 'POST', body: fd }); const d = await r.json(); if (d.IsErroredOnProcessing) throw new Error(d.ErrorMessage); return d.ParsedResults?.[0]?.ParsedText || ''; };

            const iniciarReconocimientoVoz = () => {
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SR) { reconocimientoVoz = new SR(); reconocimientoVoz.lang = 'es-ES'; reconocimientoVoz.onstart = () => elementos.botonGrabar.classList.add('grabando'); reconocimientoVoz.onend = () => { estaGrabando = false; elementos.botonGrabar.classList.remove('grabando'); }; reconocimientoVoz.onresult = (e) => { elementos.entradaUsuario.value = e.results[0][0].transcript; ultimoMensajeFuePorVoz = true; gestionarEnvioMensaje(); }; } else elementos.botonGrabar.disabled = true;
            };
            const alternarGrabacion = () => { if (reconocimientoVoz) { estaGrabando = !estaGrabando; estaGrabando ? reconocimientoVoz.start() : reconocimientoVoz.stop(); } };
            const iniciarSintesisVoz = () => { const pop = () => elementos.selectorVoz.innerHTML = speechSynthesis.getVoices().filter(v => v.lang.startsWith('es')).map(v => `<option value="${v.name}">${v.name}</option>`).join(''); pop(); speechSynthesis.onvoiceschanged = pop; };
            const leerTexto = (t, b) => { if (sintesisVozActual && speechSynthesis.speaking) return detenerVoz(); detenerVoz(); sintesisVozActual = new SpeechSynthesisUtterance(t); const v = speechSynthesis.getVoices().find(vx => vx.name === elementos.selectorVoz.value); if (v) sintesisVozActual.voice = v; sintesisVozActual.onstart = () => { document.querySelectorAll('.boton-voz').forEach(bt => bt.innerHTML = '<i class="fas fa-volume-up"></i>'); if(b) b.innerHTML = '<i class="fas fa-stop"></i>'; }; sintesisVozActual.onend = () => { if(b) b.innerHTML = '<i class="fas fa-volume-up"></i>'; sintesisVozActual = null; }; speechSynthesis.speak(sintesisVozActual); };
            const detenerVoz = () => { speechSynthesis.cancel(); document.querySelectorAll('.boton-voz').forEach(b => b.innerHTML = '<i class="fas fa-volume-up"></i>'); sintesisVozActual = null; };

            const gestionarFocoInput = () => setTimeout(() => elementos.entradaWrapper.scrollIntoView({ behavior: 'smooth', block: 'end' }), 300);
            const autoAjustarTextarea = () => { elementos.entradaUsuario.style.height = 'auto'; elementos.entradaUsuario.style.height = `${elementos.entradaUsuario.scrollHeight}px`; };
            const gestionarScrollUsuario = () => { scrollAutomatico = (elementos.contenedorChat.scrollHeight - elementos.contenedorChat.scrollTop - elementos.contenedorChat.clientHeight) < 50; elementos.botonScrollFinal.classList.toggle('visible', !scrollAutomatico); };
            const irAlFinal = (f = false) => { if (scrollAutomatico || f) elementos.contenedorChat.scrollTop = elementos.contenedorChat.scrollHeight; };
            const alternarTema = () => { elementos.body.classList.toggle('tema-claro'); localStorage.setItem('theme', elementos.body.classList.contains('tema-claro') ? 'claro' : 'oscuro'); document.querySelector('#menu-tema i').className = `fas ${elementos.body.classList.contains('tema-claro') ? 'fa-moon' : 'fa-sun'}`; };
            
            const alternarModal = (mostrar, modal) => {
                modal.style.display = mostrar ? 'flex' : 'none';
                elementos.overlay.style.display = [elementos.modalOcr, elementos.modalModo, elementos.modalSuperIA, elementos.modalAyuda, elementos.modalImagen, elementos.modalMenuPrincipal].some(m => m.style.display === 'flex') ? 'block' : 'none';
                if (modal === elementos.modalOcr) elementos.botonMas.classList.toggle('modo-activo', mostrar);
            };
            
            const copiarAlPortapapeles = (t) => navigator.clipboard.writeText(t).then(() => { elementos.confirmacionCopia.classList.add('show'); setTimeout(() => elementos.confirmacionCopia.classList.remove('show'), 2000); });
            const alternarModoBusqueda = (f) => { modoBusqueda = typeof f === 'boolean' ? f : !modoBusqueda; elementos.botonBuscar.classList.toggle('modo-activo', modoBusqueda); };
            const establecerModoIA = (m) => {
                modoSuperIA = m === 'super'; modoMiniIA = m === 'mini';
                elementos.tituloModo.textContent = modoSuperIA ? 'SUPER MAR-IA' : (modoMiniIA ? 'Mar-IA mini' : 'Mar-IA');
                elementos.tituloModo.classList.toggle('super-ia-gradient', modoSuperIA); elementos.tituloModo.classList.toggle('mini-ia-gradient', modoMiniIA);
                if (elementos.modalModo.style.display === 'flex') alternarModal(false, elementos.modalModo);
                localStorage.setItem('modoIA', m);
                if (modoSuperIA && !localStorage.getItem('superIaModalVisto')) { alternarModal(true, elementos.modalSuperIA); localStorage.setItem('superIaModalVisto', 'true'); }
                if (m === 'mini') { elementos.modalMiniAviso.style.display = 'flex'; setTimeout(() => elementos.modalMiniAviso.style.display = 'none', 8000); }
            };
            
            const cargarEstado = () => { if (localStorage.getItem('theme') === 'claro') { elementos.body.classList.add('tema-claro'); document.querySelector('#menu-tema i').className = 'fas fa-moon'; } establecerModoIA(localStorage.getItem('modoIA') || 'normal'); };
            const mostrarIndicador = (t, i = 'dots') => { ocultarIndicador(); const d = document.createElement('div'); d.id = 'dynamic-indicator'; d.className = 'indicador-escribiendo'; d.innerHTML = `${i === 'brain' ? '<i class="fas fa-brain fa-beat"></i>' : i === 'bolt' ? '<i class="fas fa-bolt fa-beat"></i>' : '<div class="puntos"><span></span><span></span><span></span></div>'} <span>${t}</span>`; elementos.contenedorChat.appendChild(d); irAlFinal(); };
            const ocultarIndicador = () => document.getElementById('dynamic-indicator')?.remove();
            const mostrarIndicadorBusqueda = () => { const d = document.createElement('div'); d.className = 'mensaje mensaje-busqueda'; d.innerHTML = `<div class="burbuja-busqueda"><i class="fas fa-search"></i><span>Buscando en la web...</span></div>`; elementos.contenedorChat.appendChild(d); irAlFinal(); return d; };
            const ocultarIndicadorBusqueda = (i) => i?.remove();

            const realizarBusquedaEnTiempoReal = async (q) => {
                try {
                    const r = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(`https://api.duckduckgo.com/?q=${q}&format=json&no_html=1`)}`);
                    const d = await r.json(); const res = JSON.parse(d.contents); if (res.AbstractText) return { fuente: 'DuckDuckGo', contenido: res.AbstractText };
                } catch {}
                try {
                    const r = await fetch(`https://es.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(q)}`, { headers: {'Api-User-Agent': 'Mar-IA/1.0'} });
                    if (r.ok) { const d = await r.json(); if (d.extract) return { fuente: 'Wikipedia', contenido: d.extract }; }
                } catch {}
                return null;
            };
            
            const mostrarBotonCargando = () => { elementos.botonEnviar.classList.add('cargando'); elementos.botonEnviar.disabled = true; elementos.botonEnviar.innerHTML = '<div class="loader-dots"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></div>'; };
            const cambiarBotonAPausa = () => { estaGenerandoRespuesta = true; elementos.botonEnviar.classList.remove('cargando'); elementos.botonEnviar.disabled = false; elementos.botonEnviar.innerHTML = '<i class="fas fa-pause"></i>'; elementos.botonEnviar.classList.add('pausa'); };
            const restaurarBotonEnviar = () => { estaGenerandoRespuesta = false; elementos.botonEnviar.innerHTML = '<i class="fas fa-paper-plane"></i>'; elementos.botonEnviar.className = 'boton-input'; elementos.botonEnviar.disabled = false; };
            const pausarGeneracion = () => { cancelarProcesoCompleto = true; if (cancelarStreaming) cancelarStreaming(); restaurarBotonEnviar(); };

            const obtenerRespuestaBot = async (hist, hab) => streamContent({ model: "deepseek-chat", messages: hist, stream: true, temperature: 0.7, max_tokens: 2000 }, { url: 'https://api.deepseek.com/v1/chat/completions', key: API_KEYS.DEEPSEEK }, hab, 'Mar-IA está escribiendo...', 'dots');
            const obtenerRespuestaMini = async (hist, hab) => {
                cambiarBotonAPausa(); mostrarIndicador('Mar-IA mini está escribiendo...', 'bolt');
                const last = hist[hist.length - 1].content;
                try {
                    const c = new AbortController(); setTimeout(() => c.abort(), 2000);
                    const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEYS.GEMINI}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: "Eres Mar-IA mini. Responde breve (max 2 oraciones).\n\nConsulta: " + last }] }] }), signal: c.signal });
                    if (!r.ok) throw new Error(); const d = await r.json(); const txt = d.candidates?.[0]?.content?.parts?.[0]?.text; if (!txt) throw new Error();
                    historialChat.push({ role: "assistant", content: txt }); guardarMensajeEnHistorial('assistant', txt); ocultarIndicador(); const msg = agregarMensaje('bot', txt); if (hab) leerTexto(txt, msg.querySelector('.boton-voz'));
                } catch { await obtenerRespuestaMetaFallback(hist, hab); } finally { restaurarBotonEnviar(); }
            };
            const obtenerRespuestaMetaFallback = async (hist, hab) => streamContent({ model: "llama3-8b-8192", messages: hist, stream: true, max_tokens: 200, temperature: 0.8 }, { url: 'https://api.groq.com/openai/v1/chat/completions', key: API_KEYS.META }, hab, 'Mar-IA mini (Meta)...', 'bolt');

            const ejecutarFlujoSuperIA = async (hist, hab) => {
                const { contenidoPensamiento, wrapper } = crearContenedorPensamiento();
                const api = { url: 'https://api.deepseek.com/v1/chat/completions', key: API_KEYS.DEEPSEEK };
                const razonHist = [...hist]; const lastQ = razonHist.pop().content;
                razonHist.push({ role: "user", content: `Piensa paso a paso. Solicitud: "${lastQ}"` });
                
                await streamContent({ model: "deepseek-chat", messages: [{role: "user", content: "Di que estás razonando. Max 5 palabras."}], stream: true, max_tokens: 50 }, api, false, 'SUPER MAR-IA está razonando...', 'brain');
                const raz = await streamContent({ model: "deepseek-chat", messages: razonHist, stream: true, temperature: 0.3, max_tokens: 7000 }, api, false, '', '', {target: contenidoPensamiento, wrapper: wrapper}, true);
                
                if (cancelarProcesoCompleto || !raz) return restaurarBotonEnviar();

                const finalHist = [...hist, { role: "assistant", content: `Pensamiento: ${raz}` }, { role: "user", content: "Genera respuesta final detallada." }];
                const respFinal = await streamContent({ model: "deepseek-chat", messages: finalHist, stream: true, max_tokens: 7000, temperature: 0.7 }, api, hab, 'Finalizando respuesta...', 'brain');

                if (respFinal && !cancelarProcesoCompleto) {
                    const bots = document.querySelectorAll('.mensaje-bot');
                    if (bots.length >= 2) {
                        const finalMsg = bots[bots.length - 1]; const penMsg = bots[bots.length - 2];
                        const burbuja = finalMsg.querySelector('.respuesta-ia');
                        if (penMsg.querySelector('.pensamiento-container') && burbuja) {
                            burbuja.classList.add('respuesta-adjunta'); penMsg.appendChild(burbuja);
                            const ctrls = finalMsg.querySelector('.timestamp-container'); if (ctrls) penMsg.appendChild(ctrls);
                            finalMsg.remove();
                        }
                    }
                }
            };

            const streamContent = async (payload, cfg, hab, txtInd, icoInd, tgt = null, isThink = false) => {
                cambiarBotonAPausa(); if (txtInd) mostrarIndicador(txtInd, icoInd);
                let full = ""; let el, wrap;
                if (isThink && tgt) { el = tgt.target; wrap = tgt.wrapper; }
                else if (tgt) el = tgt;
                else { const m = agregarMensaje('bot', '', true); el = m.querySelector('.respuesta-ia'); }
                
                ocultarIndicador();
                try {
                    const r = await fetch(cfg.url, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${cfg.key}` }, body: JSON.stringify(payload) });
                    if (!r.ok) throw new Error();
                    const reader = r.body.getReader(); const dec = new TextDecoder();
                    cancelarStreaming = () => reader.cancel();
                    while (true) {
                        const { value, done } = await reader.read(); if (done) break;
                        const chunk = dec.decode(value, { stream: true });
                        chunk.split('\n').forEach(l => {
                            if (l.startsWith('data: ') && l !== 'data: [DONE]') {
                                try {
                                    const t = JSON.parse(l.slice(6)).choices[0]?.delta?.content || '';
                                    if (t) { full += t; el.innerHTML = marked.parse(full); if (isThink && wrap) wrap.style.maxHeight = wrap.scrollHeight + 'px'; irAlFinal(); }
                                } catch {}
                            }
                        });
                    }
                    if (!isThink) { formatearBloquesCodigo(el.parentElement); formatearTablas(el.parentElement); }
                    if (!isThink) { if (full.includes('[Imagen generada]')) { const d = full.match(/\[Imagen generada\] (.*)/)[1]; el.innerHTML = `<div class="contenedor-imagen-generada"><img src="${imagenGeneradaActual}" alt="${d}" style="max-width: 100%; border-radius: 1.5rem; cursor: zoom-in;"></div>`; } historialChat.push({ role: "assistant", content: full }); guardarMensajeEnHistorial('assistant', full); }
                    if (hab) leerTexto(el.innerText, el.closest('.mensaje')?.querySelector('.boton-voz'));
                    return full;
                } catch { if(!isThink) el.innerHTML = "Error de conexión."; return null; } finally { if (!isThink) restaurarBotonEnviar(); }
            };

            iniciar();
        });
        
        function abrirLiveModal() { document.getElementById("liveModal").classList.remove("oculto"); }
        document.getElementById("cerrarLiveModal").addEventListener("click", () => document.getElementById("liveModal").classList.add("oculto"));
        document.getElementById("liveModal").addEventListener("click", (e) => { if (e.target.id === "liveModal") document.getElementById("liveModal").classList.add("oculto"); });
    </script>
</body>
</html>
