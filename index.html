function toggleSpeech(button, text) {
    if (currentUtterance && isPlaying) {
        window.speechSynthesis.cancel();
        currentUtterance = null;
        isPlaying = false;
        button.innerHTML = '<i class="fas fa-volume-up"></i>';
        return;
    }
    
    if (currentUtterance && !isPlaying) {
        window.speechSynthesis.resume();
        button.innerHTML = '<i class="fas fa-pause"></i>';
        isPlaying = true;
        return;
    }

    if ('speechSynthesis' in window) {
        button.innerHTML = '<i class="fas fa-pause"></i>';
        currentUtterance = new SpeechSynthesisUtterance(text);
        currentUtterance.lang = 'es-ES';
        
        if (spanishFemaleVoice) {
            currentUtterance.voice = spanishFemaleVoice;
        }

        currentUtterance.onend = () => {
            button.innerHTML = '<i class="fas fa-volume-up"></i>';
            currentUtterance = null;
            isPlaying = false;
        };

        currentUtterance.onerror = () => {
            button.innerHTML = '<i class="fas fa-volume-up"></i>';
            currentUtterance = null;
            isPlaying = false;
        };

        currentUtterance.onpause = () => {
            button.innerHTML = '<i class="fas fa-play"></i>';
            isPlaying = false;
        };

        currentUtterance.onresume = () => {
            button.innerHTML = '<i class="fas fa-pause"></i>';
            isPlaying = true;
        };

        window.speechSynthesis.speak(currentUtterance);
        isPlaying = true;
    }
}