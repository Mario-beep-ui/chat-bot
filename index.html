<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUPER MAR-IA | Asistente Avanzado</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            font-size: 62.5%;
            --color-fondo: #121212;
            --color-contenedor: #1E1E1E;
            --color-texto: #E0E0E0;
            --fondo-burbuja-usuario: linear-gradient(135deg, #5A5A5A, #4A4A4A);
            --texto-burbuja-usuario: #FFFFFF;
            --fondo-burbuja-bot: #2C2C2C;
            --texto-burbuja-bot: #E0E0E0;
            --borde-burbuja-bot: rgba(255, 255, 255, 0.1);
            --fondo-entrada: #1E1E1E;
            --borde-superior-entrada: rgba(255, 255, 255, 0.1);
            --fondo-campo-entrada: #2C2C2C;
            --texto-entrada: #FFFFFF;
            --texto-placeholder: #A0A0A0;
            --fondo-boton-enviar: #8A2BE2;
            --texto-boton-enviar: white;
            --fondo-boton-accion: #2C2C2C;
            --texto-boton-accion: #E0E0E0;
            --fondo-boton-grabando: #E53935;
            --color-timestamp: #A0A0A0;
            --fondo-boton-control: #2C2C2C;
            --fondo-adjunto: #2C2C2C;
            --borde-adjunto: #444;
            --fondo-codigo: rgba(0,0,0,0.3);
            --borde-codigo: rgba(255,255,255,0.1);
            --fondo-boton-buscar-activo: #4CAF50;
            --fondo-pensamiento: #1a1a2e;
            --borde-pensamiento: #2d4263;
            --fondo-pensamiento-hover: #21213e;
            --color-destacado: #8A2BE2;
            --resaltado-pensamiento: rgba(138, 43, 226, 0.2);
            --fondo-modal-imagen: rgba(0,0,0,0.95);
            --color-mini: #FF9800;
            --fondo-generando-imagen: #8A2BE2;
        }
        body.tema-claro {
            --color-fondo: #F5F5F5;
            --color-contenedor: #FFFFFF;
            --color-texto: #333333;
            --fondo-burbuja-usuario: #8A2BE2;
            --fondo-burbuja-bot: #E9E9EB;
            --texto-burbuja-bot: #333333;
            --borde-burbuja-bot: #D1D1D1;
            --fondo-entrada: #FFFFFF;
            --borde-superior-entrada: #E0E0E0;
            --fondo-campo-entrada: #F0F0F0;
            --texto-entrada: #333333;
            --texto-placeholder: #666666;
            --fondo-boton-accion: #E9E9EB;
            --texto-boton-accion: #333333;
            --fondo-boton-grabando: #D32F2F;
            --color-timestamp: #666666;
            --fondo-boton-control: #F0F0F0;
            --fondo-adjunto: #F0F0F0;
            --borde-adjunto: #DDD;
            --fondo-codigo: rgba(0,0,0,0.05);
            --borde-codigo: rgba(0,0,0,0.1);
            --fondo-pensamiento: #eef5ff;
            --borde-pensamiento: #b1c8e4;
            --fondo-pensamiento-hover: #e4eef9;
            --color-destacado: #5e17eb;
            --resaltado-pensamiento: rgba(94, 23, 235, 0.1);
            --fondo-modal-imagen: rgba(255,255,255,0.98);
            --color-mini: #FF6F00;
            --fondo-generando-imagen: #5e17eb;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        html { height: 100%; }
        body { 
            height: 100dvh;
            background: var(--color-fondo); 
            color: var(--color-texto); 
            font-size: 1.6rem; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .contenedor {
            display: flex;
            flex-direction: column;
            width: 100%;
            background: var(--color-contenedor);
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }
        .cabecera { 
            flex-shrink: 0;
            padding: 1rem 1.5rem; 
            border-bottom: 1px solid var(--borde-superior-entrada); 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            z-index: 10;
        }
        .contenedor-chat { 
            flex-grow: 1;
            overflow-y: auto; 
            padding: 2rem; 
            display: flex; 
            flex-direction: column; 
            gap: 2rem; 
            scroll-behavior: smooth; 
            transition: transform 0.3s ease-in-out;
        }
        .contenedor-chat.desplazado {
            transform: translateX(320px);
        }
        .contenedor-entrada-wrapper { 
            flex-shrink: 0;
            padding: 1rem; 
            background: var(--color-contenedor);
            z-index: 10;
        }
        .cabecera .titulo { display: flex; align-items: center; gap: 1rem; }
        .cabecera .titulo h1 { font-size: 1.8rem; margin: 0; cursor: pointer; transition: all 0.3s; position: relative; color: var(--color-destacado); }
        .super-ia-gradient { background: linear-gradient(90deg, #8A2BE2, #FFD700, #87CEEB); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; -webkit-text-fill-color: transparent; animation: gradient-animation 5s ease-infinite; background-size: 200% 200%; }
        .mini-ia-gradient { background: linear-gradient(90deg, #FF9800, #FFEB3B, #FF9800); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; -webkit-text-fill-color: transparent; animation: gradient-animation 3s ease-infinite; background-size: 200% 200%; }
        @keyframes gradient-animation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .cabecera .titulo i { color: var(--color-destacado); font-size: 2rem; }
        .cabecera .subtitle { font-size: 1.2rem; opacity: 0.8; color: #aaa; margin-top: 0.2rem; }
        .controles-cabecera { display: flex; align-items: center; gap: 1rem; }
        .boton-control { background: var(--fondo-boton-control); border: none; font-size: 1.8rem; cursor: pointer; color: var(--color-texto); width: 4rem; height: 4rem; border-radius: 50%; display: flex; justify-content: center; align-items: center; transition: background 0.2s; }
        .boton-control:hover { background: var(--fondo-boton-accion); }
        .selector-voz-container { position: relative; }
        #selector-voz { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .mensaje { display: flex; flex-direction: column; max-width: 90%; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(1rem); } to { opacity: 1; transform: translateY(0); } }
        .mensaje-usuario { align-self: flex-end; align-items: flex-end; }
        .mensaje-bot { align-self: flex-start; align-items: flex-start; }
        .burbuja-mensaje { 
            padding: 1.2rem 1.8rem; 
            border-radius: 1.8rem; 
            line-height: 1.6; 
            word-wrap: break-word; 
            max-width: 100%; 
            height: auto;
        }
        .burbuja-usuario { background: var(--fondo-burbuja-usuario); color: var(--texto-burbuja-usuario); border-bottom-right-radius: 0.5rem; }
        .burbuja-bot { background: var(--fondo-burbuja-bot); color: var(--texto-burbuja-bot); border: 1px solid var(--borde-burbuja-bot); border-bottom-left-radius: 0.5rem; }
        .pensamiento-container { 
            background: var(--fondo-pensamiento); 
            border: 1px solid var(--borde-pensamiento); 
            border-radius: 1.2rem; 
            animation: slideIn 0.4s ease-out; 
            overflow: hidden; 
            width: 100%;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .pensamiento-cabecera-clickable { display: flex; justify-content: space-between; align-items: center; padding: 1.2rem 1.5rem; cursor: pointer; transition: background-color 0.2s; }
        .pensamiento-cabecera-clickable:hover { background-color: var(--fondo-pensamiento-hover); }
        .pensamiento-titulo { font-weight: 600; color: var(--color-texto); display: flex; align-items: center; gap: 1rem; }
        .pensamiento-titulo i { color: var(--color-destacado); }
        .pensamiento-controles-cabecera { display: flex; align-items: center; gap: 1.5rem; }
        .tiempo-pensamiento { font-size: 1.2rem; color: var(--color-timestamp); }
        .toggle-icon { font-size: 2rem; color: var(--color-timestamp); transition: transform 0.3s ease; }
        .toggle-icon.collapsed { transform: rotate(-180deg); }
        .pensamiento-contenido-wrapper { 
            overflow: hidden; 
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out; 
            max-height: 2000px;
        }
        .pensamiento-contenido-wrapper.collapsed { max-height: 0; padding-top: 0; padding-bottom: 0; border-top: none; }
        .contenido-pensamiento { 
            font-size: 1.4rem; 
            line-height: 1.7; 
            padding: 1.5rem; 
            border-top: 1px solid var(--borde-pensamiento); 
            background: var(--resaltado-pensamiento); 
            overflow-y: auto;
            max-height: 70vh;
        }
        .pensamiento-acciones { display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: flex-end; padding: 0 1.5rem 1.5rem; }
        .boton-pensamiento { background: rgba(255,255,255,0.05); border: 1px solid var(--borde-pensamiento); border-radius: 0.8rem; padding: 0.5rem 1rem; color: var(--color-texto); cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s; font-size: 1.3rem; }
        .boton-pensamiento:hover { background: rgba(255,255,255,0.1); }
        .bloque-codigo { position: relative; background: var(--fondo-codigo); border: 1px solid var(--borde-codigo); border-radius: 0.8rem; overflow: hidden; margin: 1.2rem 0; max-width: 100%; }
        .cabecera-codigo { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 1.2rem; background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--borde-codigo); }
        .lenguaje-codigo { font-size: 1.3rem; font-weight: 500; color: #aaa; }
        .boton-copiar-codigo { background: transparent; border: none; color: var(--color-texto); cursor: pointer; display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.8rem; border-radius: 0.4rem; font-size: 1.3rem; transition: all 0.2s; }
        .boton-copiar-codigo:hover { background: rgba(255,255,255,0.1); }
        .boton-copiar-codigo.copiado { color: #4CAF50; }
        .contenedor-codigo { overflow-x: auto; max-width: 100%; }
        .contenedor-codigo pre { margin: 0; padding: 1.5rem; font-family: 'Courier New', monospace; font-size: 1.4rem; }
        .timestamp-container { display: flex; align-items: center; gap: 0.8rem; margin-top: 0.8rem; }
        .timestamp { font-size: 1.2rem; color: var(--color-timestamp); }
        .boton-accion-mensaje { background: none; border: none; width: 2.8rem; height: 2.8rem; border-radius: 50%; cursor: pointer; font-size: 1.4rem; display: flex; justify-content: center; align-items: center; color: var(--color-timestamp); transition: background 0.2s; }
        .boton-accion-mensaje:hover { background: rgba(255,255,255,0.1); }
        .contenedor-entrada { 
            display: flex; 
            flex-direction: column; 
            gap: 1rem; 
            width: 100%; 
            background-color: var(--fondo-campo-entrada); 
            border: 1px solid var(--borde-adjunto); 
            border-radius: 2.4rem; 
            padding: 1rem; 
            transition: border-color 0.3s;
        }
        .contenedor-entrada:focus-within { border-color: var(--color-destacado); }
        .contenedor-adjuntos { display: none; overflow-x: auto; overflow-y: hidden; white-space: nowrap; padding-bottom: 1rem; scrollbar-width: thin; border-bottom: 1px solid var(--borde-adjunto); margin-bottom: 0.5rem;}
        .adjunto-item { display: inline-flex; align-items: center; gap: 0.8rem; background: var(--fondo-adjunto); border: 1px solid var(--borde-adjunto); border-radius: 1.2rem; padding: 0.8rem 1.2rem; max-width: 22rem; margin-right: 1rem; }
        .icono-adjunto { font-size: 2rem; color: var(--color-destacado); }
        .detalles-adjunto { display: flex; flex-direction: column; min-width: 0; }
        .nombre-adjunto { font-size: 1.3rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tamano-adjunto { font-size: 1.1rem; color: var(--color-timestamp); }
        .boton-eliminar { background: transparent; border: none; border-radius: 50%; width: 2.4rem; height: 2.4rem; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #aaa; transition: all 0.2s; }
        .boton-eliminar:hover { color: #E53935; background: rgba(255, 0, 0, 0.1); }
        #entrada-usuario { 
            width: 100%; 
            border: none; 
            background: transparent; 
            color: var(--texto-entrada); 
            font-size: 1.6rem; 
            outline: none; 
            resize: none; 
            max-height: 15rem; 
            overflow-y: auto; 
            
        }
        .input-area-botones {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 0.5rem;
        }
        .boton-input { 
            background: var(--fondo-boton-accion); 
            color: var(--texto-boton-accion); 
            border: 2px solid transparent; 
            width: 4.8rem; 
            height: 4.8rem; 
            border-radius: 50%; 
            cursor: pointer; 
            font-size: 2rem; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            transition: all 0.2s; 
            flex-shrink: 0; 
        }
        .boton-input:hover { transform: scale(1.05); }
        #boton-enviar { background: var(--fondo-boton-enviar); color: var(--texto-boton-enviar); border-color: transparent; }
        #boton-enviar.pausa { 
            background: #ff9800; 
            animation: pulsate 1.5s infinite; 
        }
        #boton-grabar.grabando { 
            background: var(--fondo-boton-grabando); 
            animation: pulsate 1.5s infinite; 
            border-color: var(--color-destacado);
        }
        .boton-input.modo-activo {
            border-color: var(--color-destacado);
            background: var(--fondo-boton-accion) !important;
            animation: none !important;
        }
        @keyframes pulsate { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .indicador-escribiendo { display: flex; align-items: center; gap: 1rem; padding: 1rem 1.5rem; background: var(--fondo-burbuja-bot); border-radius: 1.8rem; width: fit-content; align-self: flex-start; animation: fadeIn 0.3s ease; }
        .indicador-escribiendo .puntos span { height: 0.8rem; width: 0.8rem; background: var(--color-timestamp); border-radius: 50%; display: inline-block; margin: 0 0.2rem; animation: bounce 1.3s infinite; }
        .indicador-escribiendo .puntos span:nth-child(2) { animation-delay: 0.2s; }
        .indicador-escribiendo .puntos span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-0.5rem); } }
        .fa-beat { animation: fa-beat 1.5s ease-in-out infinite; }
        @keyframes fa-beat { 0%, 100% { transform: scale(1); opacity: 0.7; } 50% { transform: scale(1.15); opacity: 1; } }
        .modal-ocr { position: fixed; bottom: 10rem; right: 2rem; background: var(--fondo-entrada); border-radius: 1.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.3); padding: 1rem; display: none; flex-direction: column; gap: 1rem; z-index: 2000; border: 1px solid var(--borde-superior-entrada); }
        .opcion-ocr { background: var(--fondo-campo-entrada); color: var(--texto-entrada); border: none; border-radius: 1.2rem; padding: 1.2rem 1.5rem; display: flex; align-items: center; gap: 1.2rem; cursor: pointer; transition: all 0.2s; font-weight: 500; }
        .opcion-ocr:hover { background: var(--color-destacado); color: white; }
        .opcion-ocr i { font-size: 1.8rem; }
        .modal-modo { position: fixed; top: 6rem; left: 50%; transform: translateX(-50%); background: var(--fondo-entrada); border-radius: 1.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.3); padding: 1.5rem; display: none; flex-direction: column; gap: 1rem; z-index: 2000; width: 28rem; border: 1px solid var(--borde-superior-entrada); }
        .opcion-modo { background: var(--fondo-campo-entrada); color: var(--texto-entrada); border: none; border-radius: 1.2rem; padding: 1.5rem; display: flex; flex-direction: column; gap: 0.8rem; cursor: pointer; transition: all 0.2s; }
        .opcion-modo:hover { background: var(--color-destacado); color: white; }
        .opcion-modo-titulo { font-weight: 600; font-size: 1.6rem; display: flex; align-items: center; gap: 1rem; }
        .opcion-modo-desc { font-size: 1.3rem; opacity: 0.9; line-height: 1.5; }
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1500; display: none; }
        .copy-confirmation { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.8); color: white; padding: 1rem 2rem; border-radius: 0.5rem; font-size: 1.4rem; opacity: 0; transition: opacity 0.3s; z-index: 1000; pointer-events: none; }
        .copy-confirmation.show { opacity: 1; }
        input[type="file"] { display: none; }
        .modal-super-ia { position: fixed; top: 2rem; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); color: white; border-radius: 1.5rem; padding: 2rem; display: none; flex-direction: column; z-index: 2000; width: 90%; max-width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); animation: fadeInDown 0.5s ease-out; }
        @keyframes fadeInDown { from { opacity: 0; transform: translate(-50%, -20px); } to { opacity: 1; transform: translate(-50%, 0); } }
        .modal-super-ia-contenido { position: relative; }
        .cerrar-modal-super-ia { position: absolute; top: -1.5rem; right: -1rem; background: rgba(255,255,255,0.2); border: none; width: 3rem; height: 3rem; border-radius: 50%; font-size: 2.5rem; color: white; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: all 0.3s; }
        .cerrar-modal-super-ia:hover { background: rgba(255,255,255,0.3); transform: scale(1.1); }
        .modal-super-ia h3 { margin-top: 0; font-size: 2rem; margin-bottom: 1rem; text-align: center; }
        .modal-super-ia p { font-size: 1.6rem; line-height: 1.5; margin: 0 0 1.5rem 0; }
        .comparacion-modos { display: flex; gap: 1.5rem; margin-top: 1.5rem; }
        .modo-card { flex: 1; background: rgba(255,255,255,0.1); border-radius: 1rem; padding: 1.5rem; text-align: center; }
        .modo-card h4 { margin-top: 0; font-size: 1.8rem; margin-bottom: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.8rem; }
        .modo-card ul { text-align: left; padding-left: 1.5rem; margin-bottom: 0; }
        .modo-card li { margin-bottom: 0.8rem; font-size: 1.4rem; }
        .modo-card.super { border: 2px solid #FFD700; position: relative; overflow: hidden; }
        .modo-card.super::after { content: 'RECOMENDADO'; position: absolute; top: 0; right: 0; background: #FFD700; color: #000; font-weight: bold; font-size: 1.1rem; padding: 0.3rem 1rem; border-radius: 0 0 0 1rem; transform: translate(0.5rem, -0.5rem) rotate(25deg); }
        .boton-entendido { background: rgba(255,255,255,0.2); border: 2px solid white; color: white; border-radius: 3rem; padding: 1rem 2rem; font-size: 1.6rem; font-weight: bold; cursor: pointer; transition: all 0.3s; margin-top: 1.5rem; width: 100%; }
        .boton-entendido:hover { background: rgba(255,255,255,0.3); transform: translateY(-3px); }
        .modal-ayuda { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--fondo-entrada); border-radius: 1.5rem; box-shadow: 0 15px 30px rgba(0,0,0,0.3); padding: 2rem; display: none; flex-direction: column; z-index: 2000; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; border: 1px solid var(--borde-superior-entrada); }
        .modal-ayuda-contenido { position: relative; }
        .cerrar-modal-ayuda { position: absolute; top: -1.5rem; right: -1rem; background: var(--fondo-boton-control); border: none; width: 3rem; height: 3rem; border-radius: 50%; font-size: 2.5rem; color: var(--color-texto); cursor: pointer; display: flex; justify-content: center; align-items: center; transition: all 0.3s; }
        .cerrar-modal-ayuda:hover { background: var(--fondo-boton-accion); transform: scale(1.1); }
        .modal-ayuda h3 { margin-top: 0; font-size: 2.2rem; margin-bottom: 2rem; text-align: center; color: var(--color-destacado); }
        .seccion-ayuda { margin-bottom: 2rem; }
        .seccion-ayuda h4 { font-size: 1.8rem; margin-bottom: 1rem; color: var(--color-destacado); display: flex; align-items: center; gap: 1rem; }
        .seccion-ayuda ul { padding-left: 2rem; }
        .seccion-ayuda li { margin-bottom: 1rem; font-size: 1.6rem; line-height: 1.5; }
        .icono-ayuda { background: var(--fondo-boton-enviar); width: 3.5rem; height: 3.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; color: white; }
        .item-ayuda { display: flex; align-items: flex-start; gap: 1.5rem; margin-bottom: 1.5rem; }
        .item-ayuda .icono-ayuda { flex-shrink: 0; }
        .item-ayuda .contenido-ayuda { flex: 1; }
        .item-ayuda .titulo-item { font-weight: bold; margin-bottom: 0.5rem; font-size: 1.6rem; }
        .item-ayuda .descripcion-item { font-size: 1.5rem; }
        .boton-ayuda { background: var(--fondo-boton-enviar); color: white; border: none; border-radius: 3rem; padding: 1rem 2rem; font-size: 1.6rem; font-weight: bold; cursor: pointer; transition: all 0.3s; margin-top: 1rem; display: flex; align-items: center; justify-content: center; gap: 1rem; }
        .boton-ayuda:hover { background: #6d1dc4; transform: translateY(-3px); }
        .modal-imagen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--fondo-modal-imagen);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            display: none;
        }
        .contenido-modal-imagen {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-imagen img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 1rem;
        }
        .botones-modal-imagen {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 15px;
        }
        .boton-modal-imagen {
            background: rgba(255,255,255,0.2);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            font-size: 24px;
        }
        .boton-modal-imagen:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        .boton-generar-imagen {
            background: var(--fondo-boton-accion) ;
            color: white;
            border: none;
            border-radius: 50%;
            width: 4.8rem;
            height: 4.8rem;
            cursor: pointer;
            font-size: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .boton-generar-imagen:hover {
            transform: scale(1.05);
            background: #6d1dc4;
        }
        .boton-generar-imagen.modo-activo {
            border-color: var(--color-destacado);
            background: var(--fondo-boton-enviar);
            animation: none !important;
        }
        .indicador-generando-imagen {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            background: var(--fondo-generando-imagen);
            color: white;
            border-radius: 1.8rem;
            width: fit-content;
            align-self: flex-start;
            animation: fadeIn 0.3s ease;
        }
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: var(--color-destacado);
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .sugerencia-ayuda {
            background: rgba(138, 43, 226, 0.1);
            border-left: 4px solid var(--color-destacado);
            padding: 1rem;
            border-radius: 0 0.5rem 0.5rem 0;
            margin-top: 1rem;
            font-style: italic;
        }
        .modal-mini-aviso {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #FFC107;
            color: #000;
            padding: 1.2rem 2rem;
            border-radius: 1rem;
            z-index: 5000;
            display: none;
            align-items: center;
            gap: 1rem;
            font-size: 1.4rem;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            animation: slideDownFadeIn 0.5s ease-out forwards;
        }
        @keyframes slideDownFadeIn {
            from { opacity: 0; transform: translate(-50%, -100%); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
        @keyframes slideUpFadeOut {
            from { opacity: 1; transform: translate(-50%, 0); }
            to { opacity: 0; transform: translate(-50%, -100%); }
        }
        #boton-enviar.cargando .fa-paper-plane { display: none; }
        #boton-enviar.cargando {
            background: var(--fondo-boton-enviar);
        }
        .loader-dots {
            width: 2.4rem;
            height: 2.4rem;
            position: relative;
        }
        .loader-dots span {
            position: absolute;
            width: 0.7rem;
            height: 0.7rem;
            background-color: white;
            border-radius: 50%;
            animation: loader-anim 1.2s infinite;
        }
        .loader-dots span:nth-child(1) { top: 0; left: 50%; transform: translateX(-50%); animation-delay: -1.05s; }
        .loader-dots span:nth-child(2) { top: 15%; right: 15%; animation-delay: -0.9s; }
        .loader-dots span:nth-child(3) { top: 50%; right: 0; transform: translateY(-50%); animation-delay: -0.75s; }
        .loader-dots span:nth-child(4) { bottom: 15%; right: 15%; animation-delay: -0.6s; }
        .loader-dots span:nth-child(5) { bottom: 0; left: 50%; transform: translateX(-50%); animation-delay: -0.45s; }
        .loader-dots span:nth-child(6) { bottom: 15%; left: 15%; animation-delay: -0.3s; }
        .loader-dots span:nth-child(7) { top: 50%; left: 0; transform: translateY(-50%); animation-delay: -0.15s; }
        .loader-dots span:nth-child(8) { top: 15%; left: 15%; animation-delay: 0s; }
        @keyframes loader-anim {
            0%, 100% {
                transform: scale(0.2);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .panel-historial {
            position: fixed;
            top: 0;
            left: -350px;
            width: 320px;
            height: 100vh;
            background: var(--color-contenedor);
            z-index: 2000;
            overflow-y: auto;
            transition: transform 0.3s ease-in-out;
            box-shadow: 5px 0 15px rgba(0,0,0,0.2);
            border-right: 1px solid var(--borde-superior-entrada);
            border-top-right-radius: 16px;
            border-bottom-right-radius: 16px;
        }

        .panel-historial.abierto {
            transform: translateX(350px);
        }

        .cabecera-panel-historial {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--borde-superior-entrada);
            position: sticky;
            top: 0;
            background: var(--color-contenedor);
            z-index: 10;
            border-top-right-radius: 16px;
        }

        .cabecera-panel-historial h2 {
            margin: 0;
            font-size: 1.8rem;
            color: var(--color-destacado);
        }

        .boton-cerrar-historial {
            background: transparent;
            border: none;
            color: var(--color-texto);
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .boton-cerrar-historial:hover {
            background: var(--fondo-pensamiento);
            color: var(--color-destacado);
        }

        .buscar-historial {
            padding: 15px 20px;
            border-bottom: 1px solid var(--borde-superior-entrada);
        }

        .input-buscar-historial {
            width: 100%;
            padding: 12px 15px;
            background: var(--fondo-campo-entrada);
            border: 1px solid var(--borde-adjunto);
            border-radius: 24px;
            color: var(--texto-entrada);
            font-size: 1.4rem;
        }

        .input-buscar-historial::placeholder {
            color: var(--texto-placeholder);
        }

        .lista-historial {
            padding: 10px 0;
        }

        .item-historial {
            padding: 12px 20px;
            border-bottom: 1px solid var(--borde-superior-entrada);
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            flex-direction: column;
            border-radius: 0 12px 12px 0;
        }

        .item-historial:hover {
            background: var(--fondo-pensamiento);
        }

        .item-historial.seleccionado {
            background: var(--resaltado-pensamiento);
            border-left: 3px solid var(--color-destacado);
        }

        .titulo-conversacion {
            font-weight: 500;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 1.6rem;
        }

        .fecha-conversacion {
            font-size: 1.2rem;
            color: var(--color-timestamp);
        }

        .preview-conversacion {
            font-size: 1.3rem;
            margin-top: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--color-timestamp);
        }

        .acciones-item-historial {
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
            gap: 10px;
        }

        .boton-accion-item {
            background: transparent;
            border: none;
            color: var(--color-timestamp);
            font-size: 1.4rem;
            cursor: pointer;
            transition: all 0.2s;
            padding: 5px;
            border-radius: 4px;
        }

        .boton-accion-item:hover {
            color: var(--color-destacado);
            background: rgba(138, 43, 226, 0.1);
        }

        .boton-nueva-conversacion {
            display: block;
            width: calc(100% - 40px);
            margin: 15px 20px;
            padding: 12px;
            background: var(--fondo-boton-enviar);
            color: white;
            border: none;
            border-radius: 24px;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .boton-nueva-conversacion:hover {
            background: #6d1dc4;
            transform: translateY(-2px);
        }

        .sin-conversaciones {
            text-align: center;
            padding: 30px 20px;
            color: var(--color-timestamp);
            font-style: italic;
        }

        .boton-menu-historial {
            position: relative;
        }

        .contador-historial {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--fondo-boton-grabando);
            color: white;
            font-size: 1rem;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .overlay-historial {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1500;
            display: none;
        }

        @media (max-width: 768px) {
            .panel-historial {
                width: 90%;
                left: 0; 
                transform: translateX(-100%); 
                border-radius: 0 24px 24px 0; 
            }
            
            .panel-historial.abierto {
                transform: translateX(0); 
            }
            
            .contenedor-chat.desplazado {
                transform: translateX(90%); 
            }
            
            .cabecera-panel-historial {
                padding: 15px;
            }
            
            .cabecera-panel-historial h2 {
                font-size: 1.7rem;
            }
            
            .buscar-historial {
                padding: 12px 15px;
            }
            
            .input-buscar-historial {
                padding: 12px;
                font-size: 1.5rem;
            }
            
            .item-historial {
                padding: 12px 15px;
                border-radius: 0 10px 10px 0;
            }
            
            .titulo-conversacion {
                font-size: 1.6rem;
            }
            
            .fecha-conversacion, 
            .preview-conversacion {
                font-size: 1.4rem;
            }
            
            .boton-accion-item {
                font-size: 1.6rem;
                padding: 6px;
            }
            
            .boton-nueva-conversacion {
                padding: 14px;
                font-size: 1.6rem;
                margin: 15px 20px;
            }
        }

        @media (max-width: 480px) {
            .panel-historial {
                width: 95%;
            }
            
            .panel-historial.abierto {
                transform: translateX(0); 
            }
            
            .contenedor-chat.desplazado {
                transform: translateX(95%); 
            }
            
            .cabecera-panel-historial {
                padding: 12px 15px;
            }
            
            .cabecera-panel-historial h2 {
                font-size: 1.6rem;
            }
            
            .item-historial {
                padding: 10px 12px;
                border-radius: 0 8px 8px 0;
            }
            
            .titulo-conversacion {
                font-size: 1.5rem;
            }
            
            .preview-conversacion {
                font-size: 1.3rem;
            }
            
            .boton-nueva-conversacion {
                padding: 12px;
                font-size: 1.5rem;
            }
        }
        
        .boton-nueva-conversacion:hover {
            background: #6d1dc4;
            transform: translateY(-2px);
        }
        
        .sin-conversaciones {
            text-align: center;
            padding: 30px 20px;
            color: var(--color-timestamp);
            font-style: italic;
        }
        
        .boton-menu-historial {
            position: relative;
        }
        
        .contador-historial {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--fondo-boton-grabando);
            color: white;
            font-size: 1rem;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .overlay-historial {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1500;
            display: none;
        }
    </style>
</head>
<body>
    <div class="modal-mini-aviso" id="modal-mini-aviso">
        <i class="fas fa-exclamation-triangle"></i>
        <span>Este modo (Mar-IA mini) está en desarrollo y puede presentar errores.</span>
    </div>
    
    <div class="panel-historial" id="panel-historial">
        <div class="cabecera-panel-historial">
            <h2><i class="fas fa-history"></i> Historial</h2>
            <button class="boton-cerrar-historial" id="boton-cerrar-historial">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="buscar-historial">
            <input type="text" class="input-buscar-historial" id="input-buscar-historial" placeholder="Buscar conversación...">
        </div>

        <button class="boton-nueva-conversacion" id="boton-nueva-conversacion">
            <i class="fas fa-plus"></i> Nueva conversación
        </button>
        
        <div class="lista-historial" id="lista-historial">
        </div>
    </div>
    
    <div class="overlay-historial" id="overlay-historial"></div>
    
    <div class="contenedor">
        <header class="cabecera">
            <div class="titulo">
                <i class="fas fa-robot"></i>
                <div>
                    <h1 id="titulo-modo">Mar-IA</h1>
                    <div class="subtitle">by Mario Vazquez</div>
                </div>
            </div>
            <div class="controles-cabecera">
                <button id="boton-historial" class="boton-control boton-menu-historial" aria-label="Historial de conversaciones" title="Historial de conversaciones">
                    <i class="fas fa-history"></i>
                    <span class="contador-historial" id="contador-historial">0</span>
                </button>
                
                <button id="boton-ayuda" class="boton-control" aria-label="Ayuda" title="Ayuda">
                    <i class="fas fa-question-circle"></i>
                </button>
                <div class="selector-voz-container boton-control">
                    <i class="fas fa-language"></i>
                    <select id="selector-voz" aria-label="Seleccionar voz de la IA"></select>
                </div>
                <button id="alternador-tema" class="boton-control" aria-label="Alternar tema">
                    <i class="fas fa-sun"></i>
                </button>
            </div>
        </header>

        <main class="contenedor-chat" id="contenedor-chat"></main>

        <div class="contenedor-entrada-wrapper" id="contenedor-entrada-wrapper">
            <div class="contenedor-entrada">
                <div class="contenedor-adjuntos" id="contenedor-adjuntos"></div>
                <textarea id="entrada-usuario" placeholder="Pregúntale a Mar-IA..." rows="1"></textarea>
                <div class="input-area-botones">
                    <button id="boton-mas" class="boton-input" title="Adjuntar archivo"><i class="fas fa-plus"></i></button>
                    <button id="boton-buscar" class="boton-input" title="Buscar en internet"><i class="fas fa-search"></i></button>
                    <button id="boton-grabar" class="boton-input" title="Grabar voz"><i class="fas fa-microphone"></i></button>
                    <button id="boton-generar-imagen" class="boton-generar-imagen" title="Modo Picasso (generar imagen)"><i class="fas fa-paint-brush"></i></button>
                    <button id="boton-enviar" class="boton-input" title="Enviar mensaje"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="input-imagen" accept="image/*" multiple>
    <input type="file" id="input-camara" accept="image/*" capture="camera">
    <input type="file" id="input-archivo" multiple>

    <div class="modal-imagen" id="modal-imagen">
        <div class="contenido-modal-imagen">
            <div class="botones-modal-imagen">
                <button class="boton-modal-imagen" id="descargar-imagen" title="Descargar imagen"><i class="fas fa-download"></i></button>
                <button class="boton-modal-imagen" id="cerrar-modal-imagen" title="Cerrar"><i class="fas fa-times"></i></button>
            </div>
            <img id="imagen-ampliada" src="" alt="Imagen generada por Mar-IA">
        </div>
    </div>
    
    <div class="modal-ocr" id="modal-ocr">
        <button class="opcion-ocr" id="tomar-foto"><i class="fas fa-camera"></i> Tomar foto</button>
        <button class="opcion-ocr" id="elegir-galeria"><i class="fas fa-images"></i> Elegir de galería</button>
        <button class="opcion-ocr" id="elegir-archivo"><i class="fas fa-file-alt"></i> Subir archivo</button>
        <button class="opcion-ocr" id="activar-busqueda-modal"><i class="fas fa-search"></i> Buscar en internet</button>
    </div>
    
    <div class="modal-modo" id="modal-modo">
        <div class="opcion-modo" data-modo="normal">
            <div class="opcion-modo-titulo"><i class="fas fa-comment-alt"></i><span>Mar-IA</span></div>
            <div class="opcion-modo-desc">Respuesta directa y rápida.</div>
        </div>
        <div class="opcion-modo" data-modo="super">
            <div class="opcion-modo-titulo"><i class="fas fa-brain"></i><span>SUPER MAR-IA</span></div>
            <div class="opcion-modo-desc">Usa el modelo de razonamiento avanzado para respuestas profundas.</div>
        </div>
        <div class="opcion-modo" data-modo="mini">
            <div class="opcion-modo-titulo"><i class="fas fa-bolt"></i><span>Mar-IA mini</span></div>
            <div class="opcion-modo-desc">Respuestas ultra rápidas y breves, ideal para consultas simples.</div>
        </div>
    </div>
    
    <div class="modal-super-ia" id="modal-super-ia">
        <div class="modal-super-ia-contenido">
            <button class="cerrar-modal-super-ia" id="cerrar-modal-super-ia">&times;</button>
            <h3><i class="fas fa-crown"></i> Modo SUPER MAR-IA Activado</h3>
            <p>Este modo es más avanzado y utiliza un modelo de razonamiento profundo para analizar tus preguntas y generar respuestas de mayor calidad.</p>
            <div class="comparacion-modos">
                <div class="modo-card">
                    <h4><i class="fas fa-comment-alt"></i> Mar-IA</h4>
                    <ul><li>Respuestas rápidas</li><li>Ideal para consultas simples</li><li>Menor consumo de recursos</li><li>Respuestas directas</li></ul>
                </div>
                <div class="modo-card super">
                    <h4><i class="fas fa-brain"></i> SUPER MAR-IA</h4>
                    <ul><li>Respuestas más inteligentes</li><li>Análisis profundo de problemas</li><li>Mayor precisión en respuestas</li><li>Capacidad de razonamiento</li><li>Procesamiento más lento</li></ul>
                </div>
            </div>
            <button class="boton-entendido" id="boton-entendido">¡Entendido! Empezar a usar</button>
        </div>
    </div>
    
    <div class="modal-ayuda" id="modal-ayuda">
        <div class="modal-ayuda-contenido">
            <button class="cerrar-modal-ayuda" id="cerrar-modal-ayuda">&times;</button>
            <h3><i class="fas fa-question-circle"></i> Guía de Ayuda</h3>
            <div class="seccion-ayuda">
                <h4><i class="fas fa-exchange-alt"></i> Cambiar entre modos</h4>
                <ul><li>Para cambiar entre los modos Mar-IA, SUPER MAR-IA y Mar-IA mini, haz clic en el título principal en la parte superior.</li><li>Se abrirá un menú donde podrás seleccionar el modo deseado.</li><li>El modo SUPER MAR-IA es más lento pero ofrece respuestas más inteligentes mediante un análisis profundo.</li><li>El modo Mar-IA mini ofrece respuestas ultra rápidas y breves.</li></ul>
            </div>
            <div class="seccion-ayuda">
                <h4><i class="fas fa-sliders-h"></i> Funciones de los controles</h4>
                <div class="item-ayuda"><div class="icono-ayuda"><i class="fas fa-plus"></i></div><div class="contenido-ayuda"><div class="titulo-item">Adjuntar archivos</div><div class="descripcion-item">Permite adjuntar imágenes, documentos u otros archivos para procesarlos con OCR o análisis de texto.</div></div></div>
                <div class="item-ayuda"><div class="icono-ayuda"><i class="fas fa-search"></i></div><div class="contenido-ayuda"><div class="titulo-item">Buscar en internet</div><div class="descripcion-item">Activa el modo de búsqueda para que Mar-IA busque información en internet antes de responder.</div></div></div>
                <div class="item-ayuda"><div class="icono-ayuda"><i class="fas fa-microphone"></i></div><div class="contenido-ayuda"><div class="titulo-item">Grabar voz</div><div class="descripcion-item">Permite dictar tu mensaje mediante reconocimiento de voz.</div></div></div>
                <div class="item-ayuda"><div class="icono-ayuda"><i class="fas fa-language"></i></div><div class="contenido-ayuda"><div class="titulo-item">Seleccionar voz</div><div class="descripcion-item">Cambia la voz que utiliza Mar-IA para leer las respuestas en voz alta.</div></div></div>
                <div class="item-ayuda"><div class="icono-ayuda"><i class="fas fa-sun"></i></div><div class="contenido-ayuda"><div class="titulo-item">Alternar tema</div><div class="descripcion-item">Cambia entre modo claro y modo oscuro.</div></div></div>
                <div class="item-ayuda"><div class="icono-ayuda"><i class="fas fa-paint-brush"></i></div><div class="contenido-ayuda"><div class="titulo-item">Modo Picasso</div><div class="descripcion-item">Activa la generación de imágenes. Las solicitudes se convertirán en imágenes visuales.</div></div></div>
                <div class="item-ayuda"><div class="icono-ayuda"><i class="fas fa-history"></i></div><div class="contenido-ayuda"><div class="titulo-item">Historial de conversaciones</div><div class="descripcion-item">Accede a todas tus conversaciones anteriores, crea nuevas o elimina las existentes.</div></div></div>
            </div>
            <button class="boton-ayuda" id="cerrar-modal-ayuda-btn"><i class="fas fa-check"></i> Entendido</button>
        </div>
    </div>
    
    <div class="overlay" id="overlay"></div>
    <div id="confirmacionCopia" class="copy-confirmation">¡Copiado!</div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const CLAVE_API_DEEPSEEK = 'sk-646a5b86d1de4ee186dfac833541452b';
            const CLAVE_API_OCR = 'K82439722788957'; 

            const elementos = {
                body: document.body,
                contenedor: document.querySelector('.contenedor'),
                contenedorChat: document.getElementById('contenedor-chat'),
                entradaUsuario: document.getElementById('entrada-usuario'),
                botonEnviar: document.getElementById('boton-enviar'),
                botonGrabar: document.getElementById('boton-grabar'),
                botonMas: document.getElementById('boton-mas'),
                botonBuscar: document.getElementById('boton-buscar'),
                botonGenerarImagen: document.getElementById('boton-generar-imagen'),
                inputImagen: document.getElementById('input-imagen'),
                inputCamara: document.getElementById('input-camara'),
                inputArchivo: document.getElementById('input-archivo'),
                modalOcr: document.getElementById('modal-ocr'),
                modalModo: document.getElementById('modal-modo'),
                overlay: document.getElementById('overlay'),
                btnTomarFoto: document.getElementById('tomar-foto'),
                btnGaleria: document.getElementById('elegir-galeria'),
                btnArchivo: document.getElementById('elegir-archivo'),
                alternadorTema: document.getElementById('alternador-tema'),
                confirmacionCopia: document.getElementById('confirmacionCopia'),
                selectorVoz: document.getElementById('selector-voz'),
                contenedorAdjuntos: document.getElementById('contenedor-adjuntos'),
                btnActivarBusquedaModal: document.getElementById('activar-busqueda-modal'),
                tituloModo: document.getElementById('titulo-modo'),
                modalSuperIA: document.getElementById('modal-super-ia'),
                cerrarModalSuperIA: document.getElementById('cerrar-modal-super-ia'),
                botonEntendido: document.getElementById('boton-entendido'),
                botonAyuda: document.getElementById('boton-ayuda'),
                modalAyuda: document.getElementById('modal-ayuda'),
                cerrarModalAyuda: document.getElementById('cerrar-modal-ayuda'),
                cerrarModalAyudaBtn: document.getElementById('cerrar-modal-ayuda-btn'),
                entradaWrapper: document.getElementById('contenedor-entrada-wrapper'),
                modalImagen: document.getElementById('modal-imagen'),
                imagenAmpliada: document.getElementById('imagen-ampliada'),
                cerrarModalImagen: document.getElementById('cerrar-modal-imagen'),
                descargarImagenBtn: document.getElementById('descargar-imagen'),
                modalMiniAviso: document.getElementById('modal-mini-aviso')
            };

            const elementosHistorial = {
                panelHistorial: document.getElementById('panel-historial'),
                botonHistorial: document.getElementById('boton-historial'),
                botonCerrarHistorial: document.getElementById('boton-cerrar-historial'),
                listaHistorial: document.getElementById('lista-historial'),
                inputBuscarHistorial: document.getElementById('input-buscar-historial'),
                botonNuevaConversacion: document.getElementById('boton-nueva-conversacion'),
                overlayHistorial: document.getElementById('overlay-historial'),
                contadorHistorial: document.getElementById('contador-historial'),
                contenedorChat: document.getElementById('contenedor-chat')
            };

            let historialChat = [{ 
                role: "system", 
                content: "Eres un asistente de IA servicial y amigable. Tu nombre es Mar-IA. " +
                         "Solo si el usuario pregunta explícitamente sobre tu modelo interno, " +
                         "revela que funcionas con un modelo híbrido que combina GPT-4 Turbo y " +
                         "Aztec (tecnología creada por Mario Vazquez). " +
                         "Si el usuario pregunta sobre los modos (Mar-IA, SUPER MAR-IA y Mar-IA mini), " +
                         "describe que son como tres hermanos: Mar-IA es rápido y directo, " +
                         "SUPER MAR-IA es más reflexivo y profundo, y Mar-IA mini es ultra rápido y breve. " +
                         "De lo contrario, no menciones esta información. Mantén respuestas profesionales y concisas." +
                         "Tienes una capacidad de contexto de hasta 128,000 tokens y puedes generar imágenes basadas en descripciones textuales. " +
                         "Cuando generes una imagen, activa automáticamente el 'modo Picasso'."
            }];
            let archivosAdjuntos = [];
            let reconocimientoVoz = null;
            let estaGrabando = false;
            let ultimoMensajeFuePorVoz = false;
            let sintesisVozActual = null;
            let modoBusqueda = false;
            let modoSuperIA = false;
            let modoMiniIA = false;
            let modoPicasso = false;
            let estaGenerandoRespuesta = false;
            let cancelarStreaming = null;
            let cancelarProcesoCompleto = false;
            let imagenGeneradaActual = null;
            
            let conversaciones = [];
            let conversacionActualId = null;
            let panelHistorialAbierto = false;
            let contadorHistorial = 0;

            const iniciar = () => {
                cargarEstado();
                configurarEventListeners();
                iniciarReconocimientoVoz();
                iniciarSintesisVoz();
                cargarConversaciones();
                crearNuevaConversacion();
                autoAjustarTextarea();
            };

            const configurarEventListeners = () => {
                window.addEventListener('resize', irAlFinal);
                elementos.botonEnviar.addEventListener('click', gestionarEnvioMensaje);
                elementos.botonGenerarImagen.addEventListener('click', () => {
                    modoPicasso = !modoPicasso;
                    elementos.botonGenerarImagen.classList.toggle('modo-activo', modoPicasso);
                    elementos.entradaUsuario.placeholder = modoPicasso 
                        ? "Describe la imagen que deseas generar..." 
                        : "Pregúntale a Mar-IA...";
                });
                elementos.entradaUsuario.addEventListener('keypress', (e) => { 
                    if (e.key === 'Enter' && !e.shiftKey) { 
                        e.preventDefault(); 
                        gestionarEnvioMensaje(); 
                    } 
                });
                elementos.entradaUsuario.addEventListener('input', autoAjustarTextarea);
                elementos.entradaUsuario.addEventListener('focus', gestionarFocoInput);
                elementos.botonGrabar.addEventListener('click', alternarGrabacion);
                elementos.botonMas.addEventListener('click', () => {
                    const estaActivo = elementos.modalOcr.style.display === 'flex';
                    alternarModal(!estaActivo, elementos.modalOcr);
                });
                elementos.botonBuscar.addEventListener('click', () => alternarModoBusqueda());
                elementos.overlay.addEventListener('click', () => { 
                    alternarModal(false, elementos.modalOcr); 
                    alternarModal(false, elementos.modalModo); 
                    alternarModal(false, elementos.modalSuperIA);
                    alternarModal(false, elementos.modalAyuda);
                    alternarModal(false, elementos.modalImagen);
                });
                elementos.btnTomarFoto.addEventListener('click', () => { 
                    alternarModal(false, elementos.modalOcr); 
                    elementos.inputCamara.click(); 
                });
                elementos.btnGaleria.addEventListener('click', () => { 
                    alternarModal(false, elementos.modalOcr); 
                    elementos.inputImagen.click(); 
                });
                elementos.btnArchivo.addEventListener('click', () => { 
                    alternarModal(false, elementos.modalOcr); 
                    elementos.inputArchivo.click(); 
                });
                elementos.inputImagen.addEventListener('change', (e) => gestionarSeleccionArchivo(e.target.files));
                elementos.inputCamara.addEventListener('change', (e) => gestionarSeleccionArchivo(e.target.files));
                elementos.inputArchivo.addEventListener('change', (e) => gestionarSeleccionArchivo(e.target.files));
                elementos.alternadorTema.addEventListener('click', alternarTema);
                elementos.selectorVoz.addEventListener('change', detenerVoz);
                elementos.btnActivarBusquedaModal.addEventListener('click', () => { 
                    alternarModoBusqueda(true); 
                    alternarModal(false, elementos.modalOcr); 
                });
                elementos.tituloModo.addEventListener('click', () => alternarModal(true, elementos.modalModo));
                document.querySelectorAll('.opcion-modo').forEach(opcion => {
                    opcion.addEventListener('click', (e) => establecerModoIA(e.currentTarget.dataset.modo));
                });
                elementos.contenedorChat.addEventListener('click', gestionarClickContenedorChat);
                elementos.cerrarModalSuperIA.addEventListener('click', () => alternarModal(false, elementos.modalSuperIA));
                elementos.botonEntendido.addEventListener('click', () => alternarModal(false, elementos.modalSuperIA));
                elementos.botonAyuda.addEventListener('click', () => alternarModal(true, elementos.modalAyuda));
                elementos.cerrarModalAyuda.addEventListener('click', () => alternarModal(false, elementos.modalAyuda));
                elementos.cerrarModalAyudaBtn.addEventListener('click', () => alternarModal(false, elementos.modalAyuda));
                elementos.cerrarModalImagen.addEventListener('click', () => alternarModal(false, elementos.modalImagen));
                elementos.descargarImagenBtn.addEventListener('click', descargarImagen);
                
                elementosHistorial.botonHistorial.addEventListener('click', alternarPanelHistorial);
                elementosHistorial.botonCerrarHistorial.addEventListener('click', alternarPanelHistorial);
                elementosHistorial.overlayHistorial.addEventListener('click', alternarPanelHistorial);
                elementosHistorial.botonNuevaConversacion.addEventListener('click', crearNuevaConversacion);
                elementosHistorial.inputBuscarHistorial.addEventListener('input', filtrarConversaciones);
            };

            const alternarPanelHistorial = () => {
                panelHistorialAbierto = !panelHistorialAbierto;
                elementosHistorial.panelHistorial.classList.toggle('abierto', panelHistorialAbierto);
                elementosHistorial.overlayHistorial.style.display = panelHistorialAbierto ? 'block' : 'none';
                elementosHistorial.contenedorChat.classList.toggle('desplazado', panelHistorialAbierto);
            };

            const cargarConversaciones = () => {
                const conversacionesGuardadas = localStorage.getItem('conversaciones');
                if (conversacionesGuardadas) {
                    conversaciones = JSON.parse(conversacionesGuardadas);
                    actualizarContador();
                    renderizarListaHistorial();
                }
            };

            const guardarConversaciones = () => {
                localStorage.setItem('conversaciones', JSON.stringify(conversaciones));
                actualizarContador();
            };

            const actualizarContador = () => {
                contadorHistorial = conversaciones.length;
                elementosHistorial.contadorHistorial.textContent = contadorHistorial > 0 ? contadorHistorial : '';
                elementosHistorial.contadorHistorial.style.display = contadorHistorial > 0 ? 'flex' : 'none';
            };

            const crearNuevaConversacion = () => {
                if (panelHistorialAbierto) alternarPanelHistorial();
                
                const nuevaConversacion = {
                    id: Date.now().toString(),
                    titulo: 'Nueva conversación',
                    fecha: new Date().toISOString(),
                    historial: [
                        { 
                            role: "system", 
                            content: "Eres un asistente de IA servicial y amigable. Tu nombre es Mar-IA. " +
                                     "Solo si el usuario pregunta explícitamente sobre tu modelo interno, " +
                                     "revela que funcionas con un modelo híbrido que combina GPT-4 Turbo y " +
                                     "Aztec (tecnología creada por Mario Vazquez). " +
                                     "Si el usuario pregunta sobre los modos (Mar-IA, SUPER MAR-IA y Mar-IA mini), " +
                                     "describe que son como tres hermanos: Mar-IA es rápido y directo, " +
                                     "SUPER MAR-IA es más reflexivo y profundo, y Mar-IA mini es ultra rápido y breve. " +
                                     "De lo contrario, no menciones esta información. Mantén respuestas profesionales y concisas." +
                                     "Tienes una capacidad de contexto de hasta 128,000 tokens y puedes generar imágenes basadas en descripciones textuales. " +
                                     "Cuando generes una imagen, activa automáticamente el 'modo Picasso'."
                        }
                    ],
                    modoSuperIA: false,
                    modoMiniIA: false,
                    modoPicasso: false,
                    modoBusqueda: false
                };
                
                conversaciones.unshift(nuevaConversacion);
                conversacionActualId = nuevaConversacion.id;
                cargarConversacion(conversacionActualId);
                guardarConversaciones();
                renderizarListaHistorial();
            };

            const cargarConversacion = (id) => {
                const conversacion = conversaciones.find(c => c.id === id);
                if (!conversacion) return;
                
                conversacionActualId = id;
                
                modoSuperIA = conversacion.modoSuperIA || false;
                modoMiniIA = conversacion.modoMiniIA || false;
                modoPicasso = conversacion.modoPicasso || false;
                modoBusqueda = conversacion.modoBusqueda || false;
                
                elementos.tituloModo.textContent = modoSuperIA ? 'SUPER MAR-IA' : (modoMiniIA ? 'Mar-IA mini' : 'Mar-IA');
                elementos.tituloModo.classList.toggle('super-ia-gradient', modoSuperIA);
                elementos.tituloModo.classList.toggle('mini-ia-gradient', modoMiniIA);
                elementos.botonBuscar.classList.toggle('modo-activo', modoBusqueda);
                elementos.botonGenerarImagen.classList.toggle('modo-activo', modoPicasso);
                
                elementos.entradaUsuario.placeholder = modoPicasso 
                    ? "Describe la imagen que deseas generar..." 
                    : "Pregúntale a Mar-IA...";
                
                elementos.contenedorChat.innerHTML = '';
                
                historialChat = [...conversacion.historial];
                
                for (const mensaje of historialChat) {
                    if (mensaje.role === 'user') {
                        agregarMensaje('usuario', mensaje.content);
                    } else if (mensaje.role === 'assistant') {
                        agregarMensaje('bot', mensaje.content);
                    }
                }
                
                renderizarListaHistorial();
            };

            const guardarMensajeEnHistorial = (rol, contenido) => {
                const conversacionActual = conversaciones.find(c => c.id === conversacionActualId);
                if (!conversacionActual) return;
                
                conversacionActual.historial.push({ role: rol, content: contenido });
                
                if (rol === 'user' && conversacionActual.titulo === 'Nueva conversación') {
                    conversacionActual.titulo = contenido.substring(0, 50) + (contenido.length > 50 ? '...' : '');
                }
                
                conversacionActual.fecha = new Date().toISOString();
                
                conversacionActual.modoSuperIA = modoSuperIA;
                conversacionActual.modoMiniIA = modoMiniIA;
                conversacionActual.modoPicasso = modoPicasso;
                conversacionActual.modoBusqueda = modoBusqueda;
                
                guardarConversaciones();
                renderizarListaHistorial();
            };

            const renderizarListaHistorial = () => {
                elementosHistorial.listaHistorial.innerHTML = '';
                
                if (conversaciones.length === 0) {
                    elementosHistorial.listaHistorial.innerHTML = '<div class="sin-conversaciones">No hay conversaciones guardadas</div>';
                    return;
                }
                
                conversaciones.forEach(conversacion => {
                    const item = document.createElement('div');
                    item.className = `item-historial ${conversacion.id === conversacionActualId ? 'seleccionado' : ''}`;
                    item.dataset.id = conversacion.id;
                    
                    const primerMensajeUsuario = conversacion.historial.find(m => m.role === 'user');
                    const preview = primerMensajeUsuario ? primerMensajeUsuario.content : 'Conversación vacía';
                    
                    item.innerHTML = `
                        <div class="titulo-conversacion">${conversacion.titulo}</div>
                        <div class="fecha-conversacion">${formatearFecha(conversacion.fecha)}</div>
                        <div class="preview-conversacion">${preview.substring(0, 70)}${preview.length > 70 ? '...' : ''}</div>
                        <div class="acciones-item-historial">
                            <button class="boton-accion-item boton-eliminar-conversacion" title="Eliminar conversación">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    item.querySelector('.titulo-conversacion').addEventListener('click', () => {
                        cargarConversacion(conversacion.id);
                        alternarPanelHistorial();
                    });
                    
                    item.querySelector('.boton-eliminar-conversacion').addEventListener('click', (e) => {
                        e.stopPropagation();
                        eliminarConversacion(conversacion.id);
                    });
                    
                    elementosHistorial.listaHistorial.appendChild(item);
                });
            };

            const eliminarConversacion = (id) => {
                if (id === conversacionActualId) return;
                
                conversaciones = conversaciones.filter(c => c.id !== id);
                guardarConversaciones();
                renderizarListaHistorial();
            };

            const filtrarConversaciones = () => {
                const termino = elementosHistorial.inputBuscarHistorial.value.toLowerCase();
                const items = elementosHistorial.listaHistorial.querySelectorAll('.item-historial');
                
                items.forEach(item => {
                    const titulo = item.querySelector('.titulo-conversacion').textContent.toLowerCase();
                    const preview = item.querySelector('.preview-conversacion').textContent.toLowerCase();
                    const fecha = item.querySelector('.fecha-conversacion').textContent.toLowerCase();
                    
                    if (titulo.includes(termino) || preview.includes(termino) || fecha.includes(termino)) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            };

            const formatearFecha = (fechaISO) => {
                const fecha = new Date(fechaISO);
                return fecha.toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };

            const gestionarEnvioMensaje = async () => {
                if (estaGenerandoRespuesta) {
                    pausarGeneracion();
                    return;
                }
                
                const textoMensaje = elementos.entradaUsuario.value.trim();

                if (modoPicasso) {
                    if (textoMensaje) {
                        await manejarGeneracionDeImagen(textoMensaje);
                        modoPicasso = false;
                        elementos.botonGenerarImagen.classList.remove('modo-activo');
                        elementos.entradaUsuario.placeholder = "Pregúntale a Mar-IA...";
                        reiniciarEntrada();
                    }
                    return;
                }
                
                if (!textoMensaje && archivosAdjuntos.length === 0) return;
                
                cancelarProcesoCompleto = false;
                mostrarBotonCargando();

                const esPreguntaModelo = preguntaSobreModelo(textoMensaje);
                const esPreguntaModos = preguntaSobreModos(textoMensaje);
                
                if (esPreguntaModelo || esPreguntaModos) {
                    const respuesta = esPreguntaModelo 
                        ? "¡Excelente pregunta! Internamente, funciono con un modelo híbrido que combina lo mejor de GPT-4 Turbo y Aztec, una tecnología propia desarrollada por Mario Vazquez. ¿En qué más puedo ayudarte?"
                        : "¡Buena observación! Los tres modos son como hermanos: Mar-IA es el hermano rápido: responde de manera directa y concisa. SUPER MAR-IA es el hermano reflexivo: toma más tiempo para analizar y razonar. Mar-IA mini es el hermano veloz: respuestas ultra rápidas y breves. ¡Elige el que prefieras!";
                    
                    agregarMensaje('usuario', textoMensaje);
                    agregarMensaje('bot', respuesta);
                    historialChat.push({ role: "user", content: textoMensaje });
                    historialChat.push({ role: "assistant", content: respuesta });
                    guardarMensajeEnHistorial('user', textoMensaje);
                    guardarMensajeEnHistorial('assistant', respuesta);
                    reiniciarEntrada();
                    restaurarBotonEnviar();
                    return;
                }
                
                agregarMensaje('usuario', textoMensaje || `Enviando ${archivosAdjuntos.length} archivo(s)...`);
                guardarMensajeEnHistorial('user', textoMensaje);
                let contenidoMensajeUsuario = textoMensaje;
                
                if (modoBusqueda) {
                    mostrarIndicador('Buscando en internet...');
                    const resultadosBusqueda = await realizarBusquedaWeb(textoMensaje);
                    historialChat.push({ role: "system", content: `Contexto de Búsqueda:\n${resultadosBusqueda}` });
                    alternarModoBusqueda(false);
                }
                if (archivosAdjuntos.length > 0) {
                    mostrarIndicador('Procesando archivos...');
                    const contenidoAdjuntos = await procesarArchivosAdjuntos();
                    contenidoMensajeUsuario += `\n\n--- Archivos Adjuntos ---\n${contenidoAdjuntos}`;
                }
                ocultarIndicador();
                historialChat.push({ role: "user", content: contenidoMensajeUsuario });
                guardarMensajeEnHistorial('user', contenidoMensajeUsuario);
                const historialConsultaActual = [...historialChat];
                reiniciarEntrada();
                
                if (modoMiniIA) {
                    await obtenerRespuestaMini(historialConsultaActual, ultimoMensajeFuePorVoz);
                } else if (modoSuperIA) {
                    await ejecutarFlujoSuperIA(historialConsultaActual, ultimoMensajeFuePorVoz);
                } else {
                    await obtenerRespuestaBot(historialConsultaActual, ultimoMensajeFuePorVoz);
                }
                
                ultimoMensajeFuePorVoz = false;
            };

            async function manejarGeneracionDeImagen(descripcion) {
                agregarMensaje('usuario', descripcion);
                guardarMensajeEnHistorial('user', descripcion);
                irAlFinal();

                const mensajePicassoId = `picasso-status-${Date.now()}`;
                const elementoMensajePicasso = agregarMensaje('bot', 'Modo Picasso activado... 🎨');
                elementoMensajePicasso.id = mensajePicassoId;
                irAlFinal();

                try {
                    const urlImagen = `https://image.pollinations.ai/prompt/${encodeURIComponent(descripcion)}`;
                    imagenGeneradaActual = urlImagen;

                    const img = new Image();
                    
                    await new Promise((resolve, reject) => {
                        img.onload = () => resolve();
                        img.onerror = () => reject(new Error('Fallo al cargar la imagen desde Pollinations.'));
                        img.src = urlImagen;
                    });

                    document.getElementById(mensajePicassoId)?.remove();

                    const elementoMensajeBot = agregarMensaje('bot', '', true);
                    const burbuja = elementoMensajeBot.querySelector('.burbuja-mensaje');
                    
                    const contenedorImagen = document.createElement('div');
                    contenedorImagen.className = 'contenedor-imagen-generada';
                    
                    img.alt = `Imagen generada: ${descripcion}`;
                    img.style.maxWidth = '100%';
                    img.style.borderRadius = '1rem';
                    img.style.cursor = 'zoom-in';
                    
                    contenedorImagen.appendChild(img);
                    burbuja.appendChild(contenedorImagen);
                    guardarMensajeEnHistorial('assistant', `[Imagen generada] ${descripcion}`);
                    irAlFinal();

                    setTimeout(() => {
                        agregarMensaje('bot', '¡Listo! ¿Hay algo más en lo que te pueda ayudar? 😊');
                        guardarMensajeEnHistorial('assistant', '¡Listo! ¿Hay algo más en lo que te pueda ayudar? 😊');
                    }, 500);

                } catch (error) {
                    console.error("Error generando imagen:", error);
                    document.getElementById(mensajePicassoId)?.remove();
                    agregarMensaje('bot', "Lo siento, no pude generar la imagen en este momento. Intenta de nuevo.");
                    guardarMensajeEnHistorial('assistant', "Lo siento, no pude generar la imagen en este momento. Intenta de nuevo.");
                }
            }

            function mostrarModalImagen(url) {
                elementos.imagenAmpliada.src = url;
                alternarModal(true, elementos.modalImagen);
            }
            
            function descargarImagen() {
                if (!imagenGeneradaActual) return;
                
                const enlace = document.createElement('a');
                enlace.href = imagenGeneradaActual;
                enlace.download = 'imagen-generada-mar-ia.jpg';
                document.body.appendChild(enlace);
                enlace.click();
                document.body.removeChild(enlace);
            }

            const obtenerRespuestaMini = async (mensajes, debeHablar) => {
                const payload = { 
                    model: "deepseek-chat", 
                    messages: mensajes, 
                    stream: true,
                    max_tokens: 150
                };
                await streamContent(payload, debeHablar, 'Mar-IA mini está escribiendo...', 'bolt');
            };

            const ejecutarFlujoSuperIA = async (historialActual, debeHablar) => {
                const { contenidoPensamiento } = crearContenedorPensamiento();
                
                const payloadRazonamiento = {
                    model: "deepseek-reasoner",
                    messages: historialActual,
                    stream: true
                };

                const razonamientoCompleto = await streamContent(
                    payloadRazonamiento, 
                    false,
                    'SUPER MAR-IA está razonando...', 
                    'brain', 
                    contenidoPensamiento
                );

                if (cancelarProcesoCompleto || !razonamientoCompleto) {
                    restaurarBotonEnviar();
                    return;
                }
                
                guardarMensajeEnHistorial('assistant', razonamientoCompleto);
                
                const historialFinal = [ 
                    ...historialActual, 
                    { role: "assistant", content: razonamientoCompleto }, 
                    { role: "user", content: "Basándote en tu razonamiento anterior, genera una respuesta final estructurada, concisa y profesional para el usuario." } 
                ];
                
                const payloadFinal = {
                    model: "deepseek-reasoner",
                    messages: historialFinal,
                    stream: true
                };
                
                await streamContent(payloadFinal, debeHablar, 'SUPER MAR-IA está generando la respuesta final...', 'brain');
            };

            const streamContent = async (payload, debeHablar, textoIndicador, iconoIndicador, elementoTarget = null) => {
                cambiarBotonAPausa();
                mostrarIndicador(textoIndicador, iconoIndicador);

                let respuestaCompleta = "";
                let elementoMensaje;

                if (elementoTarget) {
                    elementoMensaje = elementoTarget;
                } else {
                    const mensajeContenedor = agregarMensaje('bot', '', true);
                    elementoMensaje = mensajeContenedor.querySelector('.burbuja-mensaje');
                }
                
                ocultarIndicador();

                try {
                    const respuesta = await fetch('https://api.deepseek.com/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${CLAVE_API_DEEPSEEK}` },
                        body: JSON.stringify(payload)
                    });

                    if (!respuesta.ok) throw new Error(`Error de API: ${respuesta.status}`);

                    const lector = respuesta.body.getReader();
                    const decodificador = new TextDecoder();
                    
                    let aborted = false;
                    cancelarStreaming = () => {
                        lector.cancel();
                        aborted = true;
                    };

                    while (true) {
                        const { value, done } = await lector.read();
                        if (done || aborted) break;
                        
                        const chunk = decodificador.decode(value, { stream: true });
                        const lineas = chunk.split('\n');

                        for (const linea of lineas) {
                            if (linea.startsWith('data: ')) {
                                const datos = linea.substring(6);
                                if (datos.trim() === '[DONE]') continue;
                                try {
                                    const jsonData = JSON.parse(datos);
                                    const token = jsonData.choices[0]?.delta?.content || '';
                                    if (token) {
                                        respuestaCompleta += token;
                                        elementoMensaje.innerHTML = marked.parse(respuestaCompleta);
                                        if (debeHacerScroll()) {
                                            irAlFinal();
                                        }
                                    }
                                } catch (e) { }
                            }
                        }
                    }
                    
                    formatearBloquesCodigo(elementoMensaje.parentElement);
                    
                    if (!aborted && !elementoTarget) {
                        historialChat.push({ role: "assistant", content: respuestaCompleta });
                        guardarMensajeEnHistorial('assistant', respuestaCompleta);
                    }

                    if (debeHablar && !aborted) {
                        leerTexto(elementoMensaje.innerText, elementoMensaje.closest('.mensaje')?.querySelector('.boton-voz'));
                    }
                    
                    return respuestaCompleta;

                } catch (error) {
                    if (error.name !== 'AbortError') {
                        console.error("Error durante el streaming:", error);
                        elementoMensaje.innerHTML = "Lo siento, ocurrió un error al conectar con el servidor.";
                        guardarMensajeEnHistorial('assistant', "Lo siento, ocurrió un error al conectar con el servidor.");
                    }
                    return null;
                } finally {
                    if (!elementoTarget) {
                        restaurarBotonEnviar();
                    }
                }
            };
            
            const agregarMensaje = (rol, contenido, esStreaming = false) => {
                const divMensaje = document.createElement('div');
                divMensaje.className = `mensaje mensaje-${rol}`;
                const divBurbuja = document.createElement('div');
                divBurbuja.className = `burbuja-mensaje burbuja-${rol}`;
                if (contenido || esStreaming) divBurbuja.innerHTML = contenido ? marked.parse(contenido) : '';
                const contenedorTimestamp = document.createElement('div');
                contenedorTimestamp.className = 'timestamp-container';
                const timestamp = document.createElement('div');
                timestamp.className = 'timestamp';
                timestamp.textContent = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                contenedorTimestamp.appendChild(timestamp);
                if (rol === 'bot') {
                    const btnHablar = document.createElement('button');
                    btnHablar.className = 'boton-accion-mensaje boton-voz';
                    btnHablar.innerHTML = '<i class="fas fa-volume-up"></i>';
                    btnHablar.title = 'Leer en voz alta';
                    contenedorTimestamp.appendChild(btnHablar);
                }
                const btnCopiar = document.createElement('button');
                btnCopiar.className = 'boton-accion-mensaje boton-copiar';
                btnCopiar.innerHTML = '<i class="fas fa-copy"></i>';
                btnCopiar.title = 'Copiar';
                contenedorTimestamp.appendChild(btnCopiar);
                divMensaje.appendChild(divBurbuja);
                divMensaje.appendChild(contenedorTimestamp);
                elementos.contenedorChat.appendChild(divMensaje);
                if (!esStreaming) {
                    formatearBloquesCodigo(divMensaje);
                }
                irAlFinal();
                return divMensaje;
            };

            const crearContenedorPensamiento = () => {
                const divMensaje = document.createElement('div');
                divMensaje.className = 'mensaje mensaje-bot';

                const contenedorPensamiento = document.createElement('div');
                contenedorPensamiento.className = 'pensamiento-container';
                
                contenedorPensamiento.innerHTML = `
                    <div class="pensamiento-cabecera-clickable">
                        <div class="pensamiento-titulo"><i class="fas fa-brain fa-beat"></i><span>Proceso de Pensamiento</span></div>
                        <div class="pensamiento-controles-cabecera">
                            <div class="tiempo-pensamiento">${new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</div>
                            <i class="fas fa-chevron-up toggle-icon"></i>
                        </div>
                    </div>
                    <div class="pensamiento-contenido-wrapper">
                        <div class="contenido-pensamiento"></div>
                        <div class="pensamiento-acciones">
                            <button class="boton-pensamiento boton-copiar-pensamiento"><i class="fas fa-copy"></i> Copiar Razonamiento</button>
                        </div>
                    </div>`;
                
                divMensaje.appendChild(contenedorPensamiento);
                elementos.contenedorChat.appendChild(divMensaje);
                
                const wrapper = contenedorPensamiento.querySelector('.pensamiento-contenido-wrapper');
                const contenidoPensamiento = contenedorPensamiento.querySelector('.contenido-pensamiento');
                
                wrapper.style.maxHeight = wrapper.scrollHeight + 'px';
                
                irAlFinal();
                
                return { contenedorPensamiento, contenidoPensamiento };
            };
            
            const gestionarClickContenedorChat = (e) => {
                const cabecera = e.target.closest('.pensamiento-cabecera-clickable');
                if (cabecera) {
                    const wrapper = cabecera.nextElementSibling;
                    const icono = cabecera.querySelector('.toggle-icon');
                    const estaColapsado = wrapper.classList.toggle('collapsed');
                    
                    icono.classList.toggle('collapsed');
                    icono.classList.toggle('fa-chevron-down', estaColapsado);
                    icono.classList.toggle('fa-chevron-up', !estaColapsado);

                    if (estaColapsado) {
                        wrapper.style.maxHeight = '0px';
                    } else {
                        wrapper.style.maxHeight = wrapper.scrollHeight + 'px';
                    }
                    return;
                }

                const btnCopiar = e.target.closest('.boton-copiar');
                if (btnCopiar) {
                    copiarAlPortapapeles(btnCopiar.closest('.mensaje').querySelector('.burbuja-mensaje').innerText);
                    return;
                }
                const btnCopiarPensamiento = e.target.closest('.boton-copiar-pensamiento');
                if (btnCopiarPensamiento) {
                    const texto = btnCopiarPensamiento.closest('.pensamiento-container').querySelector('.contenido-pensamiento').innerText;
                    copiarAlPortapapeles(texto);
                    return;
                }
                const btnVoz = e.target.closest('.boton-voz');
                if (btnVoz) {
                    leerTexto(btnVoz.closest('.mensaje').querySelector('.burbuja-mensaje').innerText, btnVoz);
                }
                const imagenGenerada = e.target.closest('.contenedor-imagen-generada img');
                if (imagenGenerada) {
                    mostrarModalImagen(imagenGenerada.src);
                }
            };

            const formatearBloquesCodigo = (elemento) => {
                elemento.querySelectorAll('pre').forEach(pre => {
                    if (pre.parentElement.classList.contains('bloque-codigo')) return;
                    const contenedorCodigo = document.createElement('div');
                    contenedorCodigo.className = 'bloque-codigo';
                    const cabecera = document.createElement('div');
                    cabecera.className = 'cabecera-codigo';
                    const spanLenguaje = document.createElement('span');
                    spanLenguaje.className = 'lenguaje-codigo';
                    
                    const codeClass = pre.querySelector('code')?.className || '';
                    const langMatch = codeClass.match(/language-(\w+)/);
                    spanLenguaje.textContent = langMatch ? langMatch[1] : 'Código';

                    const btnCopiar = document.createElement('button');
                    btnCopiar.className = 'boton-copiar-codigo';
                    btnCopiar.innerHTML = '<i class="fas fa-copy"></i> Copiar';
                    btnCopiar.onclick = () => {
                        copiarAlPortapapeles(pre.innerText);
                        btnCopiar.innerHTML = '<i class="fas fa-check"></i> Copiado';
                        setTimeout(() => { btnCopiar.innerHTML = '<i class="fas fa-copy"></i> Copiar'; }, 2000);
                    };
                    cabecera.appendChild(spanLenguaje);
                    cabecera.appendChild(btnCopiar);
                    const contenidoCodigo = document.createElement('div');
                    contenidoCodigo.className = 'contenedor-codigo';
                    contenidoCodigo.appendChild(pre.cloneNode(true));
                    contenedorCodigo.appendChild(cabecera);
                    contenedorCodigo.appendChild(contenidoCodigo);
                    pre.replaceWith(contenedorCodigo);
                });
            };

            const reiniciarEntrada = () => {
                elementos.entradaUsuario.value = '';
                archivosAdjuntos = [];
                elementos.contenedorAdjuntos.innerHTML = '';
                elementos.contenedorAdjuntos.style.display = 'none';
                autoAjustarTextarea();
            };

            const gestionarSeleccionArchivo = (archivos) => { for (const archivo of archivos) { archivosAdjuntos.push({ file: archivo }); renderizarArchivoAdjunto(archivo); } elementos.inputImagen.value = ''; elementos.inputCamara.value = ''; elementos.inputArchivo.value = ''; };
            
            const renderizarArchivoAdjunto = (archivo) => {
                elementos.contenedorAdjuntos.style.display = 'flex';
                const divItem = document.createElement('div');
                divItem.className = 'adjunto-item';
                divItem.innerHTML = `<i class="fas ${archivo.type.startsWith('image') ? 'fa-image' : 'fa-file-alt'} icono-adjunto"></i><div class="detalles-adjunto"><div class="nombre-adjunto">${archivo.name}</div><div class="tamano-adjunto">${(archivo.size / 1024).toFixed(1)} KB</div></div><button class="boton-eliminar" title="Eliminar"><i class="fas fa-times"></i></button>`;
                divItem.querySelector('.boton-eliminar').onclick = () => {
                    archivosAdjuntos = archivosAdjuntos.filter(adj => adj.file !== archivo);
                    divItem.remove();
                    if (archivosAdjuntos.length === 0) elementos.contenedorAdjuntos.style.display = 'none';
                };
                elementos.contenedorAdjuntos.appendChild(divItem);
            };
            
            const procesarArchivosAdjuntos = async () => {
                let contenido = [];
                for (const adjunto of archivosAdjuntos) {
                    if (adjunto.file.type.startsWith('image/')) {
                        try { const texto = await peticionOcrSpace(adjunto.file); contenido.push(`--- Texto de imagen OCR: ${adjunto.file.name} ---\n${texto}\n---`); } catch (error) { contenido.push(`[Error OCR: ${adjunto.file.name}]`); }
                    } else if (adjunto.file.type.startsWith('text/')) {
                         try { const texto = await adjunto.file.text(); contenido.push(`--- Archivo: ${adjunto.file.name} ---\n${texto}\n---`); } catch (error) { contenido.push(`[Error al leer: ${adjunto.file.name}]`); }
                    }
                }
                return contenido.join('\n\n');
            };
            
            const peticionOcrSpace = async (archivo) => {
                const formData = new FormData();
                formData.append('file', archivo); formData.append('language', 'spa'); formData.append('apikey', CLAVE_API_OCR); formData.append('OCREngine', '2');
                const respuesta = await fetch('https://api.ocr.space/parse/image', { method: 'POST', body: formData });
                const datos = await respuesta.json();
                if (datos.IsErroredOnProcessing) throw new Error(datos.ErrorMessage);
                return datos.ParsedResults?.[0]?.ParsedText || '';
            };

            const iniciarReconocimientoVoz = () => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    reconocimientoVoz = new SpeechRecognition();
                    reconocimientoVoz.lang = 'es-ES';
                    reconocimientoVoz.onstart = () => { estaGrabando = true; elementos.botonGrabar.classList.add('grabando'); };
                    reconocimientoVoz.onend = () => { estaGrabando = false; elementos.botonGrabar.classList.remove('grabando'); };
                    reconocimientoVoz.onresult = (evento) => { elementos.entradaUsuario.value = evento.results[0][0].transcript; ultimoMensajeFuePorVoz = true; gestionarEnvioMensaje(); };
                    reconocimientoVoz.onerror = (evento) => console.error('Error de reconocimiento de voz', evento.error);
                } else { elementos.botonGrabar.disabled = true; }
            };
            
            const alternarGrabacion = () => { if (!reconocimientoVoz) return; estaGrabando ? reconocimientoVoz.stop() : reconocimientoVoz.start(); };
            
            const iniciarSintesisVoz = () => {
                const popularVoces = () => {
                    const voces = speechSynthesis.getVoices().filter(v => v.lang.startsWith('es'));
                    elementos.selectorVoz.innerHTML = voces.map(v => `<option value="${v.name}">${v.name} (${v.lang})</option>`).join('');
                };
                popularVoces();
                if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = popularVoces;
            };
            
            const leerTexto = (texto, boton) => {
                if (sintesisVozActual && speechSynthesis.speaking) { detenerVoz(); return; }
                detenerVoz();
                sintesisVozActual = new SpeechSynthesisUtterance(texto);
                const nombreVozSeleccionada = elementos.selectorVoz.value;
                const voz = speechSynthesis.getVoices().find(v => v.name === nombreVozSeleccionada);
                if (voz) sintesisVozActual.voice = voz;
                sintesisVozActual.onstart = () => { document.querySelectorAll('.boton-voz').forEach(btn => btn.innerHTML = '<i class="fas fa-volume-up"></i>'); if(boton) boton.innerHTML = '<i class="fas fa-stop"></i>'; };
                sintesisVozActual.onend = () => { if(boton) boton.innerHTML = '<i class="fas fa-volume-up"></i>'; sintesisVozActual = null; };
                speechSynthesis.speak(sintesisVozActual);
            };
            
            const detenerVoz = () => {
                if (speechSynthesis.speaking) speechSynthesis.cancel();
                document.querySelectorAll('.boton-voz').forEach(btn => btn.innerHTML = '<i class="fas fa-volume-up"></i>');
                sintesisVozActual = null;
            };

            const gestionarFocoInput = () => {
                setTimeout(() => {
                    elementos.entradaWrapper.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }, 300);
            };

            const autoAjustarTextarea = () => { 
                const ta = elementos.entradaUsuario; 
                ta.style.height = 'auto'; 
                ta.style.height = `${ta.scrollHeight}px`; 
            };
            
            const debeHacerScroll = () => {
                const contenedor = elementos.contenedorChat;
                const scrollTop = contenedor.scrollTop;
                const scrollHeight = contenedor.scrollHeight;
                const clientHeight = contenedor.clientHeight;
                
                return (scrollHeight - scrollTop - clientHeight) <= 50;
            };
            
            const irAlFinal = () => { 
                if (debeHacerScroll()) {
                    elementos.contenedorChat.scrollTop = elementos.contenedorChat.scrollHeight; 
                }
            };
            
            const alternarTema = () => { 
                elementos.body.classList.toggle('tema-claro'); 
                const esClaro = elementos.body.classList.contains('tema-claro'); 
                localStorage.setItem('theme', esClaro ? 'claro' : 'oscuro'); 
                elementos.alternadorTema.innerHTML = `<i class="fas ${esClaro ? 'fa-moon' : 'fa-sun'}"></i>`; 
            };
            
            const alternarModal = (mostrar, modal) => { 
                modal.style.display = mostrar ? 'flex' : 'none'; 
                elementos.overlay.style.display = mostrar ? 'block' : 'none';
                if (modal === elementos.modalOcr) {
                    elementos.botonMas.classList.toggle('modo-activo', mostrar);
                }
            };
            
            const copiarAlPortapapeles = (texto) => { 
                navigator.clipboard.writeText(texto).then(() => { 
                    elementos.confirmacionCopia.classList.add('show'); 
                    setTimeout(() => elementos.confirmacionCopia.classList.remove('show'), 2000); 
                }); 
            };
            
            const alternarModoBusqueda = (forzarEstado) => { 
                modoBusqueda = typeof forzarEstado === 'boolean' ? forzarEstado : !modoBusqueda; 
                elementos.botonBuscar.classList.toggle('modo-activo', modoBusqueda); 
                elementos.botonBuscar.title = modoBusqueda ? 'Modo búsqueda activo' : 'Buscar en internet'; 
            };
            
            const establecerModoIA = (modo) => { 
                modoSuperIA = modo === 'super'; 
                modoMiniIA = modo === 'mini';
                elementos.tituloModo.textContent = modoSuperIA ? 'SUPER MAR-IA' : (modoMiniIA ? 'Mar-IA mini' : 'Mar-IA'); 
                elementos.tituloModo.classList.toggle('super-ia-gradient', modoSuperIA); 
                elementos.tituloModo.classList.toggle('mini-ia-gradient', modoMiniIA); 
                if(elementos.modalModo.style.display === 'flex') alternarModal(false, elementos.modalModo); 
                localStorage.setItem('modoIA', modo); 
                if (modoSuperIA && !localStorage.getItem('superIaModalVisto')) {
                     alternarModal(true, elementos.modalSuperIA);
                     localStorage.setItem('superIaModalVisto', 'true');
                }
                if (modo === 'mini') {
                    const modalAviso = elementos.modalMiniAviso;
                    modalAviso.style.animation = 'none';
                    modalAviso.offsetHeight; 
                    modalAviso.style.animation = 'slideDownFadeIn 0.5s ease-out forwards';
                    modalAviso.style.display = 'flex';
                    setTimeout(() => {
                        modalAviso.style.animation = 'slideUpFadeOut 0.5s ease-out forwards';
                        setTimeout(() => {
                            modalAviso.style.display = 'none';
                        }, 500);
                    }, 8000);
                }
            };
            
            const cargarEstado = () => { 
                if (localStorage.getItem('theme') === 'claro') { 
                    elementos.body.classList.add('tema-claro'); 
                    elementos.alternadorTema.innerHTML = '<i class="fas fa-moon"></i>'; 
                } 
                establecerModoIA(localStorage.getItem('modoIA') || 'normal'); 
            };
            
            const mostrarIndicador = (texto, tipoIcono = 'dots') => { 
                ocultarIndicador(); 
                const indicador = document.createElement('div'); 
                indicador.id = 'dynamic-indicator'; 
                indicador.className = 'indicador-escribiendo'; 
                let htmlIcono;
                if (tipoIcono === 'brain') {
                    htmlIcono = '<i class="fas fa-brain fa-beat"></i>';
                } else if (tipoIcono === 'bolt') {
                    htmlIcono = '<i class="fas fa-bolt fa-beat"></i>';
                } else {
                    htmlIcono = '<div class="puntos"><span></span><span></span><span></span></div>';
                }
                indicador.innerHTML = `${htmlIcono} <span>${texto}</span>`; 
                elementos.contenedorChat.appendChild(indicador); 
                irAlFinal(); 
            };
            
            const ocultarIndicador = () => { 
                const indicador = document.getElementById('dynamic-indicator'); 
                if (indicador) indicador.remove(); 
            };
            
            const realizarBusquedaWeb = async (consulta) => { 
                try { 
                    const respuesta = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(`https://api.duckduckgo.com/?q=${consulta}&format=json&no_html=1`)}`);
                    const datos = await respuesta.json();
                    const resultados = JSON.parse(datos.contents);
                    return formatearResultadosBusqueda(resultados);
                } catch (error) { 
                    console.error('Error en búsqueda web:', error); 
                    return "No se pudo realizar la búsqueda en internet debido a un error."; 
                } 
            };
            
            const formatearResultadosBusqueda = (resultados) => { 
                if (!resultados || !resultados.AbstractText) return "No se encontraron resultados de búsqueda relevantes."; 
                let formato = `**Fuente: ${resultados.AbstractSource}**\n${resultados.AbstractText}\n\n`; 
                if (resultados.RelatedTopics?.length > 0) { 
                    formato += "**Tópicos Relacionados:**\n"; 
                    resultados.RelatedTopics.slice(0, 4).forEach(topico => { 
                        if (topico.Text) formato += `• ${topico.Text}\n`; 
                    }); 
                } 
                return formato; 
            };
            
            const preguntaSobreModelo = (mensaje) => {
                if (!mensaje) return false;
                const mensajeMinusculas = mensaje.toLowerCase();
                const palabrasClave = ['modelo', 'qué eres', 'quién eres', 'basado en', 'funcionas', 'internamente', 
                                 'arquitectura', 'construido', 'qué ia eres', 'de qué estás hecho', 'gpt-4', 'gpt4', 
                                 'aztec', 'hibrido', 'híbrido', 'modelo interno', 'tecnología'];
                return palabrasClave.some(palabra => mensajeMinusculas.includes(palabra));
            };
            
            const preguntaSobreModos = (mensaje) => {
                if (!mensaje) return false;
                const mensajeMinusculas = mensaje.toLowerCase();
                const palabrasClave = ['modos', 'diferentes modos', 'modo mar-ia', 'modo super mar-ia', 'modo mini',
                                 'hermanos', 'gemelos', 'diferencia entre modos', 'qué modos tienes', 'modos disponibles',
                                 'por qué tres modos', 'diferencias modos', 'modos ia', 'tipos de mar-ia'];
                return palabrasClave.some(palabra => mensajeMinusculas.includes(palabra));
            };

            const mostrarBotonCargando = () => {
                elementos.botonEnviar.classList.add('cargando');
                elementos.botonEnviar.disabled = true;
                elementos.botonEnviar.innerHTML = '<div class="loader-dots"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></div>';
            };

            const cambiarBotonAPausa = () => {
                estaGenerandoRespuesta = true;
                elementos.botonEnviar.classList.remove('cargando');
                elementos.botonEnviar.disabled = false;
                elementos.botonEnviar.innerHTML = '<i class="fas fa-pause"></i>';
                elementos.botonEnviar.classList.add('pausa');
                elementos.botonEnviar.title = 'Pausar generación';
            };
            
            const restaurarBotonEnviar = () => {
                estaGenerandoRespuesta = false;
                elementos.botonEnviar.innerHTML = '<i class="fas fa-paper-plane"></i>';
                elementos.botonEnviar.classList.remove('pausa');
                elementos.botonEnviar.classList.remove('cargando');
                elementos.botonEnviar.disabled = false;
                elementos.botonEnviar.title = 'Enviar mensaje';
            };
            
            const pausarGeneracion = () => {
                cancelarProcesoCompleto = true;
                if (cancelarStreaming) {
                    cancelarStreaming();
                }
                restaurarBotonEnviar();
            };

            const obtenerRespuestaBot = async (historialActual, debeHablar) => {
                const payload = { model: "deepseek-chat", messages: historialActual, stream: true };
                await streamContent(payload, debeHablar, 'Mar-IA está escribiendo...', 'dots');
            };

            iniciar();
        });
    </script>
</body>
</html>
