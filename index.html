<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mar-IA con Voz</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --color-fondo: #1A1A1A;
            --color-contenedor: #2C2C2C;
            --color-cabecera: #222222;
            --color-texto: #E0E0E0;
            --color-texto-cabecera: #FFFFFF;
            --fondo-info-api: rgba(70, 130, 180, 0.1);
            --borde-info-api: #4682B4;
            --fondo-chat: #222222;
            --fondo-burbuja-usuario: linear-gradient(135deg, #4A4A4A, #3A3A3A);
            --texto-burbuja-usuario: #FFFFFF;
            --fondo-burbuja-bot: #3A3A3A;
            --texto-burbuja-bot: #E0E0E0;
            --borde-burbuja-bot: rgba(255, 255, 255, 0.1);
            --fondo-entrada: #222222;
            --borde-superior-entrada: rgba(255, 255, 255, 0.05);
            --fondo-campo-entrada: #3A3A3A;
            --texto-entrada: #FFFFFF;
            --texto-placeholder: #A0A0A0;
            --sombra-foco-entrada: 0 0 0 2px rgba(0, 123, 255, 0.3);
            --fondo-boton-enviar: #007BFF;
            --texto-boton-enviar: white;
            --sombra-hover-boton-enviar: 0 4px 8px rgba(0, 123, 255, 0.4);
            --fondo-deshabilitado-boton-enviar: rgba(0, 123, 255, 0.3);
            --fondo-boton-caracteristica: #6A0DAD;
            --texto-boton-caracteristica: white;
            --sombra-hover-boton-caracteristica: 0 4px 8px rgba(106, 13, 173, 0.4);
            --fondo-deshabilitado-boton-caracteristica: rgba(106, 13, 173, 0.3);
            --fondo-indicador-escribiendo: #3A3A3A;
            --punto-indicador-escribiendo: #E0E0E0;
            --color-timestamp: #A0A0A0;
            --color-alternador-tema: #FFFFFF;
            --color-hover-alternador-tema: #007BFF;
            --fondo-boton-voz: rgba(0, 123, 255, 0.2);
            --texto-boton-voz: #007BFF;
            --sombra-hover-boton-voz: 0 2px 4px rgba(0, 123, 255, 0.3);
            --fondo-boton-copiar: rgba(100, 100, 100, 0.2);
            --texto-boton-copiar: #CCCCCC;
            --sombra-hover-boton-copiar: 0 2px 4px rgba(100, 100, 100, 0.3);
            --fondo-boton-grabar: #007BFF;
            --fondo-boton-grabando: #ff4d4d;
        }

        body.tema-claro {
            --color-fondo: #E0F2F7;
            --color-contenedor: #FFFFFF;
            --color-cabecera: #007BFF;
            --color-texto: #333333;
            --color-texto-cabecera: #FFFFFF;
            --fondo-info-api: rgba(0, 123, 255, 0.1);
            --borde-info-api: #007BFF;
            --fondo-chat: #FFFFFF;
            --fondo-burbuja-usuario: #007BFF;
            --texto-burbuja-usuario: #FFFFFF;
            --fondo-burbuja-bot: #F0F8FF;
            --texto-burbuja-bot: #333333;
            --borde-burbuja-bot: #ADD8E6;
            --fondo-entrada: #F8F8F8;
            --borde-superior-entrada: #CCCCCC;
            --fondo-campo-entrada: #FFFFFF;
            --texto-entrada: #333333;
            --texto-placeholder: #666666;
            --sombra-foco-entrada: 0 0 0 2px rgba(0, 123, 255, 0.3);
            --fondo-boton-enviar: #007BFF;
            --texto-boton-enviar: #FFFFFF;
            --sombra-hover-boton-enviar: 0 4px 8px rgba(0, 123, 255, 0.2);
            --fondo-deshabilitado-boton-enviar: #B0C4DE;
            --fondo-boton-caracteristica: #0056b3;
            --texto-boton-caracteristica: #FFFFFF;
            --sombra-hover-boton-caracteristica: 0 4px 8px rgba(0, 86, 179, 0.2);
            --fondo-deshabilitado-boton-caracteristica: #B0C4DE;
            --fondo-indicador-escribiendo: #F0F8FF;
            --punto-indicador-escribiendo: #007BFF;
            --color-timestamp: #666666;
            --color-alternador-tema: #FFFFFF;
            --color-hover-alternador-tema: #0056b3;
            --fondo-boton-voz: rgba(0, 123, 255, 0.1);
            --texto-boton-voz: #0056b3;
            --sombra-hover-boton-voz: 0 2px 4px rgba(0, 123, 255, 0.15);
            --fondo-boton-copiar: rgba(200, 200, 200, 0.5);
            --texto-boton-copiar: #666666;
            --sombra-hover-boton-copiar: 0 2px 4px rgba(200, 200, 200, 0.7);
            --fondo-boton-grabar: #007BFF;
            --fondo-boton-grabando: #ff4d4d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: var(--color-fondo);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: var(--color-texto);
            transition: background 0.5s ease;
            background-image: radial-gradient(circle at 25% 25%, rgba(70,130,180,0.1) 0%, transparent 55%), radial-gradient(circle at 75% 75%, rgba(106,13,173,0.1) 0%, transparent 55%);
        }

        .contenedor {
            width: 100%;
            max-width: 1000px;
            background: var(--color-contenedor);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            border: 1px solid var(--borde-superior-entrada);
            display: flex;
            flex-direction: column;
            height: 90vh;
            min-height: 600px;
            position: relative;
        }

        .cabecera {
            background: var(--color-cabecera);
            color: var(--color-texto-cabecera);
            padding: 15px 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--borde-superior-entrada);
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .cabecera .titulo {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-right: auto;
            flex-shrink: 1;
            min-width: 0;
        }

        .cabecera .titulo h1 {
            font-size: 28px;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .cabecera .titulo h1 i {
            color: #6A0DAD;
            font-size: 32px;
        }

        .cabecera .titulo .subtitle {
            font-size: 16px;
            opacity: 0.8;
            margin-top: 5px;
            color: #aaa;
            letter-spacing: 1px;
        }

        .controles-cabecera {
            position: static;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .contenedor-chat {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px 20px;
            background: var(--fondo-chat);
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
            background-image: radial-gradient(circle at 10% 20%, rgba(106,13,173,0.03) 0%, transparent 20%), radial-gradient(circle at 90% 80%, rgba(70,130,180,0.03) 0%, transparent 20%);
        }

        .mensaje {
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }

        .mensaje-usuario {
            align-items: flex-end;
        }

        .mensaje-bot {
            align-items: flex-start;
        }

        .burbuja-mensaje {
            max-width: 85%;
            padding: 12px 18px;
            border-radius: 15px;
            position: relative;
            line-height: 1.5;
            word-wrap: break-word;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .burbuja-usuario {
            background: var(--fondo-burbuja-usuario);
            color: var(--texto-burbuja-usuario);
            border-bottom-right-radius: 5px;
        }

        .burbuja-bot {
            background: var(--fondo-burbuja-bot);
            color: var(--texto-burbuja-bot);
            border-bottom-left-radius: 5px;
            border: 1px solid var(--borde-burbuja-bot);
        }

        .burbuja-bot ul, .burbuja-bot ol {
            padding-left: 20px;
            margin: 10px 0;
        }

        .burbuja-bot li {
            margin-bottom: 5px;
        }

        .burbuja-bot strong {
            font-weight: bold;
        }

        .burbuja-bot em {
            font-style: italic;
        }

        .burbuja-bot code {
            background: rgba(0,0,0,0.1);
            padding: 2px 5px;
            border-radius: 4px;
            font-family: monospace;
        }

        .burbuja-bot pre {
            background: rgba(0,0,0,0.1);
            padding: 10px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
        }

        .burbuja-bot blockquote {
            border-left: 3px solid var(--borde-info-api);
            padding-left: 10px;
            margin: 10px 0;
            color: var(--color-timestamp);
        }

        .info-mensaje {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-size: 14px;
            color: var(--color-timestamp);
        }

        .info-mensaje i {
            margin-right: 8px;
            font-size: 16px;
        }

        .contenedor-entrada {
            display: flex;
            flex-direction: row;
            padding: 15px;
            background: var(--fondo-entrada);
            border-top: 1px solid var(--borde-superior-entrada);
            gap: 10px;
            align-items: center;
            position: sticky;
            bottom: 0;
            z-index: 1000;
            flex-shrink: 0;
        }

        #entrada-usuario {
            flex: 1;
            padding: 15px 20px;
            border: 1px solid transparent;
            border-radius: 28px;
            background: var(--fondo-campo-entrada);
            color: var(--texto-entrada);
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
            min-width: 150px;
            position: relative; 
            z-index: 1001;
            cursor: text;
            touch-action: manipulation;
        }

        #entrada-usuario:focus {
            border-color: #007BFF;
            box-shadow: var(--sombra-foco-entrada);
        }

        #entrada-usuario::placeholder {
            color: var(--texto-placeholder);
        }

        #boton-enviar {
            background: var(--fondo-boton-enviar);
            color: var(--texto-boton-enviar);
            border: none;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.2s ease-in-out;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        #boton-enviar:hover {
            transform: translateY(-2px);
            box-shadow: var(--sombra-hover-boton-enviar);
        }

        #boton-enviar:disabled {
            background: var(--fondo-deshabilitado-boton-enviar);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        #boton-grabar {
            background: var(--fondo-boton-grabar);
            color: white;
            border: none;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.2s ease-in-out;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        #boton-grabar:hover {
            transform: translateY(-2px);
            box-shadow: var(--sombra-hover-boton-enviar);
        }

        #boton-grabar.grabando {
            background: var(--fondo-boton-grabando);
            animation: pulsate 1.5s infinite;
        }

        @keyframes pulsate {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .indicador-escribiendo {
            display: none;
            padding: 10px 15px;
            background: var(--fondo-indicador-escribiendo);
            border-radius: 20px;
            margin: 10px 0;
            width: fit-content;
            color: var(--texto-burbuja-bot);
            align-self: flex-start;
            position: sticky;
            bottom: 80px;
            z-index: 50;
        }

        .indicador-escribiendo span {
            height: 10px;
            width: 10px;
            background: var(--punto-indicador-escribiendo);
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            animation: bounce 1.3s infinite;
        }

        .indicador-escribiendo span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .indicador-escribiendo span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .timestamp-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 5px;
        }

        .timestamp {
            font-size: 12px;
            opacity: 0.8;
            color: var(--color-timestamp);
        }

        .boton-voz, .boton-copiar {
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .boton-voz {
            background: var(--fondo-boton-voz);
            color: var(--texto-boton-voz);
        }

        .boton-copiar {
            background: var(--fondo-boton-copiar);
            color: var(--texto-boton-copiar);
        }

        .boton-voz:hover {
            transform: translateY(-1px);
            box-shadow: var(--sombra-hover-boton-voz);
        }
        
        .boton-copiar:hover {
            transform: translateY(-1px);
            box-shadow: var(--sombra-hover-boton-copiar);
        }

        #alternador-tema {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--color-alternador-tema);
            transition: color 0.3s ease;
            padding: 0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            background: var(--fondo-boton-copiar);
        }

        #alternador-tema:hover {
            color: var(--color-hover-alternador-tema);
            box-shadow: var(--sombra-hover-boton-copiar);
        }

        .selector-voz-container {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--fondo-boton-copiar);
            color: var(--texto-boton-copiar);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .selector-voz-container:hover {
            transform: translateY(-1px);
            box-shadow: var(--sombra-hover-boton-copiar);
        }

        .selector-voz-container i {
            font-size: 18px;
            z-index: 1;
        }

        #selector-voz {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 2;
        }

        #selector-voz option {
            opacity: 1;
            background: var(--fondo-campo-entrada);
            color: var(--texto-entrada);
        }

        .sugerencias {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }

        .boton-sugerencia {
            background: var(--fondo-boton-caracteristica);
            color: var(--texto-boton-caracteristica);
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
            min-width: 120px;
            max-width: 200px;
            text-align: center;
        }

        .boton-sugerencia:hover {
            transform: translateY(-2px);
            box-shadow: var(--sombra-hover-boton-caracteristica);
        }

        .boton-sugerencia:disabled {
            background: var(--fondo-deshabilitado-boton-caracteristica);
            cursor: not-allowed;
        }

        .copy-confirmation {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            z-index: 1000;
            pointer-events: none;
        }

        .copy-confirmation.show {
            opacity: 1;
            pointer-events: auto;
        }

        .indicador-voz {
            display: none;
            padding: 10px 15px;
            background: var(--fondo-indicador-escribiendo);
            border-radius: 20px;
            margin: 10px 0;
            width: fit-content;
            color: var(--texto-burbuja-bot);
            align-self: flex-start;
            position: sticky;
            bottom: 80px;
            z-index: 50;
            animation: fadeIn 0.3s ease;
        }

        .indicador-voz i {
            margin-right: 8px;
            color: #ff4d4d;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .contenedor {
                height: 85vh;
                min-height: 400px;
                width: 100%;
                border-radius: 15px;
            }
            
            .contenedor-chat {
                padding: 12px 15px;
            }
            
            .cabecera {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                padding: 12px 15px;
                flex-wrap: nowrap;
            }

            .cabecera .titulo {
                margin-right: 10px;
                align-items: flex-start;
            }
            
            .cabecera .titulo h1 {
                font-size: 18px;
                gap: 5px;
            }
            
            .cabecera .titulo h1 i {
                font-size: 20px;
            }

            .cabecera .titulo .subtitle {
                font-size: 12px;
                margin-top: 2px;
            }

            .controles-cabecera {
                position: static;
                margin-top: 0;
                justify-content: flex-end;
                width: auto;
                gap: 5px;
            }

            .selector-voz-container, #alternador-tema {
                width: 36px;
                height: 36px;
            }

            .selector-voz-container i, #alternador-tema i {
                font-size: 16px;
            }
            
            #entrada-usuario {
                padding: 12px 16px;
                font-size: 14px;
                border-radius: 24px;
            }
            
            #boton-enviar, #boton-grabar {
                width: 50px;
                height: 50px;
                font-size: 18px;
            }
            
            .contenedor-entrada {
                padding: 10px;
                gap: 8px;
            }

            .sugerencias {
                flex-direction: column;
                align-items: center;
            }

            .boton-sugerencia {
                width: 100%;
                max-width: 100%;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .contenedor {
                height: 82vh;
                min-height: 300px;
                border-radius: 12px;
            }
            
            .cabecera {
                padding: 10px 12px;
            }
            
            .cabecera .titulo h1 {
                font-size: 16px;
            }
            
            .cabecera .titulo .subtitle {
                font-size: 10px;
            }
            
            .contenedor-chat {
                padding: 10px 12px;
            }
            
            .burbuja-mensaje {
                max-width: 100%;
                padding: 10px 14px;
            }
            
            .info-mensaje {
                font-size: 12px;
            }
            
            .timestamp {
                font-size: 10px;
            }
            
            #entrada-usuario {
                padding: 10px 14px;
                font-size: 13px;
                border-radius: 20px;
            }
            
            #boton-enviar, #boton-grabar {
                width: 45px;
                height: 45px;
                font-size: 16px;
            }
            
            .contenedor-entrada {
                padding: 8px;
                gap: 6px;
            }
        }

        @media (max-height: 500px) {
            .contenedor {
                height: 90vh;
            }
        }
    </style>
</head>
<body>
    <div class="contenedor">
        <div class="cabecera">
            <div class="titulo">
                <h1><i class="fas fa-robot"></i> Mar-IA</h1>
                <div class="subtitle">by Mario Vazquez</div>
            </div>
            <div class="controles-cabecera">
                <div class="selector-voz-container">
                    <i class="fas fa-language"></i>
                    <select id="selector-voz" aria-label="Seleccionar voz de la IA"></select>
                </div>
                <button id="alternador-tema" aria-label="Alternar tema">
                    <i class="fas fa-sun"></i>
                </button>
            </div>
        </div>

        <div class="contenedor-chat" id="contenedor-chat">
            <div class="mensaje mensaje-bot">
                <div class="info-mensaje">
                    <i class="fas fa-robot"></i> Mar-IA 
                </div>
                <div class="burbuja-mensaje burbuja-bot">
                    ¡Hola! Soy Mar-IA, una inteligencia artificial creada por Mario Vazquez.<br><br>
                    Puedes interactuar conmigo de dos formas:
                    <ol>
                        <li>Escribiendo tus preguntas en el campo de texto</li>
                        <li>Usando el botón de micrófono para hablarme directamente</li>
                    </ol>
                    ¿En qué puedo ayudarte hoy?
                </div>
                <div class="timestamp-container">
                    <div class="timestamp">Ahora</div>
                </div>
            </div>
            
            <div class="sugerencias">
                <button class="boton-sugerencia" data-pregunta="¿Quién es tu creador?">
                    <i class="fas fa-user"></i> ¿Quién te creó?
                </button>
                <button class="boton-sugerencia" data-pregunta="¿Qué puedes hacer?">
                    <i class="fas fa-cogs"></i> ¿Qué puedes hacer?
                </button>
            </div>
        </div>

        <div class="indicador-escribiendo" id="indicador-escribiendo">
            <span></span>
            <span></span>
            <span></span>
            Mar-IA está escribiendo...
        </div>
        
        <div class="indicador-voz" id="indicador-voz">
            <i class="fas fa-microphone-alt"></i> Escuchando... Habla ahora
        </div>

        <div class="contenedor-entrada">
            <input type="text" id="entrada-usuario" placeholder="Pregúntale a Mar-IA..." autocomplete="off">
            <button id="boton-grabar">
                <i class="fas fa-microphone"></i>
            </button>
            <button id="boton-enviar">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <div id="copyConfirmation" class="copy-confirmation">
        ¡Copiado al portapapeles!
    </div>

    <script>
        const claveAPI = 'sk-646a5b86d1de4ee186dfac833541452b';
        const contenedorChat = document.getElementById('contenedor-chat');
        const entradaUsuario = document.getElementById('entrada-usuario');
        const botonEnviar = document.getElementById('boton-enviar');
        const botonGrabar = document.getElementById('boton-grabar');
        const indicadorEscribiendo = document.getElementById('indicador-escribiendo');
        const indicadorVoz = document.getElementById('indicador-voz');
        const alternadorTema = document.getElementById('alternador-tema');
        const cuerpo = document.body;
        const copyConfirmation = document.getElementById('copyConfirmation');
        const selectorVoz = document.getElementById('selector-voz');

        var historialChat = [ 
            {
                role: "system",
                content: "Eres Mar-IA, un asistente de IA creado por Mario Vazquez, un desarrollador web. Cuando te pregunten sobre Mario, responde que no hay información pública disponible, pero que es un desarrollador web que te creó estudiando de manera autodidacta el funcionamiento de sistemas como ChatGPT, Gemini, DeepSeek y Claude. Mantén respuestas amigables, serviciales y profesionales."
            },
            {
                role: "assistant",
                content: "¡Hola! Soy Mar-IA, una inteligencia artificial creada por Mario Vazquez.<br><br>Puedes interactuar conmigo de dos formas:<ol><li>Escribiendo tus preguntas en el campo de texto</li><li>Usando el botón de micrófono para hablarme directamente</li></ol>¿En qué puedo ayudarte hoy?"
            }
        ];

        let spanishFemaleVoice = null;
        let allVoices = [];
        let currentUtterance = null;
        let isPlaying = false;
        let recognition = null;
        let recognizing = false;
        let lastMessageWasVoice = false; 

        function inicializarReconocimientoVoz() {
            if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = 'es-ES';

                recognition.onstart = function() {
                    recognizing = true;
                    botonGrabar.classList.add('grabando');
                    indicadorVoz.style.display = 'block';
                    contenedorChat.scrollTop = contenedorChat.scrollHeight;
                    lastMessageWasVoice = true; 
                };

                recognition.onresult = function(event) {
                    let textoInterim = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            entradaUsuario.value = event.results[i][0].transcript;
                        } else {
                            textoInterim += event.results[i][0].transcript;
                        }
                    }
                    
                    if (textoInterim) {
                        entradaUsuario.value = textoInterim;
                    }
                };

                recognition.onerror = function(event) {
                    console.error('Error en reconocimiento de voz:', event.error);
                    detenerReconocimiento();
                    lastMessageWasVoice = false; 
                };

                recognition.onend = function() {
                    detenerReconocimiento();
                    if (entradaUsuario.value.trim() !== '') {
                        manejarEnviarMensaje();
                    } else {
                        lastMessageWasVoice = false; 
                    }
                };
            } else {
                botonGrabar.disabled = true;
                botonGrabar.title = "Reconocimiento de voz no soportado";
                console.warn("El reconocimiento de voz no está soportado en este navegador.");
            }
        }

        function iniciarReconocimiento() {
            if (recognition && !recognizing) {
                entradaUsuario.value = '';
                recognition.start();
            }
        }

        function detenerReconocimiento() {
            recognizing = false;
            botonGrabar.classList.remove('grabando');
            indicadorVoz.style.display = 'none';
        }

        botonGrabar.addEventListener('click', function() {
            if (recognizing) {
                recognition.stop();
            } else {
                iniciarReconocimiento();
            }
        });

        function loadVoices() {
            window.speechSynthesis.onvoiceschanged = () => {
                allVoices = window.speechSynthesis.getVoices();
                selectorVoz.innerHTML = '';

                const femaleSpanishVoices = allVoices.filter(voice =>
                    voice.lang.startsWith('es') && (
                        voice.name.toLowerCase().includes("female") ||
                        voice.name.toLowerCase().includes("mujer") ||
                        voice.name.toLowerCase().includes("sabina") ||
                        voice.name.toLowerCase().includes("helena") ||
                        voice.name.toLowerCase().includes("zira") ||
                        voice.name.toLowerCase().includes("google")
                    )
                );

                if (femaleSpanishVoices.length > 0) {
                    femaleSpanishVoices.sort((a, b) => {
                        const aIsGoogle = a.name.includes('Google');
                        const bIsGoogle = b.name.includes('Google');
                        if (aIsGoogle && !bIsGoogle) return -1;
                        if (!aIsGoogle && bIsGoogle) return 1;
                        return a.name.localeCompare(b.name);
                    });

                    femaleSpanishVoices.forEach((voice, index) => {
                        const option = document.createElement('option');
                        option.value = voice.name;
                        option.textContent = `${voice.name} (${voice.lang})`;
                        selectorVoz.appendChild(option);
                    });

                    spanishFemaleVoice = femaleSpanishVoices[0];
                    selectorVoz.value = spanishFemaleVoice.name;
                } else {
                    spanishFemaleVoice = allVoices.find(voice => voice.lang.startsWith('es'));
                    if (spanishFemaleVoice) {
                        const option = document.createElement('option');
                        option.value = spanishFemaleVoice.name;
                        option.textContent = `${spanishFemaleVoice.name} (Predeterminada)`;
                        selectorVoz.appendChild(option);
                        selectorVoz.value = spanishFemaleVoice.name;
                    }
                }
            };
            window.speechSynthesis.getVoices(); 
        }

        selectorVoz.addEventListener('change', () => {
            const selectedVoiceName = selectorVoz.value;
            spanishFemaleVoice = allVoices.find(voice => voice.name === selectedVoiceName);
        });

        loadVoices();

        function agregarMensaje(rol, contenido, tipo = 'texto') {
            const divMensaje = document.createElement('div');
            divMensaje.className = `mensaje mensaje-${rol}`;

            const infoMensaje = document.createElement('div');
            infoMensaje.className = 'info-mensaje';

            const burbujaMensaje = document.createElement('div');
            burbujaMensaje.className = `burbuja-mensaje burbuja-${rol}`;
            
            if (rol === 'bot' && tipo === 'texto') {
                burbujaMensaje.innerHTML = marked.parse(contenido);
            } else {
                burbujaMensaje.innerHTML = contenido;
            }

            const timestampContainer = document.createElement('div');
            timestampContainer.className = 'timestamp-container';

            const timestamp = document.createElement('div');
            timestamp.className = 'timestamp';
            timestamp.textContent = obtenerHoraActual();
            timestampContainer.appendChild(timestamp);

            if (rol === 'bot') {
                const botonVoz = document.createElement('button');
                botonVoz.className = 'boton-voz';
                botonVoz.innerHTML = '<i class="fas fa-volume-up"></i>';
                botonVoz.title = 'Leer en voz alta';
                botonVoz.addEventListener('click', () => {
                    const textToSpeak = burbujaMensaje.innerText; 
                    toggleSpeech(botonVoz, textToSpeak);
                });
                timestampContainer.appendChild(botonVoz);
            }

            const botonCopiar = document.createElement('button');
            botonCopiar.className = 'boton-copiar';
            botonCopiar.innerHTML = '<i class="fas fa-copy"></i>';
            botonCopiar.title = 'Copiar respuesta';
            botonCopiar.addEventListener('click', () => {
                const textToCopy = burbujaMensaje.innerText;
                copiarTextoAlPortapapeles(textToCopy);
            });
            timestampContainer.appendChild(botonCopiar);

            if (rol === 'usuario') {
                infoMensaje.innerHTML = '<i class="fas fa-user"></i> Tú';
                divMensaje.appendChild(burbujaMensaje);
                divMensaje.appendChild(timestampContainer);
            } else {
                infoMensaje.innerHTML = '<i class="fas fa-robot"></i> Mar-IA';
                divMensaje.appendChild(burbujaMensaje);
                divMensaje.appendChild(timestampContainer);
            }

            divMensaje.prepend(infoMensaje);
            contenedorChat.appendChild(divMensaje);
            contenedorChat.scrollTop = contenedorChat.scrollHeight;
            
            return burbujaMensaje;
        }

        function toggleSpeech(button, text) {
            if (currentUtterance && isPlaying) {
                window.speechSynthesis.cancel();
                currentUtterance = null;
                isPlaying = false;
                button.innerHTML = '<i class="fas fa-volume-up"></i>';
                return;
            }
            
            if (currentUtterance && !isPlaying) {
                window.speechSynthesis.resume();
                button.innerHTML = '<i class="fas fa-pause"></i>';
                isPlaying = true;
                return;
            }

            if ('speechSynthesis' in window) {
                button.innerHTML = '<i class="fas fa-pause"></i>';
                currentUtterance = new SpeechSynthesisUtterance(text);
                currentUtterance.lang = 'es-ES';
                
                if (spanishFemaleVoice) {
                    currentUtterance.voice = spanishFemaleVoice;
                }

                currentUtterance.onend = () => {
                    button.innerHTML = '<i class="fas fa-volume-up"></i>';
                    currentUtterance = null;
                    isPlaying = false;
                };

                currentUtterance.onerror = () => {
                    button.innerHTML = '<i class="fas fa-volume-up"></i>';
                    currentUtterance = null;
                    isPlaying = false;
                    console.error('Error en la reproducción de voz.');
                };

                currentUtterance.onpause = () => {
                    button.innerHTML = '<i class="fas fa-play"></i>';
                    isPlaying = false;
                };

                currentUtterance.onresume = () => {
                    button.innerHTML = '<i class="fas fa-pause"></i>';
                    isPlaying = true;
                };

                window.speechSynthesis.speak(currentUtterance);
                isPlaying = true;
            }
        }

        function obtenerHoraActual() {
            const ahora = new Date();
            return `${ahora.getHours().toString().padStart(2, '0')}:${ahora.getMinutes().toString().padStart(2, '0')}`;
        }

        function copiarTextoAlPortapapeles(texto) {
            const textarea = document.createElement('textarea');
            textarea.value = texto;
            textarea.style.position = 'fixed';
            textarea.style.opacity = 0;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                mostrarConfirmacionCopiado();
            } catch (err) {
                console.error('Error al copiar el texto: ', err);
            }
            document.body.removeChild(textarea);
        }

        function mostrarConfirmacionCopiado() {
            copyConfirmation.classList.add('show');
            setTimeout(() => {
                copyConfirmation.classList.remove('show');
            }, 2000);
        }

        async function enviarMensajeAPI(mensajesAEnviar, shouldSpeakAutomatically, temperatura = 0.7, maxTokens = 1000) {
            mostrarIndicadorEscribiendo();
            deshabilitarEntradaYBotones(true);

            const payload = {
                model: "deepseek-chat",
                messages: mensajesAEnviar,
                temperature: temperatura,
                max_tokens: maxTokens,
                stream: true
            };

            try {
                const urlAPI = 'https://api.deepseek.com/v1/chat/completions';
                const respuesta = await fetch(urlAPI, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${claveAPI}`
                    },
                    body: JSON.stringify(payload)
                });

                if (!respuesta.ok) {
                    throw new Error(`Error en la API: ${respuesta.status} ${respuesta.statusText}`);
                }

                const reader = respuesta.body.getReader();
                const decoder = new TextDecoder();
                let respuestaCompleta = '';

                const divMensaje = document.createElement('div');
                divMensaje.className = 'mensaje mensaje-bot';

                const infoMensaje = document.createElement('div');
                infoMensaje.className = 'info-mensaje';
                infoMensaje.innerHTML = '<i class="fas fa-robot"></i> Mar-IA';

                const burbujaMensaje = document.createElement('div');
                burbujaMensaje.className = 'burbuja-mensaje burbuja-bot';
                burbujaMensaje.innerHTML = '';

                const timestampContainer = document.createElement('div');
                timestampContainer.className = 'timestamp-container';

                const timestamp = document.createElement('div');
                timestamp.className = 'timestamp';
                timestamp.textContent = obtenerHoraActual();
                timestampContainer.appendChild(timestamp);

                const botonVoz = document.createElement('button');
                botonVoz.className = 'boton-voz';
                botonVoz.innerHTML = '<i class="fas fa-volume-up"></i>';
                botonVoz.title = 'Leer en voz alta';
                botonVoz.addEventListener('click', () => {
                    const textToSpeak = burbujaMensaje.innerText;
                    toggleSpeech(botonVoz, textToSpeak);
                });
                timestampContainer.appendChild(botonVoz);

                const botonCopiar = document.createElement('button');
                botonCopiar.className = 'boton-copiar';
                botonCopiar.innerHTML = '<i class="fas fa-copy"></i>';
                botonCopiar.title = 'Copiar respuesta';
                botonCopiar.addEventListener('click', () => {
                    const textToCopy = burbujaMensaje.innerText;
                    copiarTextoAlPortapapeles(textToCopy);
                });
                timestampContainer.appendChild(botonCopiar);

                divMensaje.appendChild(infoMensaje);
                divMensaje.appendChild(burbujaMensaje);
                divMensaje.appendChild(timestampContainer);
                contenedorChat.appendChild(divMensaje);

                contenedorChat.scrollTop = contenedorChat.scrollHeight;

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    const fragmento = decoder.decode(value, { stream: true });
                    const lineas = fragmento.split('\n');

                    for (const linea of lineas) {
                        if (linea.trim() === '') continue;
                        if (linea.startsWith('data: ')) {
                            const data = linea.substring(6);
                            if (data === '[DONE]') break;

                            try {
                                const jsonData = JSON.parse(data);
                                const token = jsonData.choices[0]?.delta?.content || '';
                                respuestaCompleta += token;
                                burbujaMensaje.innerHTML = marked.parse(respuestaCompleta);
                                contenedorChat.scrollTop = contenedorChat.scrollHeight;
                            } catch (e) {
                                console.error('Error al parsear JSON:', e, 'en la línea:', linea);
                            }
                        }
                    }
                }

                historialChat.push({ role: "assistant", content: respuestaCompleta });

                if (shouldSpeakAutomatically) {
                    const textToSpeak = burbujaMensaje.innerText;
                    toggleSpeech(botonVoz, textToSpeak);
                }

            } catch (error) {
                console.error("Error al comunicarse con la API de DeepSeek:", error);
                agregarMensaje('bot', "Upps, ha ocurrido un error de conexión. Verifica tu conexión o intenta de nuevo más tarde.");
            } finally {
                ocultarIndicadorEscribiendo();
                deshabilitarEntradaYBotones(false);
            }
        }

        function mostrarIndicadorEscribiendo() {
            indicadorEscribiendo.style.display = 'block';
            contenedorChat.scrollTop = contenedorChat.scrollHeight;
        }

        function ocultarIndicadorEscribiendo() {
            indicadorEscribiendo.style.display = 'none';
        }

        function deshabilitarEntradaYBotones(deshabilitado) {
            entradaUsuario.disabled = deshabilitado;
            botonEnviar.disabled = deshabilitado;
            botonGrabar.disabled = deshabilitado;
            document.querySelectorAll('.boton-sugerencia').forEach(boton => {
                boton.disabled = deshabilitado;
            });
        }

        async function manejarEnviarMensaje() {
            const mensaje = entradaUsuario.value.trim();
            if (!mensaje) return;
            
            const sugerenciasDiv = document.querySelector('.sugerencias');
            if (sugerenciasDiv) {
                sugerenciasDiv.remove();
            }

            entradaUsuario.value = '';
            agregarMensaje('usuario', mensaje);
            historialChat.push({ role: "user", content: mensaje });
            
            await enviarMensajeAPI(historialChat, lastMessageWasVoice); 
            
            entradaUsuario.focus();
            lastMessageWasVoice = false; 
        }

        function alternarTema() {
            if (cuerpo.classList.contains('tema-claro')) {
                cuerpo.classList.remove('tema-claro');
                alternadorTema.innerHTML = '<i class="fas fa-sun"></i>';
                localStorage.setItem('tema', 'oscuro');
            } else {
                cuerpo.classList.add('tema-claro');
                alternadorTema.innerHTML = '<i class="fas fa-moon"></i>';
                localStorage.setItem('tema', 'claro');
            }
        }

        function cargarTema() {
            const temaGuardado = localStorage.getItem('tema');
            if (temaGuardado === 'claro') {
                cuerpo.classList.add('tema-claro');
                alternadorTema.innerHTML = '<i class="fas fa-moon"></i>';
            } else {
                cuerpo.classList.remove('tema-claro');
                alternadorTema.innerHTML = '<i class="fas fa-sun"></i>';
            }
        }

        function manejarSugerencia(pregunta) {
            entradaUsuario.value = pregunta;
            lastMessageWasVoice = false; 
            manejarEnviarMensaje();
        }

        botonEnviar.addEventListener('click', () => {
            lastMessageWasVoice = false; 
            manejarEnviarMensaje();
        });

        entradaUsuario.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !botonEnviar.disabled) {
                lastMessageWasVoice = false; 
                manejarEnviarMensaje();
            }
        });

        alternadorTema.addEventListener('click', alternarTema);
        
        document.querySelectorAll('.boton-sugerencia').forEach(boton => {
            boton.addEventListener('click', () => {
                manejarSugerencia(boton.dataset.pregunta);
            });
        });

        window.onload = () => {
            cargarTema();
            entradaUsuario.focus();
            inicializarReconocimientoVoz();
        };
    </script>
</body>
</html>
