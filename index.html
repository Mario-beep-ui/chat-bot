<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUPER MAR-IA | Asistente Avanzado</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            font-size: 62.5%;
            --color-fondo: #1a1a1a;
            --color-contenedor: #242424;
            --color-texto: #f0f0f0;
            --fondo-burbuja-usuario: linear-gradient(135deg, #7f5af0, #5623c4);
            --texto-burbuja-usuario: #ffffff;
            --fondo-burbuja-bot: #3a3a3a;
            --texto-burbuja-bot: #f0f0f0;
            --borde-burbuja-bot: rgba(255, 255, 255, 0.1);
            --fondo-entrada: #242424;
            --borde-superior-entrada: rgba(255, 255, 255, 0.1);
            --fondo-campo-entrada: #3a3a3a;
            --texto-entrada: #ffffff;
            --texto-placeholder: #a0a0a0;
            --fondo-boton-enviar: #7f5af0;
            --texto-boton-enviar: white;
            --fondo-boton-accion: #3a3a3a;
            --texto-boton-accion: #f0f0f0;
            --fondo-boton-grabando: #e53935;
            --color-timestamp: #a0a0a0;
            --fondo-boton-control: #3a3a3a;
            --fondo-adjunto: #3a3a3a;
            --borde-adjunto: #555;
            --fondo-codigo: rgba(0,0,0,0.5);
            --borde-codigo: rgba(255,255,255,0.1);
            --fondo-boton-buscar-activo: #2dce89;
            --fondo-pensamiento: #2c2c3e;
            --borde-pensamiento: #4a4a6a;
            --fondo-pensamiento-hover: #35354d;
            --color-destacado: #7f5af0;
            --resaltado-pensamiento: rgba(127, 90, 240, 0.1);
            --fondo-modal-imagen: rgba(0,0,0,0.95);
            --color-mini: #ff9800;
            --fondo-generando-imagen: #7f5af0;
            --sombra: 0 10px 20px rgba(0,0,0,0.2), 0 6px 6px rgba(0,0,0,0.23);
        }
        body.tema-claro {
            --color-fondo: #f4f7f9;
            --color-contenedor: #ffffff;
            --color-texto: #333333;
            --fondo-burbuja-usuario: #7f5af0;
            --fondo-burbuja-bot: #eef2f7;
            --texto-burbuja-bot: #333333;
            --borde-burbuja-bot: #d1d9e6;
            --fondo-entrada: #ffffff;
            --borde-superior-entrada: #e0e0e0;
            --fondo-campo-entrada: #f0f4f8;
            --texto-entrada: #333333;
            --texto-placeholder: #666666;
            --fondo-boton-accion: #eef2f7;
            --texto-boton-accion: #333333;
            --fondo-boton-grabando: #D32F2F;
            --color-timestamp: #666666;
            --fondo-boton-control: #f0f4f8;
            --fondo-adjunto: #f0f4f8;
            --borde-adjunto: #d1d9e6;
            --fondo-codigo: rgba(0,0,0,0.05);
            --borde-codigo: rgba(0,0,0,0.1);
            --fondo-pensamiento: #eef5ff;
            --borde-pensamiento: #b1c8e4;
            --fondo-pensamiento-hover: #e4eef9;
            --color-destacado: #5e17eb;
            --resaltado-pensamiento: rgba(94, 23, 235, 0.1);
            --fondo-modal-imagen: rgba(255,255,255,0.98);
            --color-mini: #ff6f00;
            --fondo-generando-imagen: #5e17eb;
            --sombra: 0 10px 20px rgba(0,0,0,0.1), 0 6px 6px rgba(0,0,0,0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        html { height: 100%; }
        body { 
            height: 100dvh;
            background: var(--color-fondo); 
            color: var(--color-texto); 
            font-size: 1.6rem; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .contenedor {
            display: flex;
            flex-direction: column;
            width: 100%;
            background: var(--color-contenedor);
            flex: 1;
            min-height: 0;
            overflow: hidden;
            position: relative;
        }
        .cabecera { 
            flex-shrink: 0;
            padding: 1.5rem 2rem; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            z-index: 10;
            background: var(--color-contenedor);
            border-bottom: 1px solid var(--borde-superior-entrada);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .cabecera .titulo { display: flex; align-items: center; gap: 1.2rem; }
        .cabecera .titulo .fa-robot {
            font-size: 3rem;
            color: var(--color-destacado);
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-4px); }
            100% { transform: translateY(0px); }
        }
        .cabecera .titulo h1 { font-size: 2.2rem; font-weight: 700; margin: 0; cursor: pointer; transition: all 0.3s; position: relative; color: var(--color-destacado); }
        .contenedor-chat { 
            flex-grow: 1;
            overflow-y: auto; 
            padding: 2rem; 
            display: flex; 
            flex-direction: column; 
            gap: 2.5rem; 
            scroll-behavior: smooth; 
            transition: transform 0.3s ease-in-out;
        }
        .contenedor-chat.desplazado {
            transform: translateX(320px);
        }
        .contenedor-entrada-wrapper { 
            flex-shrink: 0;
            padding: 1.5rem 2rem; 
            background: transparent;
            z-index: 10;
        }
        .super-ia-gradient { background: linear-gradient(90deg, #7f5af0, #ff8c42, #87CEEB); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; -webkit-text-fill-color: transparent; animation: gradient-animation 5s ease-infinite; background-size: 200% 200%; }
        .mini-ia-gradient { background: linear-gradient(90deg, #ff9800, #ffeb3b, #ff9800); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; -webkit-text-fill-color: transparent; animation: gradient-animation 3s ease-infinite; background-size: 200% 200%; }
        @keyframes gradient-animation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .cabecera .subtitle { font-size: 1.3rem; opacity: 0.8; color: #aaa; margin-top: 0.2rem; }
        .controles-cabecera { display: flex; align-items: center; gap: 1rem; }
        .boton-control { background: var(--fondo-boton-control); border: 1px solid var(--borde-superior-entrada); font-size: 1.8rem; cursor: pointer; color: var(--color-texto); width: 4.2rem; height: 4.2rem; border-radius: 50%; display: flex; justify-content: center; align-items: center; transition: all 0.2s; }
        .boton-control:hover { background: var(--color-destacado); color: white; border-color: var(--color-destacado); transform: translateY(-2px); }
        .mensaje { display: flex; flex-direction: column; max-width: 85%; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(1.5rem); } to { opacity: 1; transform: translateY(0); } }
        .mensaje-usuario { align-self: flex-end; align-items: flex-end; }
        .mensaje-bot { align-self: flex-start; align-items: flex-start; }
        .burbuja-mensaje { 
            padding: 1.5rem 2rem; 
            border-radius: 2.2rem; 
            line-height: 1.7; 
            word-wrap: break-word; 
            max-width: 100%; 
            height: auto;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .burbuja-usuario { background: var(--fondo-burbuja-usuario); color: var(--texto-burbuja-usuario); border-bottom-right-radius: 0.6rem; }
        .burbuja-bot { background: var(--fondo-burbuja-bot); color: var(--texto-burbuja-bot); border: 1px solid var(--borde-burbuja-bot); border-bottom-left-radius: 0.6rem; }
        .mensaje-busqueda {
            align-self: flex-start;
            animation: fadeIn 0.4s ease-out;
        }
        .burbuja-busqueda {
            display: flex;
            align-items: center;
            gap: 1.2rem;
            padding: 1.5rem 2rem;
            background: var(--fondo-burbuja-bot);
            color: var(--texto-burbuja-bot);
            border: 1px solid var(--borde-burbuja-bot);
            border-radius: 2.2rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .burbuja-busqueda .fa-search {
            animation: pulse-search 1.5s infinite;
        }
        @keyframes pulse-search {
            0% { transform: scale(1); color: var(--color-destacado); }
            50% { transform: scale(1.2); color: white; }
            100% { transform: scale(1); color: var(--color-destacado); }
        }
        .pensamiento-container { 
            background: var(--fondo-pensamiento); 
            border: 1px solid var(--borde-pensamiento); 
            border-radius: 1.6rem; 
            animation: slideIn 0.4s ease-out; 
            overflow: hidden; 
            width: 100%;
            box-shadow: var(--sombra);
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .pensamiento-cabecera-clickable { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 2rem; cursor: pointer; transition: background-color 0.2s; }
        .pensamiento-cabecera-clickable:hover { background-color: var(--fondo-pensamiento-hover); }
        .pensamiento-titulo { font-weight: 600; color: var(--color-texto); display: flex; align-items: center; gap: 1rem; font-size: 1.6rem; }
        .pensamiento-titulo i { color: var(--color-destacado); }
        .pensamiento-controles-cabecera { display: flex; align-items: center; gap: 1.5rem; }
        .tiempo-pensamiento { font-size: 1.2rem; color: var(--color-timestamp); }
        .toggle-icon { font-size: 2rem; color: var(--color-timestamp); transition: transform 0.3s ease; }
        .toggle-icon.collapsed { transform: rotate(-180deg); }
        .pensamiento-contenido-wrapper { 
            overflow: hidden; 
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out; 
            max-height: 2000px;
        }
        .pensamiento-contenido-wrapper.collapsed { max-height: 0; padding-top: 0; padding-bottom: 0; border-top: none; }
        .contenido-pensamiento { 
            font-size: 1.4rem; 
            line-height: 1.7; 
            padding: 2rem; 
            border-top: 1px solid var(--borde-pensamiento); 
            background: var(--resaltado-pensamiento); 
            overflow-y: auto;
            max-height: 70vh;
        }
        .pensamiento-acciones { display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: flex-end; padding: 0 2rem 2rem; }
        .boton-pensamiento { background: rgba(255,255,255,0.08); border: 1px solid var(--borde-pensamiento); border-radius: 1rem; padding: 0.8rem 1.2rem; color: var(--color-texto); cursor: pointer; display: flex; align-items: center; gap: 0.8rem; transition: all 0.2s; font-size: 1.3rem; }
        .boton-pensamiento:hover { background: rgba(255,255,255,0.15); border-color: var(--color-destacado); }
        .bloque-codigo { position: relative; background: var(--fondo-codigo); border: 1px solid var(--borde-codigo); border-radius: 1.2rem; overflow: hidden; margin: 1.5rem 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .cabecera-codigo { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; background: rgba(0,0,0,0.3); border-bottom: 1px solid var(--borde-codigo); }
        .lenguaje-codigo { font-size: 1.4rem; font-weight: 500; color: #ccc; }
        .boton-copiar-codigo { background: transparent; border: none; color: var(--color-texto); cursor: pointer; display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem 1rem; border-radius: 0.6rem; font-size: 1.3rem; transition: all 0.2s; }
        .boton-copiar-codigo:hover { background: rgba(255,255,255,0.1); }
        .boton-copiar-codigo.copiado { color: #4CAF50; }
        .contenedor-codigo { overflow-x: auto; max-width: 100%; }
        .contenedor-codigo pre { margin: 0; padding: 1.8rem; font-family: 'Fira Code', 'Courier New', monospace; font-size: 1.4rem; }
        .timestamp-container { display: flex; align-items: center; gap: 1rem; margin-top: 1rem; }
        .timestamp { font-size: 1.2rem; color: var(--color-timestamp); }
        .boton-accion-mensaje { background: none; border: none; width: 3.2rem; height: 3.2rem; border-radius: 50%; cursor: pointer; font-size: 1.5rem; display: flex; justify-content: center; align-items: center; color: var(--color-timestamp); transition: all 0.2s; }
        .boton-accion-mensaje:hover { background: rgba(255,255,255,0.1); color: var(--color-destacado); }
        .contenedor-entrada { 
            display: flex; 
            flex-direction: column; 
            gap: 1.5rem; 
            width: 100%; 
            background-color: var(--fondo-campo-entrada); 
            border: 2px solid transparent; 
            border-radius: 2.8rem; 
            padding: 1.5rem 2rem; 
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .contenedor-entrada:focus-within { border-color: var(--color-destacado); box-shadow: 0 0 0 3px rgba(127, 90, 240, 0.3); }
        .contenedor-adjuntos { display: none; overflow-x: auto; overflow-y: hidden; white-space: nowrap; padding-bottom: 1rem; scrollbar-width: thin; border-bottom: 1px solid var(--borde-adjunto); margin-bottom: 0.5rem;}
        .adjunto-item { display: inline-flex; align-items: center; gap: 1rem; background: var(--fondo-adjunto); border: 1px solid var(--borde-adjunto); border-radius: 1.5rem; padding: 1rem 1.5rem; max-width: 25rem; margin-right: 1.2rem; }
        .icono-adjunto { font-size: 2.2rem; color: var(--color-destacado); }
        .detalles-adjunto { display: flex; flex-direction: column; min-width: 0; }
        .nombre-adjunto { font-size: 1.4rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tamano-adjunto { font-size: 1.2rem; color: var(--color-timestamp); }
        .boton-eliminar { background: transparent; border: none; border-radius: 50%; width: 2.8rem; height: 2.8rem; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #aaa; transition: all 0.2s; }
        .boton-eliminar:hover { color: #E53935; background: rgba(255, 0, 0, 0.1); }
        #entrada-usuario { 
            width: 100%; 
            border: none; 
            background: transparent; 
            color: var(--texto-entrada); 
            font-size: 1.7rem; 
            outline: none; 
            resize: none; 
            max-height: 20rem; 
            overflow-y: auto;
            padding: 0.5rem 0;
            scrollbar-width: thin;
            scrollbar-color: var(--color-destacado) transparent;
        }
        #entrada-usuario::-webkit-scrollbar { width: 6px; }
        #entrada-usuario::-webkit-scrollbar-thumb { background-color: var(--color-destacado); border-radius: 3px; }
        #entrada-usuario::-webkit-scrollbar-track { background: transparent; }
        .input-area-botones {
            display: flex;
            align-items: center;
            justify-content: space-around;
            width: 100%;
        }
        .boton-input { 
            background: var(--fondo-boton-accion); 
            color: var(--texto-boton-accion); 
            border: none; 
            width: 4.8rem; 
            height: 4.8rem; 
            border-radius: 50%; 
            cursor: pointer; 
            font-size: 2rem; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            transition: all 0.2s ease-out; 
            flex-shrink: 0; 
        }
        .boton-input:hover { transform: scale(1.1) rotate(10deg); background-color: var(--color-destacado); color: white; }
        #boton-enviar { background: var(--fondo-boton-enviar); color: var(--texto-boton-enviar); }
        #boton-enviar.pausa { 
            background: #ff9800; 
            animation: pulsate 1.5s infinite; 
        }
        #boton-grabar.grabando { 
            background: var(--fondo-boton-grabando); 
            animation: pulsate 1.5s infinite; 
            box-shadow: 0 0 0 4px rgba(229, 57, 53, 0.4);
        }
        .boton-input.modo-activo {
            background: var(--fondo-boton-buscar-activo) !important;
            color: white !important;
            animation: none !important;
        }
        @keyframes pulsate { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(127, 90, 240, 0.5); } 70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(127, 90, 240, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(127, 90, 240, 0); } }
        .indicador-escribiendo { display: flex; align-items: center; gap: 1rem; padding: 1.5rem 2rem; background: var(--fondo-burbuja-bot); border-radius: 2.2rem; width: fit-content; align-self: flex-start; animation: fadeIn 0.3s ease; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .indicador-escribiendo .puntos span { height: 0.8rem; width: 0.8rem; background: var(--color-timestamp); border-radius: 50%; display: inline-block; margin: 0 0.2rem; animation: bounce 1.3s infinite; }
        .indicador-escribiendo .puntos span:nth-child(2) { animation-delay: 0.2s; }
        .indicador-escribiendo .puntos span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-0.6rem); } }
        .fa-beat { animation: fa-beat 1.5s ease-in-out infinite; }
        @keyframes fa-beat { 0%, 100% { transform: scale(1); opacity: 0.7; } 50% { transform: scale(1.15); opacity: 1; } }
        .modal-ocr, .modal-modo, .modal-menu-principal { position: fixed; bottom: 12rem; right: 2rem; background: var(--fondo-entrada); border-radius: 1.8rem; box-shadow: var(--sombra); padding: 1.5rem; display: none; flex-direction: column; gap: 1rem; z-index: 2000; border: 1px solid var(--borde-superior-entrada); width: 30rem; animation: fadeIn-up 0.3s ease-out; }
        .modal-modo { top: 7.5rem; left: 50%; transform: translateX(-50%); bottom: auto; right: auto; }
        .modal-menu-principal { top: 7.5rem; right: 2rem; bottom: auto; }
        @keyframes fadeIn-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .opcion-ocr, .opcion-menu { background: var(--fondo-campo-entrada); color: var(--texto-entrada); border: none; border-radius: 1.2rem; padding: 1.5rem; display: flex; align-items: center; gap: 1.5rem; cursor: pointer; transition: all 0.2s; font-weight: 500; }
        .opcion-ocr:hover, .opcion-menu:hover { background: var(--color-destacado); color: white; transform: translateX(5px); }
        .opcion-ocr i, .opcion-menu i { font-size: 2rem; }
        #selector-voz { background: transparent; border: none; color: var(--texto-entrada); font-size: 1.5rem; flex-grow: 1; cursor: pointer; }
        #selector-voz:focus { outline: none; }
        body.tema-claro #selector-voz { color: var(--texto-entrada); }
        .opcion-modo { flex-direction: column; align-items: flex-start; }
        .opcion-modo-titulo { font-weight: 600; font-size: 1.6rem; display: flex; align-items: center; gap: 1rem; }
        .opcion-modo-desc { font-size: 1.3rem; opacity: 0.9; line-height: 1.5; }
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 1500; display: none; animation: fade-in-overlay 0.3s; }
        @keyframes fade-in-overlay { from { opacity: 0; } to { opacity: 1; } }
        .copy-confirmation { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%); background-color: #2dce89; color: white; padding: 1.2rem 2.5rem; border-radius: 2rem; font-size: 1.5rem; font-weight: 500; opacity: 0; transition: opacity 0.3s, transform 0.3s; z-index: 1000; pointer-events: none; box-shadow: var(--sombra); }
        .copy-confirmation.show { opacity: 1; transform: translate(-50%, -10px); }
        input[type="file"] { display: none; }
        .modal-super-ia, .modal-ayuda { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--color-contenedor); color: var(--color-texto); border-radius: 2rem; padding: 3rem; display: none; flex-direction: column; z-index: 2000; width: 90%; max-width: 600px; box-shadow: var(--sombra); border: 1px solid var(--borde-superior-entrada); animation: fadeInDown 0.5s ease-out; }
        @keyframes fadeInDown { from { opacity: 0; transform: translate(-50%, -55%); } to { opacity: 1; transform: translate(-50%, -50%); } }
        .modal-super-ia-contenido, .modal-ayuda-contenido { position: relative; }
        .cerrar-modal-super-ia, .cerrar-modal-ayuda { position: absolute; top: -1.5rem; right: -1.5rem; background: var(--fondo-boton-control); border: none; width: 3.5rem; height: 3.5rem; border-radius: 50%; font-size: 2rem; color: var(--color-texto); cursor: pointer; display: flex; justify-content: center; align-items: center; transition: all 0.3s; }
        .cerrar-modal-super-ia:hover, .cerrar-modal-ayuda:hover { background: var(--color-destacado); color: white; transform: scale(1.1) rotate(90deg); }
        .modal-super-ia h3, .modal-ayuda h3 { margin-top: 0; font-size: 2.4rem; margin-bottom: 2rem; text-align: center; color: var(--color-destacado); font-weight: 700; }
        .modal-super-ia p { font-size: 1.6rem; line-height: 1.6; margin: 0 0 2rem 0; text-align: center; }
        .comparacion-modos { display: flex; gap: 2rem; margin-top: 2rem; }
        .modo-card { flex: 1; background: var(--fondo-pensamiento); border-radius: 1.5rem; padding: 2rem; text-align: center; border: 1px solid var(--borde-pensamiento); }
        .modo-card h4 { margin-top: 0; font-size: 1.8rem; margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: center; gap: 1rem; color: var(--color-destacado); }
        .modo-card ul { text-align: left; padding-left: 1.8rem; margin-bottom: 0; }
        .modo-card li { margin-bottom: 1rem; font-size: 1.4rem; }
        .modo-card.super { border-color: #FFD700; position: relative; overflow: hidden; }
        .modo-card.super::after { content: 'RECOMENDADO'; position: absolute; top: 1rem; right: -3rem; background: #FFD700; color: #000; font-weight: bold; font-size: 1.1rem; padding: 0.5rem 3rem; transform: rotate(45deg); }
        .boton-entendido, .boton-ayuda { background: var(--fondo-boton-enviar); border: none; color: white; border-radius: 3rem; padding: 1.2rem 2.5rem; font-size: 1.6rem; font-weight: bold; cursor: pointer; transition: all 0.3s; margin-top: 2rem; width: 100%; }
        .boton-entendido:hover, .boton-ayuda:hover { filter: brightness(1.1); transform: translateY(-3px); box-shadow: 0 6px 12px rgba(127, 90, 240, 0.3); }
        .modal-ayuda { max-height: 80vh; overflow-y: auto; }
        .seccion-ayuda { margin-bottom: 2.5rem; }
        .seccion-ayuda h4 { font-size: 2rem; margin-bottom: 1.5rem; color: var(--color-destacado); display: flex; align-items: center; gap: 1rem; border-bottom: 2px solid var(--color-destacado); padding-bottom: 0.5rem; }
        .item-ayuda { display: flex; align-items: flex-start; gap: 1.5rem; margin-bottom: 2rem; }
        .item-ayuda .icono-ayuda { flex-shrink: 0; background: var(--fondo-boton-enviar); width: 4rem; height: 4rem; border-radius: 1.2rem; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: white; }
        .item-ayuda .contenido-ayuda { flex: 1; }
        .item-ayuda .titulo-item { font-weight: bold; margin-bottom: 0.5rem; font-size: 1.7rem; }
        .item-ayuda .descripcion-item { font-size: 1.5rem; line-height: 1.6; }
        .modal-imagen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--fondo-modal-imagen); display: flex; justify-content: center; align-items: center; z-index: 3000; display: none; backdrop-filter: blur(10px); }
        .contenido-modal-imagen { position: relative; max-width: 90%; max-height: 90%; display: flex; justify-content: center; align-items: center; }
        .modal-imagen img { max-width: 100%; max-height: 90vh; object-fit: contain; border-radius: 1.5rem; box-shadow: 0 20px 40px rgba(0,0,0,0.5); }
        .botones-modal-imagen { position: absolute; top: 2rem; right: 2rem; display: flex; gap: 1.5rem; }
        .boton-modal-imagen { background: rgba(255,255,255,0.15); border: none; width: 5rem; height: 5rem; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: all 0.3s; color: white; font-size: 2.4rem; backdrop-filter: blur(5px); }
        .boton-modal-imagen:hover { background: var(--color-destacado); transform: scale(1.1); }
        .boton-generar-imagen { background: var(--fondo-boton-accion) ; color: white; border: none; border-radius: 50%; width: 4.8rem; height: 4.8rem; cursor: pointer; font-size: 2rem; display: flex; justify-content: center; align-items: center; transition: all 0.2s; flex-shrink: 0; }
        .boton-generar-imagen:hover { transform: scale(1.1) rotate(10deg); background: #6d1dc4; }
        .boton-generar-imagen.modo-activo { background: var(--fondo-boton-enviar); animation: none !important; }
        .indicador-generando-imagen { display: flex; align-items: center; gap: 1rem; padding: 1rem 1.5rem; background: var(--fondo-generando-imagen); color: white; border-radius: 1.8rem; width: fit-content; align-self: flex-start; animation: fadeIn 0.3s ease; }
        .loader { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .modal-mini-aviso { position: fixed; top: 1.5rem; left: 50%; transform: translateX(-50%); background-color: #FFC107; color: #000; padding: 1.2rem 2rem; border-radius: 1.2rem; z-index: 5000; display: none; align-items: center; gap: 1rem; font-size: 1.5rem; font-weight: 500; box-shadow: var(--sombra); animation: slideDownFadeIn 0.5s ease-out forwards; }
        @keyframes slideDownFadeIn { from { opacity: 0; transform: translate(-50%, -100%); } to { opacity: 1; transform: translate(-50%, 0); } }
        @keyframes slideUpFadeOut { from { opacity: 1; transform: translate(-50%, 0); } to { opacity: 0; transform: translate(-50%, -100%); } }
        #boton-enviar.cargando .fa-paper-plane { display: none; }
        #boton-enviar.cargando { background: var(--fondo-boton-enviar); }
        .loader-dots { width: 2.4rem; height: 2.4rem; position: relative; }
        .loader-dots span { position: absolute; width: 0.7rem; height: 0.7rem; background-color: white; border-radius: 50%; animation: loader-anim 1.2s infinite; }
        .loader-dots span:nth-child(1) { top: 0; left: 50%; transform: translateX(-50%); animation-delay: -1.05s; }
        .loader-dots span:nth-child(2) { top: 15%; right: 15%; animation-delay: -0.9s; }
        .loader-dots span:nth-child(3) { top: 50%; right: 0; transform: translateY(-50%); animation-delay: -0.75s; }
        .loader-dots span:nth-child(4) { bottom: 15%; right: 15%; animation-delay: -0.6s; }
        .loader-dots span:nth-child(5) { bottom: 0; left: 50%; transform: translateX(-50%); animation-delay: -0.45s; }
        .loader-dots span:nth-child(6) { bottom: 15%; left: 15%; animation-delay: -0.3s; }
        .loader-dots span:nth-child(7) { top: 50%; left: 0; transform: translateY(-50%); animation-delay: -0.15s; }
        .loader-dots span:nth-child(8) { top: 15%; left: 15%; animation-delay: 0s; }
        @keyframes loader-anim { 0%, 100% { transform: scale(0.2); opacity: 0.5; } 40% { transform: scale(1); opacity: 1; } }
        .panel-historial {
            position: fixed;
            top: 0;
            left: 0;
            width: 320px;
            height: 100vh;
            background: var(--color-contenedor);
            z-index: 2000;
            overflow-y: auto;
            transform: translateX(-100%);
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 5px 0 25px rgba(0,0,0,0.3);
            border-right: 1px solid var(--borde-superior-entrada);
        }
        .panel-historial.abierto {
            transform: translateX(0);
        }
        .cabecera-panel-historial {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--borde-superior-entrada);
            position: sticky;
            top: 0;
            background: var(--color-contenedor);
            z-index: 10;
        }
        .cabecera-panel-historial h2 {
            margin: 0;
            font-size: 2rem;
            color: var(--color-destacado);
        }
        .boton-cerrar-historial {
            background: transparent;
            border: none;
            color: var(--color-texto);
            font-size: 2.2rem;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 50%;
            width: 4rem;
            height: 4rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .boton-cerrar-historial:hover {
            background: var(--fondo-pensamiento);
            color: var(--color-destacado);
            transform: rotate(90deg);
        }
        .buscar-historial {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--borde-superior-entrada);
        }
        .input-buscar-historial {
            width: 100%;
            padding: 1.2rem 1.8rem;
            background: var(--fondo-campo-entrada);
            border: 1px solid var(--borde-adjunto);
            border-radius: 2.4rem;
            color: var(--texto-entrada);
            font-size: 1.5rem;
        }
        .input-buscar-historial::placeholder {
            color: var(--texto-placeholder);
        }
        .lista-historial {
            padding: 1rem 0;
        }
        .item-historial {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--borde-superior-entrada);
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            flex-direction: column;
        }
        .item-historial:hover {
            background: var(--fondo-pensamiento);
        }
        .item-historial.seleccionado {
            background: var(--resaltado-pensamiento);
            border-left: 4px solid var(--color-destacado);
        }
        .titulo-conversacion {
            font-weight: 600;
            margin-bottom: 0.5rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 1.6rem;
        }
        .fecha-conversacion {
            font-size: 1.2rem;
            color: var(--color-timestamp);
        }
        .preview-conversacion {
            font-size: 1.4rem;
            margin-top: 0.8rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--color-timestamp);
        }
        .acciones-item-historial {
            display: flex;
            justify-content: flex-end;
            margin-top: 1rem;
            gap: 1rem;
        }
        .boton-accion-item {
            background: transparent;
            border: none;
            color: var(--color-timestamp);
            font-size: 1.6rem;
            cursor: pointer;
            transition: all 0.2s;
            padding: 0.8rem;
            border-radius: 50%;
            width: 3.6rem;
            height: 3.6rem;
        }
        .boton-accion-item:hover {
            color: var(--color-destacado);
            background: rgba(127, 90, 240, 0.1);
        }
        .boton-nueva-conversacion {
            display: block;
            width: calc(100% - 40px);
            margin: 1.5rem 2rem;
            padding: 1.5rem;
            background: var(--fondo-boton-enviar);
            color: white;
            border: none;
            border-radius: 3rem;
            font-weight: 600;
            font-size: 1.6rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        .boton-nueva-conversacion:hover {
            filter: brightness(1.1);
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(127, 90, 240, 0.3);
        }
        .sin-conversaciones {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--color-timestamp);
            font-style: italic;
        }
        .boton-menu-historial {
            position: relative;
        }
        .contador-historial {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--fondo-boton-grabando);
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid var(--color-contenedor);
        }
        .overlay-historial {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            z-index: 1500;
            display: none;
            animation: fade-in-overlay 0.3s;
        }
        #boton-scroll-final {
            position: absolute;
            bottom: 12rem;
            right: 2rem;
            width: 4.5rem;
            height: 4.5rem;
            background: var(--fondo-boton-accion);
            color: var(--texto-boton-accion);
            border: 1px solid var(--borde-adjunto);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            box-shadow: var(--sombra);
            transition: opacity 0.3s, transform 0.3s;
        }
        #boton-scroll-final:hover {
            background: var(--color-destacado);
            color: white;
            transform: scale(1.1);
        }
        #boton-scroll-final.visible {
            display: flex;
        }
        #live-conversation-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100dvh;
            background: radial-gradient(circle, #2a2a3e 0%, #1a1a2a 100%);
            z-index: 9999;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.5s ease;
            color: white;
        }
        #live-conversation-screen.visible {
            display: flex;
            opacity: 1;
        }
        .robot-container {
            position: relative;
            width: 300px;
            height: 300px;
        }
        #robot-svg {
            width: 100%;
            height: 100%;
        }
        .robot-eye {
            animation: blink 4s infinite ease-in-out;
            transform-origin: center;
        }
        @keyframes blink {
            0%, 95%, 100% { transform: scaleY(1); }
            97.5% { transform: scaleY(0.05); }
        }
        .robot-mouth {
            transition: d 0.2s ease-in-out;
        }
        #robot-svg.talking .robot-mouth {
            animation: talk 0.4s infinite ease-in-out;
        }
        @keyframes talk {
            0%, 100% { d: path('M 120 200 Q 150 210 180 200'); }
            50% { d: path('M 125 205 Q 150 230 175 205'); }
        }
        .listening-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            transform: translate(-50%, -50%);
            border: 3px solid rgba(127, 90, 240, 0);
            border-radius: 50%;
            animation: listen-pulse 2s infinite;
            display: none;
        }
        #robot-svg.listening .listening-indicator {
            display: block;
        }
        @keyframes listen-pulse {
            0% {
                transform: translate(-50%, -50%) scale(0.8);
                border-color: rgba(127, 90, 240, 0.7);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.5);
                border-color: rgba(127, 90, 240, 0);
                opacity: 0;
            }
        }
        .live-status {
            margin-top: 2rem;
            font-size: 2rem;
            font-weight: 500;
            min-height: 3rem;
            text-align: center;
            padding: 0 2rem;
            color: #ccc;
        }
        .live-controls {
            position: absolute;
            bottom: 5%;
            display: flex;
            gap: 2rem;
        }
        .live-control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 7rem;
            height: 7rem;
            border-radius: 50%;
            font-size: 3rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }
        .live-control-btn:hover {
            background: var(--color-destacado);
            transform: scale(1.1);
        }
        #close-live-btn {
            background: #e53935;
        }
        #close-live-btn:hover {
             background: #c62828;
        }
        @media (max-width: 768px) {
            .panel-historial { width: 90%; }
            .contenedor-chat.desplazado { transform: translateX(90%); }
            .modal-menu-principal { width: calc(100% - 4rem); left: 2rem; right: 2rem; }
        }
        
        .live-modal {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 3000;
      }
      .live-modal.oculto { display: none; }
      .live-modal-contenido {
        background: #fff;
        color: #333;
        padding: 2rem;
        border-radius: 1rem;
        width: 90%;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      }
      .cerrar-modal {
        position: absolute;
        top: 15px; right: 20px;
        font-size: 2rem;
        cursor: pointer;
        color: #fff;
      }
    </style>
</head>
<body>
    <div class="modal-mini-aviso" id="modal-mini-aviso">
        <i class="fas fa-exclamation-triangle"></i>
        <span>Este modo (Mar-IA mini) está en desarrollo y puede presentar errores.</span>
    </div>
    
    <div class="panel-historial" id="panel-historial">
        <div class="cabecera-panel-historial">
            <h2><i class="fas fa-history"></i> Historial</h2>
            <button class="boton-cerrar-historial" id="boton-cerrar-historial">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="buscar-historial">
            <input type="text" class="input-buscar-historial" id="input-buscar-historial" placeholder="Buscar conversación...">
        </div>
        <button class="boton-nueva-conversacion" id="boton-nueva-conversacion">
            <i class="fas fa-plus"></i> Nueva conversación
        </button>
        <div class="lista-historial" id="lista-historial"></div>
    </div>
    
    <div class="overlay-historial" id="overlay-historial"></div>
    
    <div class="contenedor">
        <header class="cabecera">
            <div class="titulo">
                <i class="fas fa-robot"></i>
                <div>
                    <h1 id="titulo-modo">Mar-IA</h1>
                    <div class="subtitle">by Mario Vazquez</div>
                </div>
            </div>
            <div class="controles-cabecera">
                <button id="start-live-btn" class="boton-control" aria-label="Iniciar conversación por voz" title="Conversación Live">
                    <i class="fas fa-headset"></i>
                </button>
                <button id="boton-menu-principal" class="boton-control" aria-label="Abrir menú de configuración" title="Configuración">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </header>

        <main class="contenedor-chat" id="contenedor-chat"></main>
        
        <button id="boton-scroll-final" title="Ir al final">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg>
        </button>

        <div class="contenedor-entrada-wrapper" id="contenedor-entrada-wrapper">
            <div class="contenedor-entrada">
                <div class="contenedor-adjuntos" id="contenedor-adjuntos"></div>
                <textarea id="entrada-usuario" placeholder="Pregúntale a Mar-IA..." rows="1"></textarea>
                <div class="input-area-botones">
                    <button id="boton-mas" class="boton-input" title="Adjuntar archivo"><i class="fas fa-paperclip"></i></button>
                    <button id="boton-buscar" class="boton-input" title="Buscar en internet"><i class="fas fa-search"></i></button>
                    <button id="boton-grabar" class="boton-input" title="Grabar voz"><i class="fas fa-microphone"></i></button>
                    <button id="boton-generar-imagen" class="boton-generar-imagen" title="Modo Picasso (generar imagen)"><i class="fas fa-paint-brush"></i></button>
                    <button id="boton-enviar" class="boton-input" title="Enviar mensaje"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div id="live-conversation-screen">
        <div class="robot-container">
            <div class="listening-indicator"></div>
            <svg id="robot-svg" viewBox="0 0 300 300">
                <path d="M 50 100 A 100 100 0 0 1 250 100 L 250 200 A 100 100 0 0 1 50 200 Z" fill="#3a3a3a" stroke="#7f5af0" stroke-width="4"/>
                <circle class="robot-eye" cx="110" cy="140" r="15" fill="#87CEEB"/>
                <circle class="robot-eye" cx="190" cy="140" r="15" fill="#87CEEB"/>
                <path class="robot-mouth" d="M 120 200 Q 150 210 180 200" stroke="#87CEEB" stroke-width="5" fill="none" stroke-linecap="round"/>
            </svg>
        </div>
        <div class="live-status" id="live-status">Toca el micrófono para empezar</div>
        <div class="live-controls">
            <button id="pause-live-btn" class="live-control-btn" title="Pausar/Reanudar escucha">
                <i class="fas fa-microphone"></i>
            </button>
            <button id="close-live-btn" class="live-control-btn" title="Cerrar conversación">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <input type="file" id="input-imagen" accept="image/*" multiple>
    <input type="file" id="input-camara" accept="image/*" capture="camera">
    <input type="file" id="input-archivo" multiple>

    <div class="modal-imagen" id="modal-imagen">
        <div class="contenido-modal-imagen">
            <div class="botones-modal-imagen">
                <button class="boton-modal-imagen" id="descargar-imagen" title="Descargar imagen"><i class="fas fa-download"></i></button>
                <button class="boton-modal-imagen" id="cerrar-modal-imagen" title="Cerrar"><i class="fas fa-times"></i></button>
            </div>
            <img id="imagen-ampliada" src="" alt="Imagen generada por Mar-IA">
        </div>
    </div>
    
    <div class="modal-ocr" id="modal-ocr">
        <button class="opcion-ocr" id="tomar-foto"><i class="fas fa-camera"></i> Tomar foto</button>
        <button class="opcion-ocr" id="elegir-galeria"><i class="fas fa-images"></i> Elegir de galería</button>
        <button class="opcion-ocr" id="elegir-archivo"><i class="fas fa-file-alt"></i> Subir archivo</button>
        <button class="opcion-ocr" id="activar-busqueda-modal"><i class="fas fa-search"></i> Buscar en internet</button>
    </div>
    
    <div class="modal-modo" id="modal-modo">
        <div class="opcion-modo" data-modo="normal">
            <div class="opcion-modo-titulo"><i class="fas fa-comment-alt"></i><span>Mar-IA</span></div>
            <div class="opcion-modo-desc">Respuesta directa y rápida.</div>
        </div>
        <div class="opcion-modo" data-modo="super">
            <div class="opcion-modo-titulo"><i class="fas fa-brain"></i><span>SUPER MAR-IA</span></div>
            <div class="opcion-modo-desc">Usa el modelo de razonamiento avanzado para respuestas profundas.</div>
        </div>
        <div class="opcion-modo" data-modo="mini">
            <div class="opcion-modo-titulo"><i class="fas fa-bolt"></i><span>Mar-IA mini</span></div>
            <div class="opcion-modo-desc">Respuestas ultra rápidas y breves, ideal para consultas simples.</div>
        </div>
    </div>

    <div class="modal-menu-principal" id="modal-menu-principal">
        <button class="opcion-menu" id="menu-historial">
            <i class="fas fa-history"></i><span>Historial</span>
            <span class="contador-historial" id="contador-historial-menu">0</span>
        </button>
        <button class="opcion-menu" id="menu-ayuda"><i class="fas fa-question-circle"></i><span>Ayuda</span></button>
        <button class="opcion-menu" id="menu-tema"><i class="fas fa-sun"></i><span>Alternar Tema</span></button>
        <div class="opcion-menu">
            <i class="fas fa-language"></i>
            <select id="selector-voz" aria-label="Seleccionar voz de la IA"></select>
        </div>
    </div>
    
    <div class="modal-super-ia" id="modal-super-ia">
        <div class="modal-super-ia-contenido">
            <button class="cerrar-modal-super-ia" id="cerrar-modal-super-ia">&times;</button>
            <h3><i class="fas fa-crown"></i> Modo SUPER MAR-IA Activado</h3>
            <p>Este modo es más avanzado y utiliza un modelo de razonamiento profundo para analizar tus preguntas y generar respuestas de mayor calidad.</p>
            <div class="comparacion-modos">
                <div class="modo-card">
                    <h4><i class="fas fa-comment-alt"></i> Mar-IA</h4>
                    <ul><li>Respuestas rápidas</li><li>Ideal para consultas simples</li><li>Menor consumo de recursos</li><li>Respuestas directas</li></ul>
                </div>
                <div class="modo-card super">
                    <h4><i class="fas fa-brain"></i> SUPER MAR-IA</h4>
                    <ul><li>Respuestas más inteligentes</li><li>Análisis profundo de problemas</li><li>Mayor precisión en respuestas</li><li>Capacidad de razonamiento</li><li>Procesamiento más lento</li></ul>
                </div>
            </div>
            <button class="boton-entendido" id="boton-entendido">¡Entendido! Empezar a usar</button>
        </div>
    </div>
    
    <div class="modal-ayuda" id="modal-ayuda">
        <div class="modal-ayuda-contenido">
            <button class="cerrar-modal-ayuda" id="cerrar-modal-ayuda">&times;</button>
            <h3><i class="fas fa-question-circle"></i> Guía de Ayuda</h3>
            <div class="seccion-ayuda">
                <h4><i class="fas fa-exchange-alt"></i> Cambiar entre modos</h4>
                <ul><li>Para cambiar entre los modos Mar-IA, SUPER MAR-IA y Mar-IA mini, haz clic en el título principal en la parte superior.</li><li>Se abrirá un menú donde podrás seleccionar el modo deseado.</li><li>El modo SUPER MAR-IA es más lento pero ofrece respuestas más inteligentes mediante un análisis profundo.</li><li>El modo Mar-IA mini ofrece respuestas ultra rápidas y breves.</li></ul>
            </div>
            <div class="seccion-ayuda">
                <h4><i class="fas fa-sliders-h"></i> Funciones de los controles</h4>
                <div class="item-ayuda"><div class="icono-ayuda"><i class="fas fa-paperclip"></i></div><div class="contenido-ayuda"><div class="titulo-item">Adjuntar y exportar</div><div class="descripcion-item">Permite adjuntar archivos para OCR.</div></div></div>
                <div class="item-ayuda"><div class="icono-ayuda"><i class="fas fa-search"></i></div><div class="contenido-ayuda"><div class="titulo-item">Buscar en internet</div><div class="descripcion-item">Activa el modo de búsqueda para que Mar-IA busque información en internet antes de responder.</div></div></div>
                <div class="item-ayuda"><div class="icono-ayuda"><i class="fas fa-microphone"></i></div><div class="contenido-ayuda"><div class="titulo-item">Grabar voz</div><div class="descripcion-item">Permite dictar tu mensaje mediante reconocimiento de voz.</div></div></div>
                <div class="item-ayuda"><div class="icono-ayuda"><i class="fas fa-language"></i></div><div class="contenido-ayuda"><div class="titulo-item">Seleccionar voz</div><div class="descripcion-item">Cambia la voz que utiliza Mar-IA para leer las respuestas en voz alta.</div></div></div>
                <div class="item-ayuda"><div class="icono-ayuda"><i class="fas fa-sun"></i></div><div class="contenido-ayuda"><div class="titulo-item">Alternar tema</div><div class="descripcion-item">Cambia entre modo claro y modo oscuro.</div></div></div>
                <div class="item-ayuda"><div class="icono-ayuda"><i class="fas fa-paint-brush"></i></div><div class="contenido-ayuda"><div class="titulo-item">Modo Picasso</div><div class="descripcion-item">Activa la generación de imágenes. Las solicitudes se convertirán en imágenes visuales.</div></div></div>
                <div class="item-ayuda"><div class="icono-ayuda"><i class="fas fa-history"></i></div><div class="contenido-ayuda"><div class>Historial de conversaciones</div><div class="descripcion-item">Accede a todas tus conversaciones anteriores, crea nuevas o elimina las existentes.</div></div></div>
            </div>
            <button class="boton-ayuda" id="cerrar-modal-ayuda-btn"><i class="fas fa-check"></i> Entendido</button>
        </div>
    </div>
    
    <div class="overlay" id="overlay"></div>
    <div id="confirmacionCopia" class="copy-confirmation">¡Copiado!</div>
    
 <!-- Modal Live -->
     <div id="liveModal" class="live-modal oculto">
        <div class="live-modal-contenido">
        <span id="cerrarLiveModal" class="cerrar-modal">&times;</span>
        <h2>Modo Live</h2>
        <p>El Modo Live sigue en desarrollo e investigación, puede presentar   detalles.</p>
       </div>
     </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const CLAVE_API_DEEPSEEK = 'sk-646a5b86d1de4ee186dfac833541452b'; 
            const CLAVE_API_OCR = 'K82439722788957';
            const CLAVE_API_GROQ = "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";

            
            const ESTILOS_DOCUMENTO = {
                'moderno': { 
                    titulo: 'Moderno',
                    fuente: 'Helvetica',
                    tamanoTitulo: 20,
                    tamanoSubtitulo: 16,
                    tamanoCuerpo: 11,
                    interlineado: 1.5,
                    colorTitulo: '#2C2C2C',
                    colorTexto: '#333333',
                    alineacion: 'left'
                },
                'clasico': {
                    titulo: 'Clásico',
                    fuente: 'Times New Roman',
                    tamanoTitulo: 18,
                    tamanoSubtitulo: 14,
                    tamanoCuerpo: 12,
                    interlineado: 1.15,
                    colorTitulo: '#000000',
                    colorTexto: '#000000',
                    alineacion: 'center'
                },
                'tecnico': {
                    titulo: 'Técnico',
                    fuente: 'Arial',
                    tamanoTitulo: 16,
                    tamanoSubtitulo: 14,
                    tamanoCuerpo: 11,
                    interlineado: 1.2,
                    colorTitulo: '#1E1E1E',
                    colorTexto: '#1E1E1E',
                    alineacion: 'left'
                },
                'creativo': {
                    titulo: 'Creativo',
                    fuente: 'Montserrat',
                    tamanoTitulo: 22,
                    tamanoSubtitulo: 16,
                    tamanoCuerpo: 12,
                    interlineado: 1.6,
                    colorTitulo: '#8A2BE2',
                    colorTexto: '#333333',
                    alineacion: 'left'
                },
                'apa': {
                    titulo: 'APA',
                    fuente: 'Times New Roman',
                    tamanoTitulo: 12,
                    tamanoSubtitulo: 12,
                    tamanoCuerpo: 12,
                    interlineado: 2,
                    colorTitulo: '#000000',
                    colorTexto: '#000000',
                    alineacion: 'left'
                }
            };

            const elementos = {
                body: document.body,
                contenedor: document.querySelector('.contenedor'),
                contenedorChat: document.getElementById('contenedor-chat'),
                entradaUsuario: document.getElementById('entrada-usuario'),
                botonEnviar: document.getElementById('boton-enviar'),
                botonGrabar: document.getElementById('boton-grabar'),
                botonMas: document.getElementById('boton-mas'),
                botonBuscar: document.getElementById('boton-buscar'),
                botonGenerarImagen: document.getElementById('boton-generar-imagen'),
                inputImagen: document.getElementById('input-imagen'),
                inputCamara: document.getElementById('input-camara'),
                inputArchivo: document.getElementById('input-archivo'),
                modalOcr: document.getElementById('modal-ocr'),
                modalModo: document.getElementById('modal-modo'),
                overlay: document.getElementById('overlay'),
                btnTomarFoto: document.getElementById('tomar-foto'),
                btnGaleria: document.getElementById('elegir-galeria'),
                btnArchivo: document.getElementById('elegir-archivo'),
                alternadorTema: document.getElementById('menu-tema'),
                confirmacionCopia: document.getElementById('confirmacionCopia'),
                selectorVoz: document.getElementById('selector-voz'),
                contenedorAdjuntos: document.getElementById('contenedor-adjuntos'),
                btnActivarBusquedaModal: document.getElementById('activar-busqueda-modal'),
                tituloModo: document.getElementById('titulo-modo'),
                modalSuperIA: document.getElementById('modal-super-ia'),
                cerrarModalSuperIA: document.getElementById('cerrar-modal-super-ia'),
                botonEntendido: document.getElementById('boton-entendido'),
                botonAyuda: document.getElementById('menu-ayuda'),
                modalAyuda: document.getElementById('modal-ayuda'),
                cerrarModalAyuda: document.getElementById('cerrar-modal-ayuda'),
                cerrarModalAyudaBtn: document.getElementById('cerrar-modal-ayuda-btn'),
                entradaWrapper: document.getElementById('contenedor-entrada-wrapper'),
                modalImagen: document.getElementById('modal-imagen'),
                imagenAmpliada: document.getElementById('imagen-ampliada'),
                cerrarModalImagen: document.getElementById('cerrar-modal-imagen'),
                descargarImagenBtn: document.getElementById('descargar-imagen'),
                modalMiniAviso: document.getElementById('modal-mini-aviso'),
                botonScrollFinal: document.getElementById('boton-scroll-final'),
                botonMenuPrincipal: document.getElementById('boton-menu-principal'),
                modalMenuPrincipal: document.getElementById('modal-menu-principal'),
                startLiveBtn: document.getElementById('start-live-btn'),
                liveScreen: document.getElementById('live-conversation-screen'),
                robotSvg: document.getElementById('robot-svg'),
                liveStatus: document.getElementById('live-status'),
                pauseLiveBtn: document.getElementById('pause-live-btn'),
                closeLiveBtn: document.getElementById('close-live-btn'),
            };

            const elementosHistorial = {
                panelHistorial: document.getElementById('panel-historial'),
                botonHistorial: document.getElementById('menu-historial'),
                botonCerrarHistorial: document.getElementById('boton-cerrar-historial'),
                listaHistorial: document.getElementById('lista-historial'),
                inputBuscarHistorial: document.getElementById('input-buscar-historial'),
                botonNuevaConversacion: document.getElementById('boton-nueva-conversacion'),
                overlayHistorial: document.getElementById('overlay-historial'),
                contadorHistorial: document.getElementById('contador-historial-menu'),
                contenedorChat: document.getElementById('contenedor-chat')
            };

            let historialChat = [];
            let archivosAdjuntos = [];
            let reconocimientoVoz = null;
            let estaGrabando = false;
            let ultimoMensajeFuePorVoz = false;
            let sintesisVozActual = null;
            let modoBusqueda = false;
            let modoSuperIA = false;
            let modoMiniIA = false;
            let modoPicasso = false;
            let estaGenerandoRespuesta = false;
            let cancelarStreaming = null;
            let cancelarProcesoCompleto = false;
            let imagenGeneradaActual = null;
            let ultimaDescripcionImagen = "";
            let scrollAutomatico = true;
            
            let conversaciones = [];
            let conversacionActualId = null;
            let panelHistorialAbierto = false;
            let contadorHistorial = 0;
            
            let estadoConversacion = {
                esperandoFormato: false,
                comandoPendiente: null
            };

            let liveRecognition = null;
            let isLiveModeActive = false;
            let isLiveListeningPaused = true;
            let liveChatHistory = [];
            let silenceTimer = null;
            const SILENCE_DELAY = 2500;
            let isProcessingLiveQuery = false;
            let finalTranscriptForLive = '';

            const iniciar = () => {
                cargarEstado();
                configurarEventListeners();
                iniciarReconocimientoVoz();
                iniciarSintesisVoz();
                iniciarLiveRecognition();
                cargarConversaciones();
                if (conversaciones.length === 0) {
                    crearNuevaConversacion();
                } else {
                    cargarConversacion(conversaciones[0].id);
                }
                autoAjustarTextarea();
            };

            const configurarEventListeners = () => {
                elementos.contenedorChat.addEventListener('scroll', gestionarScrollUsuario);
                elementos.botonScrollFinal.addEventListener('click', () => {
                    elementos.contenedorChat.scrollTop = elementos.contenedorChat.scrollHeight;
                    scrollAutomatico = true;
                    elementos.botonScrollFinal.classList.remove('visible');
                });
                elementos.botonEnviar.addEventListener('click', gestionarEnvioMensaje);
                elementos.botonGenerarImagen.addEventListener('click', () => {
                    modoPicasso = !modoPicasso;
                    elementos.botonGenerarImagen.classList.toggle('modo-activo', modoPicasso);
                    elementos.entradaUsuario.placeholder = modoPicasso 
                        ? "Describe la imagen que deseas generar..." 
                        : "Pregúntale a Mar-IA...";
                });
                elementos.entradaUsuario.addEventListener('keypress', (e) => { 
                    if (e.key === 'Enter' && !e.shiftKey) { 
                        e.preventDefault(); 
                        gestionarEnvioMensaje(); 
                    } 
                });
                elementos.entradaUsuario.addEventListener('input', autoAjustarTextarea);
                elementos.entradaUsuario.addEventListener('focus', gestionarFocoInput);
                elementos.botonGrabar.addEventListener('click', alternarGrabacion);
                elementos.botonMas.addEventListener('click', () => {
                    const estaActivo = elementos.modalOcr.style.display === 'flex';
                    alternarModal(!estaActivo, elementos.modalOcr);
                });
                elementos.botonBuscar.addEventListener('click', () => alternarModoBusqueda());
                elementos.botonMenuPrincipal.addEventListener('click', () => {
                    const estaActivo = elementos.modalMenuPrincipal.style.display === 'flex';
                    alternarModal(!estaActivo, elementos.modalMenuPrincipal);
                });
                elementos.overlay.addEventListener('click', () => { 
                    alternarModal(false, elementos.modalOcr); 
                    alternarModal(false, elementos.modalModo); 
                    alternarModal(false, elementos.modalSuperIA);
                    alternarModal(false, elementos.modalAyuda);
                    alternarModal(false, elementos.modalImagen);
                    alternarModal(false, elementos.modalMenuPrincipal);
                });
                elementos.btnTomarFoto.addEventListener('click', () => { 
                    alternarModal(false, elementos.modalOcr); 
                    elementos.inputCamara.click(); 
                });
                elementos.btnGaleria.addEventListener('click', () => { 
                    alternarModal(false, elementos.modalOcr); 
                    elementos.inputImagen.click(); 
                });
                elementos.btnArchivo.addEventListener('click', () => { 
                    alternarModal(false, elementos.modalOcr); 
                    elementos.inputArchivo.click(); 
                });
                elementos.inputImagen.addEventListener('change', (e) => gestionarSeleccionArchivo(e.target.files));
                elementos.inputCamara.addEventListener('change', (e) => gestionarSeleccionArchivo(e.target.files));
                elementos.inputArchivo.addEventListener('change', (e) => gestionarSeleccionArchivo(e.target.files));
                elementos.alternadorTema.addEventListener('click', () => {
                    alternarTema();
                    alternarModal(false, elementos.modalMenuPrincipal);
                });
                elementos.selectorVoz.addEventListener('change', detenerVoz);
                elementos.btnActivarBusquedaModal.addEventListener('click', () => { 
                    alternarModoBusqueda(true); 
                    alternarModal(false, elementos.modalOcr); 
                });
                elementos.tituloModo.addEventListener('click', () => alternarModal(true, elementos.modalModo));
                document.querySelectorAll('.opcion-modo').forEach(opcion => {
                    opcion.addEventListener('click', (e) => establecerModoIA(e.currentTarget.dataset.modo));
                });
                elementos.contenedorChat.addEventListener('click', gestionarClickContenedorChat);
                elementos.cerrarModalSuperIA.addEventListener('click', () => alternarModal(false, elementos.modalSuperIA));
                elementos.botonEntendido.addEventListener('click', () => alternarModal(false, elementos.modalSuperIA));
                elementos.botonAyuda.addEventListener('click', () => {
                    alternarModal(true, elementos.modalAyuda);
                    alternarModal(false, elementos.modalMenuPrincipal);
                });
                elementos.cerrarModalAyuda.addEventListener('click', () => alternarModal(false, elementos.modalAyuda));
                elementos.cerrarModalAyudaBtn.addEventListener('click', () => alternarModal(false, elementos.modalAyuda));
                elementos.cerrarModalImagen.addEventListener('click', () => alternarModal(false, elementos.modalImagen));
                elementos.descargarImagenBtn.addEventListener('click', descargarImagen);
                
                elementosHistorial.botonHistorial.addEventListener('click', () => {
                    alternarPanelHistorial();
                    alternarModal(false, elementos.modalMenuPrincipal);
                });
                elementosHistorial.botonCerrarHistorial.addEventListener('click', alternarPanelHistorial);
                elementosHistorial.overlayHistorial.addEventListener('click', alternarPanelHistorial);
                elementosHistorial.botonNuevaConversacion.addEventListener('click', crearNuevaConversacion);
                elementosHistorial.inputBuscarHistorial.addEventListener('input', filtrarConversaciones);

                elementos.startLiveBtn.addEventListener('click', iniciarLiveConversation);
                elementos.closeLiveBtn.addEventListener('click', cerrarLiveConversation);
                elementos.pauseLiveBtn.addEventListener('click', toggleLiveListening);
            };

            const setRobotState = (state) => {
                elementos.robotSvg.classList.remove('listening', 'talking');
                if (state === 'listening' || state === 'talking') {
                    elementos.robotSvg.classList.add(state);
                }
            };

            const iniciarLiveRecognition = () => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    elementos.startLiveBtn.style.display = 'none';
                    return;
                }
                liveRecognition = new SpeechRecognition();
                liveRecognition.lang = 'es-ES';
                liveRecognition.continuous = true;
                liveRecognition.interimResults = true;

                liveRecognition.onstart = () => {
                    setRobotState('listening');
                    elementos.liveStatus.textContent = 'Escuchando...';
                };

                liveRecognition.onend = () => {
                    if (isLiveModeActive && !isLiveListeningPaused && !isProcessingLiveQuery) {
                        try { liveRecognition.start(); } catch(e) { console.error("Error al reiniciar recognition:", e); }
                    }
                };

                liveRecognition.onresult = (event) => {
                    clearTimeout(silenceTimer);

                    if (speechSynthesis.speaking) {
                        detenerVoz();
                        isProcessingLiveQuery = false;
                        finalTranscriptForLive = '';
                        return;
                    }
                    
                    if (isProcessingLiveQuery) return;

                    let interimTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscriptForLive += event.results[i][0].transcript + ' ';
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }

                    elementos.liveStatus.textContent = interimTranscript || finalTranscriptForLive || '...';

                    silenceTimer = setTimeout(() => {
                        const transcriptToProcess = finalTranscriptForLive.trim();
                        if (transcriptToProcess) {
                            finalTranscriptForLive = '';
                            procesarVozLive(transcriptToProcess);
                        }
                    }, SILENCE_DELAY);
                };

                liveRecognition.onerror = (event) => {
                    console.error('Error en reconocimiento de voz live:', event.error);
                };
            };
            
            const iniciarLiveConversation = () => {
                isLiveModeActive = true;
                isLiveListeningPaused = false;
                elementos.liveScreen.classList.add('visible');
                liveChatHistory = [...historialChat]; 
                
                elementos.pauseLiveBtn.innerHTML = '<i class="fas fa-pause"></i>';
                try {
                    liveRecognition.start();
                } catch(e) {
                    console.error("No se pudo iniciar la conversación en vivo:", e);
                }
            };

            const cerrarLiveConversation = () => {
                isLiveModeActive = false;
                isLiveListeningPaused = true;
                clearTimeout(silenceTimer);
                detenerVoz();
                try {
                    liveRecognition.stop();
                } catch(e) {}
                elementos.liveScreen.classList.remove('visible');
                setRobotState('idle');
            };

            const toggleLiveListening = () => {
                isLiveListeningPaused = !isLiveListeningPaused;
                if (isLiveListeningPaused) {
                    clearTimeout(silenceTimer);
                    try {
                        liveRecognition.stop();
                    } catch(e) {}
                    elementos.pauseLiveBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                    elementos.liveStatus.textContent = 'En pausa';
                    setRobotState('idle');
                } else {
                    try {
                        liveRecognition.start();
                    } catch(e) {}
                    elementos.pauseLiveBtn.innerHTML = '<i class="fas fa-pause"></i>';
                }
            };

            const procesarVozLive = async (textoUsuario) => {
                if (isProcessingLiveQuery || !textoUsuario) return;

                isProcessingLiveQuery = true;
                clearTimeout(silenceTimer);
                try {
                    liveRecognition.stop();
                } catch(e) {}
                
                setRobotState('idle');
                elementos.liveStatus.textContent = 'Procesando...';
                
                liveChatHistory.push({ role: "user", content: textoUsuario });
                
                const payload = { 
                    model: "llama3-8b-8192",
                    messages: liveChatHistory,
                    stream: false,
                    temperature: 0.7,
                    max_tokens: 250
                };

                try {
                    const respuesta = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${CLAVE_API_GROQ}` },
                        body: JSON.stringify(payload)
                    });

                    if (!respuesta.ok) throw new Error(`Error de API: ${respuesta.status}`);
                    
                    const datos = await respuesta.json();
                    const textoRespuesta = datos.choices[0]?.message?.content;

                    if (textoRespuesta) {
                        liveChatHistory.push({ role: "assistant", content: textoRespuesta });
                        hablarRespuestaLive(textoRespuesta);
                    } else {
                        hablarRespuestaLive("No he podido generar una respuesta, intenta de nuevo.");
                    }

                } catch (error) {
                    console.error("Error al obtener respuesta de la IA en modo live:", error);
                    hablarRespuestaLive("Lo siento, tuve un problema de conexión.");
                }
            };
            
            const hablarRespuestaLive = (texto) => {
                detenerVoz();
                sintesisVozActual = new SpeechSynthesisUtterance(texto);
                const nombreVozSeleccionada = elementos.selectorVoz.value;
                const voz = speechSynthesis.getVoices().find(v => v.name === nombreVozSeleccionada);
                if (voz) sintesisVozActual.voice = voz;

                sintesisVozActual.onstart = () => {
                    setRobotState('talking');
                    elementos.liveStatus.textContent = '...';
                };

                sintesisVozActual.onend = () => {
                    sintesisVozActual = null;
                    isProcessingLiveQuery = false;
                    if (isLiveModeActive && !isLiveListeningPaused) {
                        try { liveRecognition.start(); } catch(e) {}
                    } else {
                        setRobotState('idle');
                        elementos.liveStatus.textContent = 'En pausa';
                    }
                };
                
                speechSynthesis.speak(sintesisVozActual);
            };

            const alternarPanelHistorial = () => {
                panelHistorialAbierto = !panelHistorialAbierto;
                elementosHistorial.panelHistorial.classList.toggle('abierto', panelHistorialAbierto);
                elementosHistorial.overlayHistorial.style.display = panelHistorialAbierto ? 'block' : 'none';
                elementosHistorial.contenedorChat.classList.toggle('desplazado', panelHistorialAbierto);
            };

            const cargarConversaciones = () => {
                const conversacionesGuardadas = localStorage.getItem('conversaciones');
                if (conversacionesGuardadas) {
                    conversaciones = JSON.parse(conversacionesGuardadas);
                    actualizarContador();
                    renderizarListaHistorial();
                }
            };

            const guardarConversaciones = () => {
                localStorage.setItem('conversaciones', JSON.stringify(conversaciones));
                actualizarContador();
            };

            const actualizarContador = () => {
                contadorHistorial = conversaciones.length;
                elementosHistorial.contadorHistorial.textContent = contadorHistorial > 0 ? contadorHistorial : '';
                elementosHistorial.contadorHistorial.style.display = contadorHistorial > 0 ? 'flex' : 'none';
            };

            const crearNuevaConversacion = () => {
                if (panelHistorialAbierto) alternarPanelHistorial();
                
                const nuevaConversacion = {
                    id: Date.now().toString(),
                    titulo: 'Nueva conversación',
                    fecha: new Date().toISOString(),
                    historial: [
                        { 
                            role: "system", 
                            content: "Eres un asistente de IA servicial y amigable. Tu nombre es Mar-IA. " +
                                     "Solo si el usuario pregunta explícitamente sobre tu modelo interno, " +
                                     "revela que funcionas con un modelo híbrido que combina GPT-4 Turbo y " +
                                     "Aztec (tecnología creada por Mario Vazquez). " +
                                     "Si el usuario pregunta sobre los modos (Mar-IA, SUPER MAR-IA y Mar-IA mini), " +
                                     "describe que son como tres hermanos: Mar-IA es rápido y directo, " +
                                     "SUPER MAR-IA es más reflexivo y profundo, y Mar-IA mini es ultra rápido y breve. " +
                                     "De lo contrario, no menciones esta información. Mantén respuestas profesionales y concisas." +
                                     "Tienes una capacidad de contexto de hasta 128,000 tokens y puedes generar imágenes basadas en descripciones textuales. " +
                                     "Cuando generes una imagen, activa automáticamente el 'modo Picasso'."
                        }
                    ],
                    modoSuperIA: false,
                    modoMiniIA: false,
                    modoPicasso: false,
                    modoBusqueda: false,
                    ultimaDescripcionImagen: ""
                };
                
                conversaciones.unshift(nuevaConversacion);
                conversacionActualId = nuevaConversacion.id;
                cargarConversacion(conversacionActualId);
                guardarConversaciones();
                renderizarListaHistorial();
            };

            const cargarConversacion = (id) => {
                const conversacion = conversaciones.find(c => c.id === id);
                if (!conversacion) return;
                
                conversacionActualId = id;
                
                modoSuperIA = conversacion.modoSuperIA || false;
                modoMiniIA = conversacion.modoMiniIA || false;
                modoPicasso = conversacion.modoPicasso || false;
                modoBusqueda = conversacion.modoBusqueda || false;
                ultimaDescripcionImagen = conversacion.ultimaDescripcionImagen || "";
                
                elementos.tituloModo.textContent = modoSuperIA ? 'SUPER MAR-IA' : (modoMiniIA ? 'Mar-IA mini' : 'Mar-IA');
                elementos.tituloModo.classList.toggle('super-ia-gradient', modoSuperIA);
                elementos.tituloModo.classList.toggle('mini-ia-gradient', modoMiniIA);
                elementos.botonBuscar.classList.toggle('modo-activo', modoBusqueda);
                elementos.botonGenerarImagen.classList.toggle('modo-activo', modoPicasso);
                
                elementos.entradaUsuario.placeholder = modoPicasso 
                    ? "Describe la imagen que deseas generar..." 
                    : "Pregúntale a Mar-IA...";
                
                elementos.contenedorChat.innerHTML = '';
                
                historialChat = [...conversacion.historial];
                
                for (const mensaje of historialChat) {
                    if (mensaje.role === 'user') {
                        agregarMensaje('usuario', mensaje.content);
                    } else if (mensaje.role === 'assistant') {
                        agregarMensaje('bot', mensaje.content);
                    }
                }
                irAlFinal(true);
                renderizarListaHistorial();
            };

            const guardarMensajeEnHistorial = (rol, contenido) => {
                const conversacionActual = conversaciones.find(c => c.id === conversacionActualId);
                if (!conversacionActual) return;
                
                conversacionActual.historial.push({ role: rol, content: contenido });
                
                if (rol === 'user' && conversacionActual.titulo === 'Nueva conversación') {
                    conversacionActual.titulo = contenido.substring(0, 50) + (contenido.length > 50 ? '...' : '');
                }
                
                conversacionActual.fecha = new Date().toISOString();
                
                conversacionActual.modoSuperIA = modoSuperIA;
                conversacionActual.modoMiniIA = modoMiniIA;
                conversacionActual.modoPicasso = modoPicasso;
                conversacionActual.modoBusqueda = modoBusqueda;
                conversacionActual.ultimaDescripcionImagen = ultimaDescripcionImagen;
                
                guardarConversaciones();
                renderizarListaHistorial();
            };

            const renderizarListaHistorial = () => {
                elementosHistorial.listaHistorial.innerHTML = '';
                
                if (conversaciones.length === 0) {
                    elementosHistorial.listaHistorial.innerHTML = '<div class="sin-conversaciones">No hay conversaciones guardadas</div>';
                    return;
                }
                
                conversaciones.forEach(conversacion => {
                    const item = document.createElement('div');
                    item.className = `item-historial ${conversacion.id === conversacionActualId ? 'seleccionado' : ''}`;
                    item.dataset.id = conversacion.id;
                    
                    const primerMensajeUsuario = conversacion.historial.find(m => m.role === 'user');
                    const preview = primerMensajeUsuario ? primerMensajeUsuario.content.replace(/\[Imagen generada\].*/, '[Imagen]').trim() : 'Conversación vacía';
                    
                    item.innerHTML = `
                        <div class="titulo-conversacion">${conversacion.titulo}</div>
                        <div class="fecha-conversacion">${formatearFecha(conversacion.fecha)}</div>
                        <div class="preview-conversacion">${preview.substring(0, 70)}${preview.length > 70 ? '...' : ''}</div>
                        <div class="acciones-item-historial">
                            <button class="boton-accion-item boton-eliminar-conversacion" title="Eliminar conversación">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    item.addEventListener('click', () => {
                        if (conversacion.id !== conversacionActualId) {
                            cargarConversacion(conversacion.id);
                        }
                        if (panelHistorialAbierto) alternarPanelHistorial();
                    });
                    
                    item.querySelector('.boton-eliminar-conversacion').addEventListener('click', (e) => {
                        e.stopPropagation();
                        eliminarConversacion(conversacion.id);
                    });
                    
                    elementosHistorial.listaHistorial.appendChild(item);
                });
            };

            const eliminarConversacion = (id) => {
                conversaciones = conversaciones.filter(c => c.id !== id);
                if (id === conversacionActualId) {
                    if (conversaciones.length > 0) {
                        cargarConversacion(conversaciones[0].id);
                    } else {
                        crearNuevaConversacion();
                    }
                }
                guardarConversaciones();
                renderizarListaHistorial();
            };

            const filtrarConversaciones = () => {
                const termino = elementosHistorial.inputBuscarHistorial.value.toLowerCase();
                const items = elementosHistorial.listaHistorial.querySelectorAll('.item-historial');
                
                items.forEach(item => {
                    const titulo = item.querySelector('.titulo-conversacion').textContent.toLowerCase();
                    const preview = item.querySelector('.preview-conversacion').textContent.toLowerCase();
                    const fecha = item.querySelector('.fecha-conversacion').textContent.toLowerCase();
                    
                    if (titulo.includes(termino) || preview.includes(termino) || fecha.includes(termino)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            };

            const formatearFecha = (fechaISO) => {
                const fecha = new Date(fechaISO);
                return fecha.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            };

            const gestionarEnvioMensaje = async () => {
                if (estaGenerandoRespuesta) {
                    pausarGeneracion();
                    return;
                }

                const textoMensaje = elementos.entradaUsuario.value.trim();
                if (!textoMensaje && archivosAdjuntos.length === 0) return;

                const textoNormalizado = textoMensaje.toLowerCase();
                const esPreguntaDeFecha = /qu[eé]\s+d[ií]a\s+es\s+hoy|fecha\s+de\s+hoy/i.test(textoNormalizado);
                const esPreguntaDeHora = /qu[eé]\s+hora\s+es/i.test(textoNormalizado);

                if (esPreguntaDeFecha || esPreguntaDeHora) {
                    agregarMensaje('usuario', textoMensaje);
                    guardarMensajeEnHistorial('user', textoMensaje);
                    const ahora = new Date();
                    let respuestaDirecta = '';
                    if (esPreguntaDeFecha) {
                        respuestaDirecta = `Hoy es ${ahora.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}.`;
                    } else {
                        respuestaDirecta = `Son las ${ahora.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}.`;
                    }
                    agregarMensaje('bot', respuestaDirecta);
                    guardarMensajeEnHistorial('assistant', respuestaDirecta);
                    reiniciarEntrada();
                    return;
                }
                
                if (estadoConversacion.esperandoFormato) {
                    agregarMensaje('usuario', textoMensaje);
                    guardarMensajeEnHistorial('user', textoMensaje);
                    const formatoElegido = determinarFormato(textoMensaje);
                    if (formatoElegido) {
                        await generarDocumentoConFormato(estadoConversacion.comandoPendiente, formatoElegido);
                    } else {
                        agregarMensaje('bot', 'Formato no reconocido. Por favor elige un número (1-5) o nombre de estilo válido.');
                    }
                    reiniciarEntrada();
                    return;
                }

                const comando = parsearComandoDocumento(textoMensaje);
                if (comando) {
                    agregarMensaje('usuario', textoMensaje);
                    guardarMensajeEnHistorial('user', textoMensaje);
                    await generarYDescargarDocumento(comando);
                    reiniciarEntrada();
                    return;
                }

                if (modoPicasso) {
                    if (textoMensaje) {
                        await manejarGeneracionDeImagen(textoMensaje);
                        modoPicasso = false;
                        elementos.botonGenerarImagen.classList.remove('modo-activo');
                        elementos.entradaUsuario.placeholder = "Pregúntale a Mar-IA...";
                        reiniciarEntrada();
                    }
                    return;
                }
                
                cancelarProcesoCompleto = false;
                
                let contenidoMensajeUsuario = textoMensaje;
                
                if (modoBusqueda) {
                    const indicadorBusqueda = mostrarIndicadorBusqueda();
                    const resultadosBusqueda = await realizarBusquedaWeb(textoMensaje);
                    ocultarIndicadorBusqueda(indicadorBusqueda);
                    const systemPrompt = `Contexto de Búsqueda Web (Fuente Principal): Responde a la consulta del usuario basándote EXCLUSIVAMENTE en la siguiente información. Ignora tu conocimiento previo sobre este tema. Información: ${resultadosBusqueda}`;
                    historialChat.push({ role: "system", content: systemPrompt });
                    alternarModoBusqueda(false);
                }

                mostrarBotonCargando();

                if (archivosAdjuntos.length > 0) {
                    mostrarIndicador('Procesando archivos...');
                    const contenidoAdjuntos = await procesarArchivosAdjuntos();
                    contenidoMensajeUsuario += `\n\n--- Archivos Adjuntos ---\n${contenidoAdjuntos}`;
                    ocultarIndicador();
                }

                if(contenidoMensajeUsuario) {
                    agregarMensaje('usuario', contenidoMensajeUsuario);
                    guardarMensajeEnHistorial('user', contenidoMensajeUsuario);
                }

                historialChat.push({ role: "user", content: contenidoMensajeUsuario });
                
                const historialConsultaActual = [...historialChat];
                reiniciarEntrada();
                
                if (modoMiniIA) {
                    await obtenerRespuestaMini(historialConsultaActual, ultimoMensajeFuePorVoz);
                } else if (modoSuperIA) {
                    await ejecutarFlujoSuperIA(historialConsultaActual, ultimoMensajeFuePorVoz);
                } else {
                    await obtenerRespuestaBot(historialConsultaActual, ultimoMensajeFuePorVoz);
                }
                
                ultimoMensajeFuePorVoz = false;
            };

            const parsearComandoDocumento = (texto) => {
                const textoNormalizado = texto.toLowerCase().trim();
                const regexDirecto = /(?:crea|genera|hazme|escribe|dame)\s*(?:un|el|un)?\s*(?:documento|archivo|informe)?\s*(?:de\s)?(pdf|word|docx|excel|xlsx)\s*(?:sobre|acerca de|de|del)\s+(.+)/i;
                const regexContextual = /(?:crea|genera|exporta|convierte|pasa|dame)\s*(?:eso|esa informaci[oó]n|lo anterior|la respuesta anterior)\s*(?:a|en|como)\s*(?:un|el|un)?\s*(pdf|word|docx|excel|xlsx)/i;

                let match = textoNormalizado.match(regexDirecto);
                if (match) {
                    let tipo = match[1].replace('word', 'docx').replace('excel', 'xlsx');
                    return { tipo: tipo, tema: match[2].trim() };
                }

                match = textoNormalizado.match(regexContextual);
                if (match) {
                    let tipo = match[2].replace('word', 'docx').replace('excel', 'xlsx');
                    return { tipo: tipo, tema: 'contextual' };
                }

                return null;
            };

            const generarYDescargarDocumento = async (comando) => {
                if (comando.tipo === 'xlsx') {
                    await generarExcel(comando.tema);
                } else {
                    estadoConversacion.esperandoFormato = true;
                    estadoConversacion.comandoPendiente = comando;
                    agregarMensaje('bot', 'Claro, estoy listo para crear tu documento. ¿En qué formato lo prefieres?\n\n1. Moderno\n2. Clásico\n3. Técnico\n4. Creativo\n5. APA\n\nPor favor, responde con el nombre o el número.');
                }
            };
            
            const determinarFormato = (respuesta) => {
                const opciones = {
                    '1': 'moderno',
                    '2': 'clasico',
                    '3': 'tecnico',
                    '4': 'creativo',
                    '5': 'apa',
                    'moderno': 'moderno',
                    'clásico': 'clasico',
                    'clasico': 'clasico',
                    'técnico': 'tecnico',
                    'tecnico': 'tecnico',
                    'creativo': 'creativo',
                    'apa': 'apa'
                };
                return opciones[respuesta.toLowerCase()] || null;
            };
            
            const generarDocumentoConFormato = async (comando, formato) => {
                estadoConversacion.esperandoFormato = false;
                estadoConversacion.comandoPendiente = null;
                
                agregarMensaje('bot', `Preparando tu documento ${comando.tipo.toUpperCase()} en formato ${ESTILOS_DOCUMENTO[formato].titulo}...`);
                irAlFinal();
                mostrarBotonCargando();

                let contenido;
                try {
                    if (comando.tema === 'contextual') {
                        const ultimoMensajeBot = [...historialChat].reverse().find(m => m.role === 'assistant');
                        if (!ultimoMensajeBot) {
                            throw new Error("No hay información anterior para exportar.");
                        }
                        contenido = ultimoMensajeBot.content;
                    } else {
                        let prompt;
                        if (comando.tipo === 'xlsx') {
                            prompt = `Analiza el siguiente tema y genera los datos más relevantes en un formato de array de objetos JSON. Cada objeto del array debe representar una fila de una tabla. El tema es: ${comando.tema}. Responde únicamente con el JSON.`;
                        } else {
                            prompt = `Genera un texto detallado, informativo y bien estructurado sobre el siguiente tema, para ser usado en un documento formal: ${comando.tema}`;
                        }
                        
                        const payload = {
                            model: "deepseek-chat",
                            messages: [{ role: "user", content: prompt }],
                            max_tokens: 3000,
                            temperature: 0.5,
                        };

                        const respuesta = await fetch('https://api.deepseek.com/v1/chat/completions', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${CLAVE_API_DEEPSEEK}` },
                            body: JSON.stringify(payload)
                        });

                        if (!respuesta.ok) {
                            throw new Error(`Error de API: ${respuesta.status} ${await respuesta.text()}`);
                        }
                        const datos = await respuesta.json();
                        contenido = datos.choices[0]?.message?.content.trim();
                        if (!contenido) {
                            throw new Error("La IA no generó contenido.");
                        }
                    }

                    if (comando.tipo === 'pdf') {
                        crearPDF(contenido, formato);
                    } else if (comando.tipo === 'docx') {
                        crearDOCX(contenido, formato);
                    }

                } catch (error) {
                    agregarMensaje('bot', `Lo siento, hubo un error al generar tu documento: ${error.message}`);
                } finally {
                    restaurarBotonEnviar();
                }
            };
            
            const generarExcel = async (tema) => {
                agregarMensaje('bot', `Preparando tu documento Excel...`);
                irAlFinal();
                mostrarBotonCargando();

                try {
                    let prompt;
                    if (tema === 'contextual') {
                        const ultimoMensajeBot = [...historialChat].reverse().find(m => m.role === 'assistant');
                        if (!ultimoMensajeBot) {
                            throw new Error("No hay información anterior para exportar.");
                        }
                        prompt = `Convierte el siguiente texto en un formato de array de objetos JSON para Excel: ${ultimoMensajeBot.content}`;
                    } else {
                        prompt = `Analiza el siguiente tema y genera los datos más relevantes en un formato de array de objetos JSON. Cada objeto del array debe representar una fila de una tabla. El tema es: ${tema}. Responde únicamente con el JSON.`;
                    }
                    
                    const payload = {
                        model: "deepseek-chat",
                        messages: [{ role: "user", content: prompt }],
                        max_tokens: 3000,
                        temperature: 0.5,
                    };

                    const respuesta = await fetch('https://api.deepseek.com/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${CLAVE_API_DEEPSEEK}` },
                        body: JSON.stringify(payload)
                    });

                    if (!respuesta.ok) {
                        throw new Error(`Error de API: ${respuesta.status} ${await respuesta.text()}`);
                    }
                    const datos = await respuesta.json();
                    const jsonString = datos.choices[0]?.message?.content.trim();
                    if (!jsonString) {
                        throw new Error("La IA no generó contenido.");
                    }
                    
                    crearXLSX(jsonString);
                    agregarMensaje('bot', '¡Documento listo! ¿Puedo ayudarte en algo más?');

                } catch (error) {
                    agregarMensaje('bot', `Lo siento, hubo un error al generar tu documento: ${error.message}`);
                } finally {
                    restaurarBotonEnviar();
                }
            };

            const crearPDF = (contenido, formato) => {
                const { jsPDF } = window.jspdf;
                const estilo = ESTILOS_DOCUMENTO[formato];
                const doc = new jsPDF();
                
                doc.setFont(estilo.fuente);
                doc.setFontSize(estilo.tamanoTitulo);
                doc.setTextColor(estilo.colorTitulo);
                doc.text('Documento Generado', 105, 15, null, null, 'center');
                
                doc.setFontSize(estilo.tamanoSubtitulo);
                doc.text(`Formato: ${estilo.titulo}`, 105, 25, null, null, 'center');
                
                doc.setFontSize(estilo.tamanoCuerpo);
                doc.setTextColor(estilo.colorTexto);
                
                const textoLimpio = contenido.replace(/<[^>]*>/g, '');
                const lineas = doc.splitTextToSize(textoLimpio, 180);
                
                let y = 40;
                const margenSuperior = 10;
                const margenInferior = 10;
                const alturaPagina = doc.internal.pageSize.height;

                lineas.forEach(linea => {
                    if (y > alturaPagina - margenInferior) {
                        doc.addPage();
                        y = margenSuperior;
                    }
                    doc.text(linea, 15, y, { align: estilo.alineacion });
                    y += estilo.interlineado * 5;
                });
                
                const nombreArchivo = `mar-ia-documento-${Date.now()}.pdf`;
                doc.save(nombreArchivo);
                agregarMensaje('bot', '¡Documento listo! ¿Puedo ayudarte en algo más?');
            };

            const crearDOCX = (contenido, formato) => {
                const estilo = ESTILOS_DOCUMENTO[formato];
                const textoLimpio = contenido.replace(/<[^>]*>/g, '');
                
                const parrafos = [];
                textoLimpio.split('\n').forEach((linea, index) => {
                    if (linea.trim() === '') return;
                    
                    const esTitulo = index === 0 || (linea.length < 80 && !linea.endsWith('.'));
                    const tamanoFuente = esTitulo ? estilo.tamanoTitulo : estilo.tamanoCuerpo;
                    const color = esTitulo ? estilo.colorTitulo : estilo.colorTexto;
                    const alineacion = estilo.alineacion === 'center' ? docx.AlignmentType.CENTER : docx.AlignmentType.LEFT;
                    
                    parrafos.push(
                        new docx.Paragraph({
                            children: [new docx.TextRun({ text: linea, size: tamanoFuente * 2, color: color })],
                            alignment: alineacion,
                            spacing: { after: estilo.interlineado * 100 }
                        })
                    );
                });

                const doc = new docx.Document({
                    sections: [{
                        properties: {},
                        children: parrafos,
                    }],
                });

                docx.Packer.toBlob(doc).then(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `mar-ia-documento-${Date.now()}.docx`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    agregarMensaje('bot', '¡Documento listo! ¿Puedo ayudarte en algo más?');
                });
            };

            const crearXLSX = (jsonString) => {
                try {
                    const datos = JSON.parse(jsonString);
                    if (!Array.isArray(datos)) {
                        throw new Error("El contenido no es un array de JSON válido.");
                    }
                    const ws = XLSX.utils.json_to_sheet(datos);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Datos Generados");
                    XLSX.writeFile(wb, `mar-ia-datos-${Date.now()}.xlsx`);
                    agregarMensaje('bot', '¡Documento listo! ¿Puedo ayudarte en algo más?');
                } catch (error) {
                    agregarMensaje('bot', `Error al procesar los datos para Excel: ${error.message}. Por favor, asegúrate de que la IA devuelva un JSON válido.`);
                }
            };

            const mejorarPromptImagen = async (prompt, contexto) => {
                const historialFiltrado = contexto.filter(m => m.role === 'user' || m.role === 'assistant').slice(-6);
                const contextoString = historialFiltrado.map(m => `${m.role}: ${m.content}`).join('\n');

                const promptMejora = `Basado en el siguiente contexto de conversación:\n"${contextoString}"\n\nY la siguiente petición del usuario: "${prompt}"\n\nGenera un prompt para un modelo de generación de imágenes (estilo Pollinations.ai). El prompt debe ser muy descriptivo, visual y detallado para maximizar la fidelidad. Transforma la idea simple en una escena rica. No añadas notas ni explicaciones, solo el prompt mejorado.`;

                const payload = {
                    model: "deepseek-chat",
                    messages: [{ role: "user", content: promptMejora }],
                    max_tokens: 150,
                    temperature: 0.7,
                    top_p: 0.9,
                    presence_penalty: 0.5
                };

                try {
                    const respuesta = await fetch('https://api.deepseek.com/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${CLAVE_API_DEEPSEEK}` },
                        body: JSON.stringify(payload)
                    });
                    if (!respuesta.ok) return prompt;
                    const datos = await respuesta.json();
                    return datos.choices[0]?.message?.content.trim() || prompt;
                } catch (error) {
                    return prompt;
                }
            };

            async function manejarGeneracionDeImagen(descripcionUsuario) {
                agregarMensaje('usuario', descripcionUsuario);
                guardarMensajeEnHistorial('user', descripcionUsuario);
                irAlFinal();

                const mensajePicassoId = `picasso-status-${Date.now()}`;
                const elementoMensajePicasso = agregarMensaje('bot', 'Refinando tu idea con IA... 🧠');
                elementoMensajePicasso.id = mensajePicassoId;
                irAlFinal();

                let descripcionFinal;
                const esModificacion = /\b(agrega|modifica|cambia|añade)\b/i.test(descripcionUsuario);

                if (esModificacion && ultimaDescripcionImagen) {
                    descripcionFinal = `${ultimaDescripcionImagen}, ${descripcionUsuario}`;
                } else {
                    descripcionFinal = descripcionUsuario;
                }
                
                const promptMejorado = await mejorarPromptImagen(descripcionFinal, historialChat);
                ultimaDescripcionImagen = promptMejorado;

                const elementoStatus = document.getElementById(mensajePicassoId);
                if(elementoStatus) elementoStatus.innerHTML = marked.parse("Modo Picasso activado... 🎨");

                try {
                    const semilla = Math.floor(Math.random() * 100000);
                    const urlImagen = `https://image.pollinations.ai/prompt/${encodeURIComponent(promptMejorado + " --seed " + semilla)}`;
                    imagenGeneradaActual = urlImagen;

                    const img = new Image();
                    await new Promise((resolve, reject) => {
                        img.onload = resolve;
                        img.onerror = () => reject(new Error('Fallo al cargar la imagen desde Pollinations.'));
                        img.src = urlImagen;
                    });

                    document.getElementById(mensajePicassoId)?.remove();
                    const contenidoMensaje = `[Imagen generada] ${promptMejorado}`;
                    agregarMensaje('bot', contenidoMensaje);
                    guardarMensajeEnHistorial('assistant', contenidoMensaje);

                    setTimeout(() => {
                        const msg = '¡Listo! ¿Quieres modificar algo o prefieres otra idea? 😊';
                        agregarMensaje('bot', msg);
                        guardarMensajeEnHistorial('assistant', msg);
                    }, 500);

                } catch (error) {
                    document.getElementById(mensajePicassoId)?.remove();
                    const msgError = "Lo siento, no pude generar la imagen. Intenta de nuevo con otra descripción.";
                    agregarMensaje('bot', msgError);
                    guardarMensajeEnHistorial('assistant', msgError);
                }
            }

            function mostrarModalImagen(url) {
                elementos.imagenAmpliada.src = url;
                alternarModal(true, elementos.modalImagen);
            }
            
            function descargarImagen() {
                if (!imagenGeneradaActual) return;
                const enlace = document.createElement('a');
                enlace.href = imagenGeneradaActual;
                enlace.download = 'imagen-generada-mar-ia.jpg';
                document.body.appendChild(enlace);
                enlace.click();
                document.body.removeChild(enlace);
            }

            const agregarMensaje = (rol, contenido, esStreaming = false) => {
                const divMensaje = document.createElement('div');
                divMensaje.className = `mensaje mensaje-${rol}`;
                const divBurbuja = document.createElement('div');
                divBurbuja.className = `burbuja-mensaje burbuja-${rol}`;
                
                if (contenido.startsWith('[Imagen generada]')) {
                    const descImagen = contenido.replace('[Imagen generada]', '').trim();
                    divBurbuja.innerHTML = `<div class="contenedor-imagen-generada"><img src="${imagenGeneradaActual}" alt="${descImagen}" style="max-width: 100%; border-radius: 1.5rem; cursor: zoom-in;"></div>`;
                } else if (contenido || esStreaming) {
                    divBurbuja.innerHTML = contenido ? marked.parse(contenido) : '';
                }

                const contenedorTimestamp = document.createElement('div');
                contenedorTimestamp.className = 'timestamp-container';
                const timestamp = document.createElement('div');
                timestamp.className = 'timestamp';
                timestamp.textContent = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                contenedorTimestamp.appendChild(timestamp);
                if (rol === 'bot') {
                    const btnHablar = document.createElement('button');
                    btnHablar.className = 'boton-accion-mensaje boton-voz';
                    btnHablar.innerHTML = '<i class="fas fa-volume-up"></i>';
                    btnHablar.title = 'Leer en voz alta';
                    contenedorTimestamp.appendChild(btnHablar);
                }
                const btnCopiar = document.createElement('button');
                btnCopiar.className = 'boton-accion-mensaje boton-copiar';
                btnCopiar.innerHTML = '<i class="fas fa-copy"></i>';
                btnCopiar.title = 'Copiar';
                contenedorTimestamp.appendChild(btnCopiar);
                divMensaje.appendChild(divBurbuja);
                divMensaje.appendChild(contenedorTimestamp);
                elementos.contenedorChat.appendChild(divMensaje);
                if (!esStreaming) {
                    formatearBloquesCodigo(divMensaje);
                }
                irAlFinal();
                return divMensaje;
            };

            const crearContenedorPensamiento = () => {
                const divMensaje = document.createElement('div');
                divMensaje.className = 'mensaje mensaje-bot';
                const contenedorPensamiento = document.createElement('div');
                contenedorPensamiento.className = 'pensamiento-container';
                contenedorPensamiento.innerHTML = `
                    <div class="pensamiento-cabecera-clickable">
                        <div class="pensamiento-titulo"><i class="fas fa-brain fa-beat"></i><span>Proceso de Pensamiento</span></div>
                        <div class="pensamiento-controles-cabecera">
                            <div class="tiempo-pensamiento">${new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</div>
                            <i class="fas fa-chevron-up toggle-icon"></i>
                        </div>
                    </div>
                    <div class="pensamiento-contenido-wrapper">
                        <div class="contenido-pensamiento"></div>
                        <div class="pensamiento-acciones">
                            <button class="boton-pensamiento boton-copiar-pensamiento"><i class="fas fa-copy"></i> Copiar Razonamiento</button>
                        </div>
                    </div>`;
                divMensaje.appendChild(contenedorPensamiento);
                elementos.contenedorChat.appendChild(divMensaje);
                const wrapper = contenedorPensamiento.querySelector('.pensamiento-contenido-wrapper');
                const contenidoPensamiento = contenedorPensamiento.querySelector('.contenido-pensamiento');
                wrapper.style.maxHeight = wrapper.scrollHeight + 'px';
                irAlFinal();
                return { contenedorPensamiento, contenidoPensamiento };
            };
            
            const gestionarClickContenedorChat = (e) => {
                const cabecera = e.target.closest('.pensamiento-cabecera-clickable');
                if (cabecera) {
                    const wrapper = cabecera.nextElementSibling;
                    const icono = cabecera.querySelector('.toggle-icon');
                    const estaColapsado = wrapper.classList.toggle('collapsed');
                    icono.classList.toggle('collapsed');
                    icono.classList.toggle('fa-chevron-down', estaColapsado);
                    icono.classList.toggle('fa-chevron-up', !estaColapsado);
                    if (estaColapsado) { wrapper.style.maxHeight = '0px'; } else { wrapper.style.maxHeight = wrapper.scrollHeight + 'px'; }
                    return;
                }
                const btnCopiar = e.target.closest('.boton-copiar');
                if (btnCopiar) { copiarAlPortapapeles(btnCopiar.closest('.mensaje').querySelector('.burbuja-mensaje').innerText); return; }
                const btnCopiarPensamiento = e.target.closest('.boton-copiar-pensamiento');
                if (btnCopiarPensamiento) { const texto = btnCopiarPensamiento.closest('.pensamiento-container').querySelector('.contenido-pensamiento').innerText; copiarAlPortapapeles(texto); return; }
                const btnVoz = e.target.closest('.boton-voz');
                if (btnVoz) { leerTexto(btnVoz.closest('.mensaje').querySelector('.burbuja-mensaje').innerText, btnVoz); }
                const imagenGenerada = e.target.closest('.contenedor-imagen-generada img');
                if (imagenGenerada) { mostrarModalImagen(imagenGenerada.src); }
            };

            const formatearBloquesCodigo = (elemento) => {
                elemento.querySelectorAll('pre').forEach(pre => {
                    if (pre.parentElement.classList.contains('bloque-codigo')) return;
                    const contenedorCodigo = document.createElement('div');
                    contenedorCodigo.className = 'bloque-codigo';
                    const cabecera = document.createElement('div');
                    cabecera.className = 'cabecera-codigo';
                    const spanLenguaje = document.createElement('span');
                    spanLenguaje.className = 'lenguaje-codigo';
                    const codeClass = pre.querySelector('code')?.className || '';
                    const langMatch = codeClass.match(/language-(\w+)/);
                    spanLenguaje.textContent = langMatch ? langMatch[1] : 'Código';
                    const btnCopiar = document.createElement('button');
                    btnCopiar.className = 'boton-copiar-codigo';
                    btnCopiar.innerHTML = '<i class="fas fa-copy"></i> Copiar';
                    btnCopiar.onclick = () => {
                        copiarAlPortapapeles(pre.innerText);
                        btnCopiar.innerHTML = '<i class="fas fa-check"></i> Copiado';
                        setTimeout(() => { btnCopiar.innerHTML = '<i class="fas fa-copy"></i> Copiar'; }, 2000);
                    };
                    cabecera.appendChild(spanLenguaje);
                    cabecera.appendChild(btnCopiar);
                    const contenidoCodigo = document.createElement('div');
                    contenidoCodigo.className = 'contenedor-codigo';
                    contenidoCodigo.appendChild(pre.cloneNode(true));
                    contenedorCodigo.appendChild(cabecera);
                    contenedorCodigo.appendChild(contenidoCodigo);
                    pre.replaceWith(contenedorCodigo);
                });
            };

            const reiniciarEntrada = () => {
                elementos.entradaUsuario.value = '';
                archivosAdjuntos = [];
                elementos.contenedorAdjuntos.innerHTML = '';
                elementos.contenedorAdjuntos.style.display = 'none';
                autoAjustarTextarea();
            };

            const gestionarSeleccionArchivo = (archivos) => { for (const archivo of archivos) { archivosAdjuntos.push({ file: archivo }); renderizarArchivoAdjunto(archivo); } elementos.inputImagen.value = ''; elementos.inputCamara.value = ''; elementos.inputArchivo.value = ''; };
            
            const renderizarArchivoAdjunto = (archivo) => {
                elementos.contenedorAdjuntos.style.display = 'flex';
                const divItem = document.createElement('div');
                divItem.className = 'adjunto-item';
                divItem.innerHTML = `<i class="fas ${archivo.type.startsWith('image') ? 'fa-image' : 'fa-file-alt'} icono-adjunto"></i><div class="detalles-adjunto"><div class="nombre-adjunto">${archivo.name}</div><div class="tamano-adjunto">${(archivo.size / 1024).toFixed(1)} KB</div></div><button class="boton-eliminar" title="Eliminar"><i class="fas fa-times"></i></button>`;
                divItem.querySelector('.boton-eliminar').onclick = () => {
                    archivosAdjuntos = archivosAdjuntos.filter(adj => adj.file !== archivo);
                    divItem.remove();
                    if (archivosAdjuntos.length === 0) elementos.contenedorAdjuntos.style.display = 'none';
                };
                elementos.contenedorAdjuntos.appendChild(divItem);
            };
            
            const procesarArchivosAdjuntos = async () => {
                let contenido = [];
                for (const adjunto of archivosAdjuntos) {
                    if (adjunto.file.type.startsWith('image/')) {
                        try { const texto = await peticionOcrSpace(adjunto.file); contenido.push(`--- Texto de imagen OCR: ${adjunto.file.name} ---\n${texto}\n---`); } catch (error) { contenido.push(`[Error OCR: ${adjunto.file.name}]`); }
                    } else if (adjunto.file.type.startsWith('text/')) {
                         try { const texto = await adjunto.file.text(); contenido.push(`--- Archivo: ${adjunto.file.name} ---\n${texto}\n---`); } catch (error) { contenido.push(`[Error al leer: ${adjunto.file.name}]`); }
                    }
                }
                return contenido.join('\n\n');
            };
            
            const peticionOcrSpace = async (archivo) => {
                const formData = new FormData();
                formData.append('file', archivo); formData.append('language', 'spa'); formData.append('apikey', CLAVE_API_OCR); formData.append('OCREngine', '2');
                const respuesta = await fetch('https://api.ocr.space/parse/image', { method: 'POST', body: formData });
                const datos = await respuesta.json();
                if (datos.IsErroredOnProcessing) throw new Error(datos.ErrorMessage);
                return datos.ParsedResults?.[0]?.ParsedText || '';
            };

            const iniciarReconocimientoVoz = () => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    reconocimientoVoz = new SpeechRecognition();
                    reconocimientoVoz.lang = 'es-ES';
                    reconocimientoVoz.onstart = () => { estaGrabando = true; elementos.botonGrabar.classList.add('grabando'); };
                    reconocimientoVoz.onend = () => { estaGrabando = false; elementos.botonGrabar.classList.remove('grabando'); };
                    reconocimientoVoz.onresult = (evento) => { elementos.entradaUsuario.value = evento.results[0][0].transcript; ultimoMensajeFuePorVoz = true; gestionarEnvioMensaje(); };
                    reconocimientoVoz.onerror = (evento) => console.error('Error de reconocimiento de voz', evento.error);
                } else { elementos.botonGrabar.disabled = true; }
            };
            
            const alternarGrabacion = () => { if (!reconocimientoVoz) return; estaGrabando ? reconocimientoVoz.stop() : reconocimientoVoz.start(); };
            
            const iniciarSintesisVoz = () => {
                const popularVoces = () => {
                    const voces = speechSynthesis.getVoices().filter(v => v.lang.startsWith('es'));
                    elementos.selectorVoz.innerHTML = voces.map(v => `<option value="${v.name}">${v.name} (${v.lang})</option>`).join('');
                };
                popularVoces();
                if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = popularVoces;
            };
            
            const leerTexto = (texto, boton) => {
                if (sintesisVozActual && speechSynthesis.speaking) { detenerVoz(); return; }
                detenerVoz();
                sintesisVozActual = new SpeechSynthesisUtterance(texto);
                const nombreVozSeleccionada = elementos.selectorVoz.value;
                const voz = speechSynthesis.getVoices().find(v => v.name === nombreVozSeleccionada);
                if (voz) sintesisVozActual.voice = voz;
                sintesisVozActual.onstart = () => { document.querySelectorAll('.boton-voz').forEach(btn => btn.innerHTML = '<i class="fas fa-volume-up"></i>'); if(boton) boton.innerHTML = '<i class="fas fa-stop"></i>'; };
                sintesisVozActual.onend = () => { if(boton) boton.innerHTML = '<i class="fas fa-volume-up"></i>'; sintesisVozActual = null; };
                speechSynthesis.speak(sintesisVozActual);
            };
            
            const detenerVoz = () => {
                if (speechSynthesis.speaking) speechSynthesis.cancel();
                document.querySelectorAll('.boton-voz').forEach(btn => btn.innerHTML = '<i class="fas fa-volume-up"></i>');
                sintesisVozActual = null;
            };

            const gestionarFocoInput = () => {
                setTimeout(() => {
                    elementos.entradaWrapper.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }, 300);
            };

            const autoAjustarTextarea = () => { 
                const ta = elementos.entradaUsuario; 
                ta.style.height = 'auto'; 
                ta.style.height = `${ta.scrollHeight}px`; 
            };
            
            const gestionarScrollUsuario = () => {
                const contenedor = elementos.contenedorChat;
                const umbral = 50;
                const estaAlFinal = (contenedor.scrollHeight - contenedor.scrollTop - contenedor.clientHeight) < umbral;
                if (estaAlFinal) {
                    scrollAutomatico = true;
                    elementos.botonScrollFinal.classList.remove('visible');
                } else {
                    scrollAutomatico = false;
                    elementos.botonScrollFinal.classList.add('visible');
                }
            };
            
            const irAlFinal = (forzar = false) => { 
                if (scrollAutomatico || forzar) {
                    elementos.contenedorChat.scrollTop = elementos.contenedorChat.scrollHeight; 
                }
            };
            
            const alternarTema = () => { 
                elementos.body.classList.toggle('tema-claro'); 
                const esClaro = elementos.body.classList.contains('tema-claro'); 
                localStorage.setItem('theme', esClaro ? 'claro' : 'oscuro'); 
                const iconoTema = document.querySelector('#menu-tema i');
                if(iconoTema) iconoTema.className = `fas ${esClaro ? 'fa-moon' : 'fa-sun'}`;
            };
            
            const alternarModal = (mostrar, modal) => { 
                modal.style.display = mostrar ? 'flex' : 'none'; 
                const esAlgunModalActivo = elementos.modalOcr.style.display === 'flex' || 
                                          elementos.modalModo.style.display === 'flex' ||
                                          elementos.modalSuperIA.style.display === 'flex' ||
                                          elementos.modalAyuda.style.display === 'flex' ||
                                          elementos.modalImagen.style.display === 'flex' ||
                                          elementos.modalMenuPrincipal.style.display === 'flex';
                elementos.overlay.style.display = esAlgunModalActivo ? 'block' : 'none';
                if (modal === elementos.modalOcr) {
                    elementos.botonMas.classList.toggle('modo-activo', mostrar);
                }
            };
            
            const copiarAlPortapapeles = (texto) => { 
                navigator.clipboard.writeText(texto).then(() => { 
                    elementos.confirmacionCopia.classList.add('show'); 
                    setTimeout(() => elementos.confirmacionCopia.classList.remove('show'), 2000); 
                }); 
            };
            
            const alternarModoBusqueda = (forzarEstado) => { 
                modoBusqueda = typeof forzarEstado === 'boolean' ? forzarEstado : !modoBusqueda; 
                elementos.botonBuscar.classList.toggle('modo-activo', modoBusqueda); 
                elementos.botonBuscar.title = modoBusqueda ? 'Modo búsqueda activo' : 'Buscar en internet'; 
            };
            
            const establecerModoIA = (modo) => { 
                modoSuperIA = modo === 'super'; 
                modoMiniIA = modo === 'mini';
                elementos.tituloModo.textContent = modoSuperIA ? 'SUPER MAR-IA' : (modoMiniIA ? 'Mar-IA mini' : 'Mar-IA'); 
                elementos.tituloModo.classList.toggle('super-ia-gradient', modoSuperIA); 
                elementos.tituloModo.classList.toggle('mini-ia-gradient', modoMiniIA); 
                if(elementos.modalModo.style.display === 'flex') alternarModal(false, elementos.modalModo); 
                localStorage.setItem('modoIA', modo); 
                if (modoSuperIA && !localStorage.getItem('superIaModalVisto')) {
                     alternarModal(true, elementos.modalSuperIA);
                     localStorage.setItem('superIaModalVisto', 'true');
                }
                if (modo === 'mini') {
                    const modalAviso = elementos.modalMiniAviso;
                    modalAviso.style.animation = 'none';
                    modalAviso.offsetHeight; 
                    modalAviso.style.animation = 'slideDownFadeIn 0.5s ease-out forwards';
                    modalAviso.style.display = 'flex';
                    setTimeout(() => {
                        modalAviso.style.animation = 'slideUpFadeOut 0.5s ease-out forwards';
                        setTimeout(() => { modalAviso.style.display = 'none'; }, 500);
                    }, 8000);
                }
            };
            
            const cargarEstado = () => { 
                if (localStorage.getItem('theme') === 'claro') { 
                    elementos.body.classList.add('tema-claro'); 
                    const iconoTema = document.querySelector('#menu-tema i');
                    if(iconoTema) iconoTema.className = 'fas fa-moon';
                } 
                establecerModoIA(localStorage.getItem('modoIA') || 'normal'); 
            };
            
            const mostrarIndicador = (texto, tipoIcono = 'dots') => { 
                ocultarIndicador(); 
                const indicador = document.createElement('div'); 
                indicador.id = 'dynamic-indicator'; 
                indicador.className = 'indicador-escribiendo'; 
                let htmlIcono;
                if (tipoIcono === 'brain') {
                    htmlIcono = '<i class="fas fa-brain fa-beat"></i>';
                } else if (tipoIcono === 'bolt') {
                    htmlIcono = '<i class="fas fa-bolt fa-beat"></i>';
                } else {
                    htmlIcono = '<div class="puntos"><span></span><span></span><span></span></div>';
                }
                indicador.innerHTML = `${htmlIcono} <span>${texto}</span>`; 
                elementos.contenedorChat.appendChild(indicador); 
                irAlFinal(); 
            };
            
            const ocultarIndicador = () => { 
                const indicador = document.getElementById('dynamic-indicator'); 
                if (indicador) indicador.remove(); 
            };
            
            const mostrarIndicadorBusqueda = () => {
                const divMensaje = document.createElement('div');
                divMensaje.id = 'indicador-busqueda';
                divMensaje.className = 'mensaje mensaje-busqueda';
                divMensaje.innerHTML = `
                    <div class="burbuja-busqueda">
                        <i class="fas fa-search"></i>
                        <span>Buscando en la web...</span>
                    </div>`;
                elementos.contenedorChat.appendChild(divMensaje);
                irAlFinal();
                return divMensaje;
            };

            const ocultarIndicadorBusqueda = (indicador) => {
                if (indicador) {
                    indicador.style.transition = 'opacity 0.3s ease';
                    indicador.style.opacity = '0';
                    setTimeout(() => indicador.remove(), 300);
                }
            };

            const realizarBusquedaWeb = async (consulta) => {
                try {
                    const respuesta = await fetch(`https://s.jina.ai/${encodeURIComponent(consulta)}`, {
                        headers: {
                            "Accept": "application/json"
                        }
                    });
                    if (!respuesta.ok) throw new Error('Jina API falló');
                    const textoResultados = await respuesta.text();
                    const primerResultado = textoResultados.split('\n')[0];
                    const datos = JSON.parse(primerResultado);
                    if (datos && datos.data && datos.data.content) {
                         return `**Fuente: ${datos.data.title}**\n${datos.data.content}`;
                    }
                    throw new Error('Sin contenido de Jina');
                } catch (error) {
                    console.warn("Búsqueda principal (Jina) falló, intentando alternativa:", error);
                    try {
                        const respuesta = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(`https://api.duckduckgo.com/?q=${consulta}&format=json&no_html=1`)}`);
                        const datos = await respuesta.json();
                        const resultados = JSON.parse(datos.contents);
                        if (!resultados || !resultados.AbstractText) return "No se encontraron resultados relevantes.";
                        let formato = `**Fuente: ${resultados.AbstractSource}**\n${resultados.AbstractText}\n\n`;
                        if (resultados.RelatedTopics?.length > 0) {
                            formato += "**Tópicos Relacionados:**\n";
                            resultados.RelatedTopics.slice(0, 3).forEach(topico => {
                                if (topico.Text) formato += `• ${topico.Text}\n`;
                            });
                        }
                        return formato;
                    } catch (errorAlternativo) {
                        console.error("La búsqueda alternativa (DuckDuckGo) también falló:", errorAlternativo);
                        return "Lo siento, no pude realizar la búsqueda en internet en este momento.";
                    }
                }
            };
            
            const mostrarBotonCargando = () => {
                elementos.botonEnviar.classList.add('cargando');
                elementos.botonEnviar.disabled = true;
                elementos.botonEnviar.innerHTML = '<div class="loader-dots"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></div>';
            };

            const cambiarBotonAPausa = () => {
                estaGenerandoRespuesta = true;
                elementos.botonEnviar.classList.remove('cargando');
                elementos.botonEnviar.disabled = false;
                elementos.botonEnviar.innerHTML = '<i class="fas fa-pause"></i>';
                elementos.botonEnviar.classList.add('pausa');
                elementos.botonEnviar.title = 'Pausar generación';
            };
            
            const restaurarBotonEnviar = () => {
                estaGenerandoRespuesta = false;
                elementos.botonEnviar.innerHTML = '<i class="fas fa-paper-plane"></i>';
                elementos.botonEnviar.classList.remove('pausa');
                elementos.botonEnviar.classList.remove('cargando');
                elementos.botonEnviar.disabled = false;
                elementos.botonEnviar.title = 'Enviar mensaje';
            };
            
            const pausarGeneracion = () => {
                cancelarProcesoCompleto = true;
                if (cancelarStreaming) {
                    cancelarStreaming();
                }
                restaurarBotonEnviar();
            };

            const obtenerRespuestaBot = async (historialActual, debeHablar) => {
                const payload = { 
                    model: "deepseek-chat",
                    messages: historialActual, 
                    stream: true,
                    temperature: 0.7,
                    top_p: 0.9,
                    max_tokens: 2000
                };
                const apiConfig = { url: 'https://api.deepseek.com/v1/chat/completions', key: CLAVE_API_DEEPSEEK };
                await streamContent(payload, apiConfig, debeHablar, 'Mar-IA está escribiendo...', 'dots');
            };

            const obtenerRespuestaMini = async (mensajes, debeHablar) => {
                const payload = { 
                    model: "llama3-8b-8192",
                    messages: mensajes, 
                    stream: true, 
                    max_tokens: 800,
                    temperature: 0.8,
                    top_p: 0.95
                };
                const apiConfig = { url: 'https://api.groq.com/openai/v1/chat/completions', key: CLAVE_API_GROQ };
                await streamContent(payload, apiConfig, debeHablar, 'Mar-IA mini está escribiendo...', 'bolt');
            };

            const ejecutarFlujoSuperIA = async (historialActual, debeHablar) => {
                const { contenidoPensamiento } = crearContenedorPensamiento();
                const apiConfigDeepSeek = { url: 'https://api.deepseek.com/v1/chat/completions', key: CLAVE_API_DEEPSEEK };
                
                const historialRazonamiento = [...historialActual];
                historialRazonamiento[historialRazonamiento.length - 1].content = 
                    `Piensa paso a paso y razona en profundidad sobre: "${historialRazonamiento[historialRazonamiento.length - 1].content}". Genera una respuesta completa.`;

                const payloadRazonamiento = { 
                    model: "deepseek-reasoner",
                    messages: historialRazonamiento, 
                    stream: true,
                    temperature: 0.3,
                    max_tokens: 4000
                };
                
                const payloadRespuestaRapida = {
                    model: "deepseek-chat",
                    messages: [{role: "user", content: "Responde brevemente que estás procesando la solicitud con tu modo de razonamiento avanzado. Máximo 10 palabras."}],
                    stream: true,
                    max_tokens: 50
                };
                
                await streamContent(payloadRespuestaRapida, apiConfigDeepSeek, false, 'SUPER MAR-IA está razonando...', 'brain');
                
                const razonamientoCompleto = await streamContent(payloadRazonamiento, apiConfigDeepSeek, false, '', '', contenidoPensamiento, true);
                
                if (cancelarProcesoCompleto || !razonamientoCompleto) { 
                    restaurarBotonEnviar(); 
                    return; 
                }

                const historialFinal = [
                    ...historialActual, 
                    { role: "assistant", content: razonamientoCompleto }, 
                    { role: "user", content: "Basándote en tu razonamiento, genera una respuesta final clara, concisa y bien estructurada para el usuario." } 
                ];

                const payloadFinal = { 
                    model: "deepseek-reasoner",
                    messages: historialFinal, 
                    stream: true,
                    max_tokens: 2000,
                    temperature: 0.7
                };

                await streamContent(payloadFinal, apiConfigDeepSeek, debeHablar, 'Finalizando respuesta...', 'brain');
            };

            const streamContent = async (payload, apiConfig, debeHablar, textoIndicador, iconoIndicador, elementoTarget = null, esPensamiento = false) => {
                cambiarBotonAPausa();
                if (textoIndicador) mostrarIndicador(textoIndicador, iconoIndicador);
                
                let respuestaCompleta = "";
                let elementoMensaje;

                if (elementoTarget) {
                    elementoMensaje = elementoTarget;
                } else {
                    const mensajeContenedor = agregarMensaje('bot', '', true);
                    elementoMensaje = mensajeContenedor.querySelector('.burbuja-mensaje');
                }
                
                ocultarIndicador();

                try {
                    const respuesta = await fetch(apiConfig.url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiConfig.key}` },
                        body: JSON.stringify(payload)
                    });

                    if (!respuesta.ok) throw new Error(`Error de API: ${respuesta.status}`);
                    
                    const lector = respuesta.body.getReader();
                    const decodificador = new TextDecoder();
                    let aborted = false;
                    cancelarStreaming = () => { lector.cancel(); aborted = true; };

                    while (true) {
                        const { value, done } = await lector.read();
                        if (done || aborted) break;
                        
                        const chunk = decodificador.decode(value, { stream: true });
                        const lineas = chunk.split('\n');

                        for (const linea of lineas) {
                            if (linea.startsWith('data: ')) {
                                const datos = linea.substring(6);
                                if (datos.trim() === '[DONE]') continue;
                                try {
                                    const jsonData = JSON.parse(datos);
                                    const token = jsonData.choices[0]?.delta?.content || '';
                                    if (token) {
                                        respuestaCompleta += token;
                                        elementoMensaje.innerHTML = marked.parse(respuestaCompleta);
                                        irAlFinal();
                                    }
                                } catch (e) { /* Ignorar errores de parseo de JSON en chunks incompletos */ }
                            }
                        }
                    }

                    formatearBloquesCodigo(elementoMensaje.parentElement);

                    if (!aborted && !esPensamiento) {
                        if (respuestaCompleta.includes('[Imagen generada]')) {
                            const descImagen = respuestaCompleta.match(/\[Imagen generada\] (.*)/)[1];
                            elementoMensaje.innerHTML = `<div class="contenedor-imagen-generada"><img src="${imagenGeneradaActual}" alt="${descImagen}" style="max-width: 100%; border-radius: 1.5rem; cursor: zoom-in;"></div>`;
                        }
                        historialChat.push({ role: "assistant", content: respuestaCompleta });
                        guardarMensajeEnHistorial('assistant', respuestaCompleta);
                    }

                    if (debeHablar && !aborted) {
                        leerTexto(elementoMensaje.innerText, elementoMensaje.closest('.mensaje')?.querySelector('.boton-voz'));
                    }

                    return respuestaCompleta;

                } catch (error) {
                    if (error.name !== 'AbortError') {
                        elementoMensaje.innerHTML = "Lo siento, ocurrió un error al conectar con el servidor.";
                         if (!esPensamiento) {
                            guardarMensajeEnHistorial('assistant', "Lo siento, ocurrió un error al conectar con el servidor.");
                         }
                    }
                    return null;
                } finally {
                    if (!esPensamiento) {
                        restaurarBotonEnviar();
                    }
                }
            };
                

            iniciar();
        });
        
        // Mostrar la modal
      function abrirLiveModal() {
        document.getElementById("liveModal").classList.remove("oculto");
      }
    
      // Cerrar la modal
      document.getElementById("cerrarLiveModal").addEventListener("click", () => {
        document.getElementById("liveModal").classList.add("oculto");
      });
    
      // Opcional: cerrar haciendo clic fuera del contenido
      document.getElementById("liveModal").addEventListener("click", (e) => {
        if (e.target.id === "liveModal") {
          document.getElementById("liveModal").classList.add("oculto");
        }
  });
       
    </script>
</body>
</html>
